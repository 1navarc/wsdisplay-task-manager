<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSDisplay AI Analytics Tracker v11</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #ffffff;
            --bg-page: #f5f7fa;
            --bg-subtle: #f8fafc;
            --bg-muted: #eef2f6;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --text: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --accent-light: #eff6ff;
            --accent-border: #bfdbfe;
            --success: #10b981;
            --success-light: #ecfdf5;
            --success-border: #a7f3d0;
            --warning: #f59e0b;
            --warning-light: #fffbeb;
            --warning-border: #fcd34d;
            --danger: #ef4444;
            --danger-light: #fef2f2;
            --danger-border: #fecaca;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.08);
            --radius: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        /* ═══════════════════════════════════════
           LOGIN SCREEN
        ═══════════════════════════════════════ */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 48px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.8rem;
            margin: 0 auto 24px;
        }

        .login-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 14px 24px;
            background: white;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .google-btn:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .google-btn svg {
            width: 20px;
            height: 20px;
        }

        .login-error {
            background: var(--danger-light);
            border: 1px solid var(--danger-border);
            color: var(--danger);
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-top: 16px;
            font-size: 0.9rem;
        }

        .login-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 40px;
        }

        /* Role Badges */
        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .role-badge.admin {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .role-badge.manager {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .role-badge.employee {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .role-badge.viewer {
            background: var(--bg-muted);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--bg);
            border-radius: var(--radius);
            border: 1px solid var(--border-light);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-subtle);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .filter-toggle:hover {
            background: var(--bg-muted);
        }

        .filter-toggle.active {
            background: var(--accent-light);
            border-color: var(--accent-border);
            color: var(--accent);
        }

        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 6px 12px;
            background: var(--bg-subtle);
            border-radius: 20px;
        }

        .sync-status.syncing { color: var(--warning); }
        .sync-status.synced { color: var(--success); }
        .sync-status.offline { color: var(--danger); }

        /* User Menu */
        .user-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 8px;
            margin-bottom: 8px;
            display: none;
            z-index: 100;
        }

        .user-menu.show { display: block; }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .user-menu-item:hover {
            background: var(--bg-subtle);
            color: var(--text);
        }

        .user-menu-item.danger { color: var(--danger); }
        .user-menu-item.danger:hover { background: var(--danger-light); }

        /* Admin Section */
        .admin-section {
            background: var(--bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            padding: 24px;
            margin-bottom: 24px;
        }

        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .admin-section-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
        }

        .user-table th, .user-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .user-table th {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .user-table tr:hover { background: var(--bg-subtle); }

        .user-table-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-table-avatar-placeholder {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--text-muted); }

        .hidden { display: none !important; }
        .viewer-hidden { display: none !important; }
        .admin-only { }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
            background: var(--bg-page);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            font-size: 16px;
        }

        /* ═══════════════════════════════════════
           SIDEBAR NAVIGATION
        ═══════════════════════════════════════ */
        .app-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: var(--bg);
            border-right: 1px solid var(--border);
            padding: 28px 20px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-light);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.02em;
        }

        .logo-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Navigation */
        .nav-section {
            margin-bottom: 28px;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 0 12px;
            margin-bottom: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--bg-subtle);
            color: var(--text);
        }

        .nav-item.active {
            background: var(--accent-light);
            color: var(--accent);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 1.3rem;
            width: 28px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 24px;
            text-align: center;
        }

        /* User Profile in Sidebar */
        .sidebar-footer {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .user-card:hover {
            background: var(--bg-muted);
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text);
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* ═══════════════════════════════════════
           MAIN CONTENT
        ═══════════════════════════════════════ */
        .main-content {
            padding: 36px 48px;
            max-width: 1400px;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 36px;
            gap: 24px;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.02em;
            margin-bottom: 6px;
        }

        .page-subtitle {
            font-size: 1.05rem;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* ═══════════════════════════════════════
           BUTTONS - BIGGER & CLEANER
        ═══════════════════════════════════════ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 24px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: var(--bg);
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--bg-muted);
            color: var(--text);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-sm {
            padding: 10px 18px;
            font-size: 0.9rem;
        }

        .btn-lg {
            padding: 18px 32px;
            font-size: 1.1rem;
            border-radius: var(--radius-lg);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .btn-success:hover {
            background: #059669;
            border-color: #059669;
            color: white;
        }

        .btn-danger {
            background: var(--danger-light);
            color: var(--danger);
            border-color: var(--danger-border);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .btn-icon {
            padding: 12px;
            min-width: 48px;
        }

        /* ═══════════════════════════════════════
           PROGRESS CARDS - CLEANER
        ═══════════════════════════════════════ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 16px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-sm);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
            margin-bottom: 6px;
        }

        .stat-progress {
            height: 4px;
            background: var(--bg-muted);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .stat-progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .stat-progress-fill.primary { background: var(--accent); }
        .stat-progress-fill.success { background: var(--success); }
        .stat-progress-fill.warning { background: var(--warning); }
        .stat-progress-fill.danger { background: var(--danger); }

        .stat-detail {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ═══════════════════════════════════════
           QUICK ACTIONS BAR
        ═══════════════════════════════════════ */
        .quick-actions {
            display: flex;
            gap: 16px;
            padding: 24px 28px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 32px;
            align-items: center;
            flex-wrap: wrap;
        }

        .quick-actions-label {
            font-weight: 700;
            color: var(--text);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-actions-divider {
            width: 1px;
            height: 32px;
            background: var(--border);
        }

        .quick-input-group {
            display: flex;
            gap: 12px;
            flex: 1;
            min-width: 300px;
        }

        .input {
            padding: 14px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.15s ease;
            background: var(--bg);
            color: var(--text);
        }

        .input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .input::placeholder {
            color: var(--text-muted);
        }

        .input-flex {
            flex: 1;
            min-width: 200px;
        }

        .select {
            padding: 14px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg);
            color: var(--text-secondary);
            cursor: pointer;
            min-width: 180px;
        }

        .select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* ═══════════════════════════════════════
           SEARCH & FILTER BAR
        ═══════════════════════════════════════ */
        .filter-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 28px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 280px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        .search-input {
            width: 100%;
            padding: 14px 18px 14px 48px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg);
            transition: all 0.15s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .filter-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .chip:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .chip.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* ═══════════════════════════════════════
           VIEW TOGGLE
        ═══════════════════════════════════════ */
        .view-toggle {
            display: flex;
            background: var(--bg-muted);
            border-radius: var(--radius);
            padding: 4px;
        }

        .view-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.15s ease;
            font-family: inherit;
        }

        .view-btn.active {
            background: var(--bg);
            color: var(--text);
            box-shadow: var(--shadow-sm);
        }

        /* ═══════════════════════════════════════
           PHASE SECTIONS
        ═══════════════════════════════════════ */
        .phase-section {
            margin-bottom: 48px;
        }

        .phase-header {
            display: flex;
            align-items: center;
            gap: 18px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-light);
        }

        .phase-icon {
            width: 56px;
            height: 56px;
            background: var(--accent-light);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
        }

        .phase-info h2 {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 4px;
        }

        .phase-meta {
            display: flex;
            gap: 20px;
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .phase-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .phase-actions {
            margin-left: auto;
        }

        /* ═══════════════════════════════════════
           PROJECT CARDS - BIGGER & CLEANER
        ═══════════════════════════════════════ */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 20px;
        }

        .project-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 28px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .project-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--accent-border);
            transform: translateY(-2px);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 18px;
        }

        .project-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1.3;
        }

        .priority-badge {
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            flex-shrink: 0;
        }

        .priority-critical { background: var(--danger-light); color: var(--danger); }
        .priority-high { background: var(--warning-light); color: var(--warning); }
        .priority-medium { background: var(--accent-light); color: var(--accent); }
        .priority-low { background: var(--bg-muted); color: var(--text-muted); }

        .project-owner {
            font-size: 0.95rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-meta-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        .project-progress {
            margin-bottom: 16px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .progress-label {
            color: var(--text-muted);
            font-weight: 500;
        }

        .progress-value {
            color: var(--text);
            font-weight: 700;
        }

        .progress-bar {
            height: 10px;
            background: var(--bg-muted);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 5px;
            transition: width 0.4s ease;
        }

        .project-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 18px;
            border-top: 1px solid var(--border-light);
        }

        .project-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .project-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ═══════════════════════════════════════
           PROJECT DETAIL MODAL - CLEANER
        ═══════════════════════════════════════ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        /* Full-screen task detail modal */
        .modal.fullscreen-modal {
            max-width: 95vw;
            max-height: 95vh;
            width: 95vw;
            height: 95vh;
        }

        .modal.fullscreen-modal .modal-body {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 24px;
            padding: 24px 32px;
        }

        @media (max-width: 1200px) {
            .modal.fullscreen-modal .modal-body {
                grid-template-columns: 1fr;
            }
        }

        .modal-header {
            padding: 28px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
        }

        .modal-title {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 8px;
        }

        .modal-description {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .modal-close {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-subtle);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.5rem;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .modal-body {
            padding: 28px 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px 32px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* ═══════════════════════════════════════
           TASK ITEMS - BIGGER & TOUCH-FRIENDLY
        ═══════════════════════════════════════ */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 18px 20px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            transition: all 0.15s ease;
        }

        .task-item:hover {
            background: var(--bg-muted);
        }

        .task-item.completed {
            background: var(--success-light);
        }

        .task-checkbox {
            width: 28px;
            height: 28px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s ease;
            font-size: 1rem;
        }

        .task-checkbox:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-name {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }

        .task-item.completed .task-name {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .task-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .task-badge {
            padding: 6px 12px;
            background: var(--bg);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .task-badge.overdue {
            background: var(--danger-light);
            border-color: var(--danger-border);
            color: var(--danger);
        }

        .task-badge.due-soon {
            background: var(--warning-light);
            border-color: var(--warning-border);
            color: var(--warning);
        }

        .dept-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .dept-badge.inherited {
            opacity: 0.75;
            font-style: italic;
        }

        .dept-select {
            padding: 6px 12px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 0.85rem;
            font-family: inherit;
            background: var(--bg);
            color: var(--text-secondary);
            cursor: pointer;
            min-width: 140px;
        }

        .dept-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .owner-select {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            min-width: 160px;
            font-weight: 500;
        }

        .owner-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .date-input {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            min-width: 150px;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        /* Department Filter Dropdown */
        .dept-filters {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .dept-filter-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .dept-dropdown {
            padding: 8px 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            min-width: 180px;
        }

        .dept-dropdown:focus {
            outline: none;
            border-color: var(--accent);
        }

        .task-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .task-action-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.1rem;
            transition: all 0.15s ease;
        }

        .task-action-btn:hover {
            background: var(--bg-muted);
            color: var(--text);
            border-color: var(--border);
        }

        .task-action-btn.danger:hover {
            background: var(--danger-light);
            color: var(--danger);
            border-color: var(--danger-border);
        }

        /* How To Button */
        .how-to-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 6px;
            color: #92400e;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .how-to-btn:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        /* How To Instructions Styling */
        .how-to-instructions {
            line-height: 1.7;
            color: var(--text);
        }

        .how-to-paragraph {
            margin-bottom: 16px;
        }

        .how-to-step {
            display: flex;
            gap: 14px;
            padding: 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            margin-bottom: 12px;
            align-items: flex-start;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .how-to-tips {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border: 1px solid #fcd34d;
            border-radius: var(--radius);
            padding: 16px;
            margin: 20px 0;
        }

        .tips-header {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .how-to-time {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border: 1px solid #93c5fd;
            border-radius: var(--radius);
            padding: 16px;
            margin: 20px 0;
        }

        .time-header {
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .how-to-bullet {
            padding: 4px 0 4px 16px;
            color: var(--text-secondary);
        }

        .how-to-meta {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Resources Section Styling */
        .resources-section {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 1px solid #86efac;
            border-radius: var(--radius);
        }

        .resources-header {
            font-weight: 700;
            color: #166534;
            font-size: 1.1rem;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #bbf7d0;
        }

        .resource-category {
            margin-bottom: 16px;
        }

        .resource-category:last-child {
            margin-bottom: 0;
        }

        .resource-category-icon {
            display: inline-block;
            margin-right: 4px;
        }

        .resource-category > strong {
            color: var(--text);
            font-size: 0.95rem;
        }

        .resource-item {
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            margin-top: 8px;
            border: 1px solid var(--border-light);
            transition: all 0.15s ease;
        }

        .resource-item:hover {
            border-color: var(--accent-border);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .resource-item a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
            display: block;
        }

        .resource-item a:hover {
            text-decoration: underline;
        }

        .resource-desc {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.4;
        }

        /* ═══════════════════════════════════════
           ENHANCED TASK RESEARCH PANEL
        ═══════════════════════════════════════ */
        .task-detail-left {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .task-detail-right {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            border-left: 1px solid var(--border);
            padding-left: 24px;
        }

        @media (max-width: 1200px) {
            .task-detail-right {
                border-left: none;
                border-top: 1px solid var(--border);
                padding-left: 0;
                padding-top: 24px;
            }
        }

        .research-panel {
            background: var(--bg);
            border-radius: var(--radius);
        }

        .research-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .research-header h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .research-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .research-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .research-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .research-btn.researching {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }

        /* Research Status Badge */
        .research-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .research-status.pending {
            background: var(--bg-muted);
            color: var(--text-muted);
        }

        .research-status.complete {
            background: var(--success-light);
            color: var(--success);
        }

        /* Comparison Grid */
        .comparison-grid {
            margin: 16px 0;
            overflow-x: auto;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .comparison-table th {
            background: var(--bg-muted);
            padding: 12px 14px;
            text-align: left;
            font-weight: 700;
            color: var(--text);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        .comparison-table td {
            padding: 14px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: top;
        }

        .comparison-table tr:hover td {
            background: var(--bg-subtle);
        }

        .comparison-table .product-name {
            font-weight: 600;
            color: var(--text);
        }

        .comparison-table .product-link {
            display: inline-block;
            margin-top: 4px;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.85rem;
        }

        .comparison-table .product-link:hover {
            text-decoration: underline;
        }

        .comparison-table .price {
            font-weight: 700;
            color: var(--success);
            font-size: 1rem;
        }

        .comparison-table .price-tier {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: block;
        }

        .feature-check {
            color: var(--success);
            font-weight: bold;
        }

        .feature-x {
            color: var(--text-muted);
        }

        .pros-cons {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.85rem;
        }

        .pro-item {
            color: var(--success);
        }

        .con-item {
            color: var(--danger);
        }

        /* Resource Sections */
        .research-section {
            margin-bottom: 24px;
            padding: 20px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            border: 1px solid var(--border-light);
        }

        .research-section h4 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .research-section.products {
            background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%);
            border-color: var(--accent-border);
        }

        .research-section.implementation {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border-color: #86efac;
        }

        .research-section.vendor-questions {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border-color: #fcd34d;
        }

        .research-section.internal {
            background: linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);
            border-color: #f9a8d4;
        }

        .research-section.videos {
            background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
            border-color: #fecaca;
        }

        .vendor-template {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
            color: var(--text-secondary);
        }

        .copy-btn:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .question-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .question-list li {
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .question-list li::before {
            content: "❓";
            flex-shrink: 0;
        }

        .internal-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .internal-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }

        .internal-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .internal-item-icon.hr { background: #fce7f3; }
        .internal-item-icon.it { background: #dbeafe; }
        .internal-item-icon.finance { background: #d1fae5; }
        .internal-item-icon.facilities { background: #fef3c7; }
        .internal-item-icon.legal { background: #e0e7ff; }

        .internal-item-content h5 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .internal-item-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }

        .video-card {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 14px;
            transition: all 0.15s ease;
        }

        .video-card:hover {
            border-color: var(--accent-border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .video-card a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .video-card a:hover {
            text-decoration: underline;
        }

        .video-card p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 6px 0 0 0;
        }

        /* Empty research state */
        .research-empty {
            text-align: center;
            padding: 60px 30px;
            color: var(--text-muted);
        }

        .research-empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .research-empty h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .research-empty p {
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .how-to-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 12px;
        }

        .how-to-tab {
            padding: 8px 16px;
            border: none;
            background: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.15s ease;
        }

        .how-to-tab:hover {
            background: var(--bg-muted);
            color: var(--text);
        }

        .how-to-tab.active {
            background: var(--accent-light);
            color: var(--accent);
        }

        .how-to-tab-content {
            min-height: 300px;
        }

        .how-to-edit-area {
            width: 100%;
            min-height: 350px;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
        }

        /* New Project Tasks List */
        .new-project-tasks-list {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 12px;
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg-subtle);
        }

        .no-tasks-message {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .new-task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--bg);
            border-radius: var(--radius);
            margin-bottom: 8px;
        }

        .new-task-item:last-child {
            margin-bottom: 0;
        }

        .new-task-number {
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .new-task-name {
            flex: 1;
            font-size: 0.95rem;
            color: var(--text);
        }

        .add-task-row {
            display: flex;
            gap: 10px;
        }

        .add-task-row .input {
            flex: 1;
        }

        /* AI Generate Section */
        .ai-generate-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--border-light);
            text-align: center;
        }

        .ai-generate-section-top {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
        }

        .ai-wizard-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 16px;
            text-align: left;
        }

        /* AI Chat Section */
        .ai-chat-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .ai-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-weight: 700;
        }

        .ai-chat-header .btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            font-size: 0.75rem;
        }

        .ai-chat-header .btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .ai-chat-messages {
            padding: 16px;
            max-height: 250px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: white;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            background: var(--bg-muted);
        }

        .chat-message.user .chat-avatar {
            background: var(--accent);
            color: white;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .chat-message.user .chat-bubble {
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.ai .chat-bubble {
            background: var(--bg-subtle);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }

        .chat-message.ai .chat-bubble.typing {
            display: flex;
            gap: 4px;
            padding: 14px 18px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        .ai-chat-input {
            padding: 12px 16px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-subtle);
        }

        .ai-chat-input textarea {
            resize: none;
            font-size: 0.95rem;
        }

        .ai-chat-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .chat-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .chat-buttons {
            display: flex;
            gap: 8px;
        }

        .ai-generate-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .ai-generate-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .ai-generate-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .ai-wizard-option {
            margin-bottom: 12px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Wizard Modal */
        .wizard-modal {
            max-width: 500px;
        }

        .wizard-progress {
            height: 6px;
            background: var(--bg-muted);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .wizard-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, #8b5cf6 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .wizard-question-number {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .wizard-question {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 24px;
        }

        .wizard-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .wizard-option {
            padding: 16px 20px;
            background: var(--bg-subtle);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
        }

        .wizard-option:hover {
            background: var(--bg-muted);
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .wizard-option.selected {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
        }

        .new-task-howto {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--bg-muted);
        }

        .new-task-howto.ready {
            background: var(--success-light);
            color: var(--success);
        }

        /* How To Generate Box */
        .how-to-generate-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border: 1px solid #fcd34d;
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
        }

        .how-to-generate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 700;
            color: #92400e;
        }

        .how-to-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 12px;
            background: #fef3c7;
            color: #92400e;
        }

        .how-to-status.complete {
            background: var(--success-light);
            color: var(--success);
        }

        .how-to-status.partial {
            background: #dbeafe;
            color: #1e40af;
        }

        .how-to-generate-box p {
            font-size: 0.85rem;
            color: #78350f;
            margin-bottom: 12px;
        }

        /* Issues View */
        .issues-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
        }

        .issue-stat {
            padding: 20px 30px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .issue-stat.open {
            border-left: 4px solid var(--warning);
        }

        .issue-stat.closed {
            border-left: 4px solid var(--success);
        }

        .issue-stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
        }

        .issue-stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .issues-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .issue-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .issue-card.closed {
            opacity: 0.7;
        }

        .issue-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .issue-type {
            font-size: 1.2rem;
        }

        .issue-title {
            flex: 1;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text);
        }

        .issue-priority {
            font-size: 1.1rem;
        }

        .issue-card-meta {
            display: flex;
            gap: 16px;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .issue-status-badge {
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .issue-status-badge.open {
            background: var(--warning-light);
            color: var(--warning);
        }

        .issue-status-badge.closed {
            background: var(--success-light);
            color: var(--success);
        }

        .issue-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            padding: 12px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            margin-bottom: 12px;
        }

        .issue-actions {
            display: flex;
            gap: 10px;
        }

        /* ═══════════════════════════════════════
           AI ASSISTANT PANEL
        ═══════════════════════════════════════ */
        .ai-panel {
            background: linear-gradient(135deg, var(--accent-light) 0%, #ede9fe 100%);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-top: 20px;
        }

        .ai-panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ai-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.4rem;
        }

        .ai-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }

        .ai-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .ai-input-row {
            display: flex;
            gap: 12px;
        }

        .ai-input {
            flex: 1;
            padding: 16px 20px;
            border: 1px solid var(--accent-border);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg);
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        }

        .ai-response {
            margin-top: 16px;
            padding: 20px;
            background: var(--bg);
            border-radius: var(--radius);
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════
           KEYBOARD SHORTCUTS PANEL
        ═══════════════════════════════════════ */
        .shortcuts-panel {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px 24px;
            box-shadow: var(--shadow-lg);
            display: none;
            z-index: 100;
            min-width: 280px;
        }

        .shortcuts-panel.active {
            display: block;
        }

        .shortcuts-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text);
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .shortcut-key {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .shortcut-key kbd {
            padding: 4px 10px;
            background: var(--bg-muted);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* ═══════════════════════════════════════
           FLOATING ACTION BUTTON
        ═══════════════════════════════════════ */
        .fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(59, 130, 246, 0.5);
        }

        /* ═══════════════════════════════════════
           TOAST NOTIFICATIONS
        ═══════════════════════════════════════ */
        .toast {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: white;
            padding: 16px 28px;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: var(--danger);
        }

        /* ═══════════════════════════════════════
           CALENDAR VIEW
        ═══════════════════════════════════════ */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 20px 24px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendar-current-label {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            min-width: 220px;
            text-align: center;
        }

        .calendar-content {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .calendar-empty {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-muted);
        }

        .calendar-empty span {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 12px;
        }

        /* Day View */
        .day-view {
            padding: 0;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            background: var(--bg-subtle);
            border-bottom: 1px solid var(--border-light);
        }

        .day-header.is-today {
            background: var(--accent-light);
            border-bottom-color: var(--accent-border);
        }

        .day-date {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .day-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
        }

        .day-header.is-today .day-number {
            color: var(--accent);
        }

        .day-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .day-task-count {
            font-size: 1rem;
            color: var(--text-muted);
            background: var(--bg);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .day-tasks {
            padding: 20px;
        }

        /* Week View */
        .week-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .week-day {
            border-right: 1px solid var(--border-light);
            min-height: 300px;
        }

        .week-day:last-child {
            border-right: none;
        }

        .week-day.is-past {
            background: var(--bg-subtle);
        }

        .week-day.is-today {
            background: var(--accent-light);
        }

        .week-day-header {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-subtle);
        }

        .week-day.is-today .week-day-header {
            background: var(--accent);
            color: white;
        }

        .week-day-name {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .week-day.is-today .week-day-name {
            color: rgba(255,255,255,0.8);
        }

        .week-day-number {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
        }

        .week-day.is-today .week-day-number {
            color: white;
        }

        .week-day-tasks {
            padding: 12px;
        }

        .week-day-empty {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            padding: 20px 8px;
        }

        .week-task {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 6px;
            background: var(--bg);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid var(--border-light);
        }

        .week-task:hover {
            background: var(--bg-muted);
            transform: translateX(2px);
        }

        .week-task.completed {
            opacity: 0.6;
        }

        .week-task.completed .week-task-name {
            text-decoration: line-through;
        }

        .week-task-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .week-task-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .week-task-more {
            text-align: center;
            font-size: 0.8rem;
            color: var(--accent);
            font-weight: 600;
            padding: 6px;
        }

        /* Month View */
        .month-view {
            padding: 0;
        }

        .month-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg-subtle);
            border-bottom: 1px solid var(--border);
        }

        .month-header-day {
            padding: 14px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .month-grid {
            display: flex;
            flex-direction: column;
        }

        .month-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-bottom: 1px solid var(--border-light);
        }

        .month-week:last-child {
            border-bottom: none;
        }

        .month-day {
            min-height: 120px;
            padding: 10px;
            border-right: 1px solid var(--border-light);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .month-day:last-child {
            border-right: none;
        }

        .month-day:hover {
            background: var(--bg-subtle);
        }

        .month-day.empty {
            background: var(--bg-subtle);
            cursor: default;
        }

        .month-day.is-past {
            background: var(--bg-subtle);
        }

        .month-day.is-today {
            background: var(--accent-light);
        }

        .month-day.has-overdue {
            border-left: 3px solid var(--danger);
        }

        .month-day-number {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .month-day.is-today .month-day-number {
            color: var(--accent);
            background: var(--accent);
            color: white;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .month-day-tasks {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .month-task {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            padding: 4px 8px;
            background: var(--bg);
            border-radius: 4px;
            border-left: 3px solid var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .month-task.completed {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .month-task-more {
            font-size: 0.75rem;
            color: var(--accent);
            font-weight: 600;
            padding: 2px 8px;
        }

        .calendar-view {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .calendar-date-group {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .calendar-date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: var(--bg-subtle);
            border-bottom: 1px solid var(--border-light);
        }

        .calendar-date {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }

        .calendar-count {
            font-size: 0.9rem;
            color: var(--text-muted);
            background: var(--bg);
            padding: 4px 12px;
            border-radius: 20px;
        }

        .calendar-date-group .task-list {
            padding: 12px;
        }

        /* ═══════════════════════════════════════
           TEAM GRID
        ═══════════════════════════════════════ */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .team-members-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .team-member-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            transition: all 0.15s ease;
        }

        .team-member-card:hover {
            background: var(--bg-muted);
        }

        .team-member-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .team-member-info {
            flex: 1;
            min-width: 0;
        }

        .team-member-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }

        .team-member-stats {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .team-member-add {
            display: flex;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--border-light);
            margin-top: 8px;
        }

        /* ═══════════════════════════════════════
           SETTINGS PANEL
        ═══════════════════════════════════════ */
        .settings-panel {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .settings-panel h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Department Settings */
        .dept-settings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .dept-settings-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            transition: all 0.15s ease;
        }

        .dept-settings-item:hover {
            background: var(--bg-muted);
        }

        .dept-settings-preview {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .dept-settings-icon {
            font-size: 1.4rem;
        }

        .dept-settings-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }

        .dept-name-input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            background: var(--bg);
            color: var(--text);
            width: 100%;
        }

        .dept-name-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .dept-settings-lead {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dept-lead-select {
            padding: 4px 8px;
            font-size: 0.85rem;
            min-width: 140px;
        }

        .dept-settings-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .dept-icon-input {
            width: 44px;
            height: 36px;
            padding: 4px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1.2rem;
            text-align: center;
            background: var(--bg);
        }

        .dept-icon-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .dept-color-input {
            width: 36px;
            height: 36px;
            padding: 2px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            background: var(--bg);
        }

        .dept-color-input::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        .dept-color-input::-webkit-color-swatch {
            border-radius: 4px;
            border: none;
        }

        .dept-add-form {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            border: 2px dashed var(--border);
        }

        /* ═══════════════════════════════════════
           ANALYTICS
        ═══════════════════════════════════════ */
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .time-filter {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .time-filter-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .analytics-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .analytics-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .analytics-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analytics-card-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .analytics-big-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
            margin-bottom: 8px;
        }

        .analytics-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .analytics-trend.up {
            background: var(--success-light);
            color: var(--success);
        }

        .analytics-trend.down {
            background: var(--danger-light);
            color: var(--danger);
        }

        .analytics-trend.neutral {
            background: var(--bg-muted);
            color: var(--text-muted);
        }

        /* Charts */
        .chart-container {
            height: 200px;
            position: relative;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100%;
            gap: 8px;
            padding-top: 20px;
        }

        .bar-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .bar {
            width: 100%;
            max-width: 40px;
            border-radius: 6px 6px 0 0;
            transition: height 0.3s ease;
            position: relative;
        }

        .bar-value {
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text);
        }

        .bar-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            white-space: nowrap;
        }

        /* Pie Chart */
        .pie-chart-container {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .pie-chart {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
        }

        .pie-legend {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pie-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
        }

        .pie-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .pie-legend-label {
            flex: 1;
            color: var(--text-secondary);
        }

        .pie-legend-value {
            font-weight: 700;
            color: var(--text);
        }

        /* Leaderboard */
        .leaderboard {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            transition: all 0.15s ease;
        }

        .leaderboard-item:hover {
            background: var(--bg-muted);
        }

        .leaderboard-rank {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85rem;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .leaderboard-rank.gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
        }

        .leaderboard-rank.silver {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            color: white;
        }

        .leaderboard-rank.bronze {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            color: white;
        }

        .leaderboard-rank.other {
            background: var(--bg-muted);
            color: var(--text-muted);
        }

        .leaderboard-info {
            flex: 1;
            min-width: 0;
        }

        .leaderboard-name {
            font-weight: 600;
            color: var(--text);
        }

        .leaderboard-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .leaderboard-score {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }

        /* Alerts */
        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            border-radius: var(--radius);
            border-left: 4px solid;
        }

        .alert-item.danger {
            background: var(--danger-light);
            border-color: var(--danger);
        }

        .alert-item.warning {
            background: var(--warning-light);
            border-color: var(--warning);
        }

        .alert-item.info {
            background: var(--accent-light);
            border-color: var(--accent);
        }

        .alert-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }

        .alert-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Project Rankings */
        .project-ranking {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .ranking-item:hover {
            background: var(--bg-muted);
            transform: translateX(4px);
        }

        .ranking-position {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text-muted);
            width: 30px;
            text-align: center;
        }

        .ranking-info {
            flex: 1;
            min-width: 0;
        }

        .ranking-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .ranking-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .ranking-score {
            text-align: right;
        }

        .ranking-percentage {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--success);
        }

        .ranking-tasks {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Mini Stats Row */
        .mini-stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
        }

        .mini-stat {
            text-align: center;
        }

        .mini-stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
        }

        .mini-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Project Stats Modal */
        .project-stats-btn {
            padding: 8px 14px;
            background: var(--accent-light);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius);
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
        }

        .project-stats-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: var(--bg-subtle);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }

        .stat-box-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-box-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .stat-box.success .stat-box-value { color: var(--success); }
        .stat-box.warning .stat-box-value { color: var(--warning); }
        .stat-box.danger .stat-box-value { color: var(--danger); }
        .stat-box.accent .stat-box-value { color: var(--accent); }

        /* Prediction Card */
        .prediction-card {
            background: linear-gradient(135deg, var(--accent-light) 0%, #ede9fe 100%);
            border: 1px solid var(--accent-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 20px;
        }

        .prediction-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .prediction-icon {
            font-size: 1.5rem;
        }

        .prediction-title {
            font-weight: 700;
            color: var(--text);
        }

        .prediction-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .prediction-date {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent);
        }

        .prediction-confidence {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .risk-indicator.low {
            background: var(--success-light);
            color: var(--success);
        }

        .risk-indicator.medium {
            background: var(--warning-light);
            color: var(--warning);
        }

        .risk-indicator.high {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Department Analytics */
        .dept-analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .dept-analytics-card {
            background: var(--bg-subtle);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }

        .dept-analytics-card:hover {
            background: var(--bg-muted);
            border-color: var(--border);
            transform: translateY(-2px);
        }

        .dept-analytics-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .dept-analytics-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .dept-analytics-name {
            font-weight: 600;
            color: var(--text);
        }

        .dept-analytics-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .dept-analytics-numbers {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }

        .dept-analytics-percentage {
            font-weight: 700;
            color: var(--text);
        }

        .dept-analytics-count {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .dept-analytics-alert {
            margin-top: 10px;
            padding: 6px 10px;
            background: var(--warning-light);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--warning);
            font-weight: 600;
        }

        /* Person Analytics */
        .person-analytics-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .person-analytics-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .person-analytics-card:hover {
            background: var(--bg-muted);
            transform: translateX(4px);
        }

        .person-rank {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85rem;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .person-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .person-analytics-info {
            flex: 1;
            min-width: 0;
        }

        .person-analytics-name {
            font-weight: 600;
            color: var(--text);
        }

        .person-analytics-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .person-analytics-stats {
            display: flex;
            gap: 20px;
        }

        .person-stat {
            text-align: center;
        }

        .person-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .person-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Task Analytics */
        .task-analytics-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 600px;
            overflow-y: auto;
        }

        .task-analytics-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .task-analytics-item:hover {
            background: var(--bg-muted);
        }

        .task-analytics-item.completed {
            opacity: 0.6;
        }

        .task-analytics-item.completed .task-analytics-name {
            text-decoration: line-through;
        }

        .task-analytics-item.overdue {
            border-left: 3px solid var(--danger);
        }

        .task-analytics-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
            flex-shrink: 0;
        }

        .task-analytics-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .task-analytics-content {
            flex: 1;
            min-width: 0;
        }

        .task-analytics-name {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 2px;
        }

        .task-analytics-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .task-analytics-dept {
            font-weight: 500;
        }

        .task-analytics-due {
            flex-shrink: 0;
        }

        .task-filters-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            padding: 16px 0;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .task-filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .task-filter-group .select {
            min-width: 130px;
        }

        /* Projects View Filters */
        .projects-filters {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            padding: 20px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
        }

        .projects-filters .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .projects-filters .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .projects-filters .select {
            min-width: 150px;
        }

        .projects-count {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 16px;
            padding-left: 4px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .input, .select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-family: inherit;
            background: var(--bg);
            color: var(--text);
            transition: all 0.15s ease;
        }

        .input:focus, .select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        textarea.input {
            resize: vertical;
            min-height: 80px;
        }

        /* ═══════════════════════════════════════
           RESPONSIVE
        ═══════════════════════════════════════ */
        @media (max-width: 1024px) {
            .app-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .main-content {
                padding: 24px;
            }

            .projects-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .page-header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                justify-content: stretch;
            }

            .header-actions .btn {
                flex: 1;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .quick-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .quick-actions-divider {
                width: 100%;
                height: 1px;
            }

            .quick-input-group {
                flex-direction: column;
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">WS</div>
            <h1 class="login-title">WSDisplay Tracker</h1>
            <p class="login-subtitle">Sign in to access your projects and tasks</p>
            
            <button class="google-btn" onclick="signInWithGoogle()">
                <svg viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
            
            <div id="loginError" class="login-error hidden"></div>
            
            <div id="loginLoading" class="login-loading hidden">
                <div class="loading-spinner"></div>
                <span>Signing you in...</span>
            </div>
        </div>
    </div>

    <!-- Access Denied Screen -->
    <div id="accessDenied" class="login-screen hidden">
        <div class="login-card">
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 4rem; margin-bottom: 16px;">🚫</div>
                <h2 style="color: var(--danger); margin-bottom: 12px;">Access Denied</h2>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Your account is not authorized. Contact your administrator.</p>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;" id="deniedEmail"></p>
                <button class="btn" onclick="signOut()">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" class="app-layout hidden">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">WS</div>
                    <div>
                        <div class="logo-text">WSDisplay AI</div>
                        <div class="logo-subtitle">Analytics Tracker</div>
                    </div>
                </div>
            </div>

            <nav class="nav-section">
                <div class="nav-label">Overview</div>
                <div class="nav-item active" data-view="dashboard">
                    <span class="nav-icon">📊</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-view="my-tasks">
                    <span class="nav-icon">✅</span>
                    <span>My Tasks</span>
                    <span class="nav-badge" id="myTasksBadge">0</span>
                </div>
                <div class="nav-item" data-view="projects">
                    <span class="nav-icon">📁</span>
                    <span>All Projects</span>
                </div>
                <div class="nav-item" data-view="calendar">
                    <span class="nav-icon">📅</span>
                    <span>Calendar</span>
                </div>
            </nav>

            <nav class="nav-section">
                <div class="nav-label">Tools</div>
                <div class="nav-item" data-view="issues">
                    <span class="nav-icon">🐛</span>
                    <span>Issue Log</span>
                    <span class="nav-badge" id="issueCount">0</span>
                </div>
            </nav>

            <nav class="nav-section admin-only">
                <div class="nav-label">Admin</div>
                <div class="nav-item" data-view="users">
                    <span class="nav-icon">👥</span>
                    <span>Manage Users</span>
                </div>
                <div class="nav-item" data-view="settings">
                    <span class="nav-icon">⚙️</span>
                    <span>Settings</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="sync-status" id="syncStatus">
                    <span>●</span> <span id="syncText">Connecting...</span>
                </div>
                <div style="position: relative; margin-top: 12px;">
                    <div class="user-card" onclick="toggleUserMenu()">
                        <div class="user-avatar" id="userAvatar">--</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRoleDisplay"></div>
                        </div>
                    </div>
                    <div class="user-menu" id="userMenu">
                        <div class="user-menu-item" onclick="showMyProfile()">
                            <span>👤</span> My Profile
                        </div>
                        <div class="user-menu-item danger" onclick="signOut()">
                            <span>🚪</span> Sign Out
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Filter Bar for Task Views -->
            <div class="filter-bar" id="filterBar">
                <div class="filter-group">
                    <span class="filter-label">View:</span>
                    <button class="filter-toggle active" onclick="setViewFilter('all')" data-filter="all">All Tasks</button>
                    <button class="filter-toggle" onclick="setViewFilter('mine')" data-filter="mine">My Tasks</button>
                    <button class="filter-toggle" onclick="setViewFilter('dept')" data-filter="dept">My Department</button>
                </div>
                <div class="filter-group" style="margin-left: auto;">
                    <span class="filter-label">Department:</span>
                    <select class="select" id="deptFilterSelect" onchange="applyDeptFilter()" style="padding: 8px 12px;">
                        <option value="all">All Departments</option>
                    </select>
                </div>
            </div>

            <header class="page-header">
                <div>
                    <h1 class="page-title">Analytics Dashboard</h1>
                    <p class="page-subtitle">Track your AI implementation progress across all phases</p>
                </div>
                <div class="header-actions">
                    <button class="btn" onclick="exportData()">
                        <span>📤</span> Export
                    </button>
                    <button class="btn" onclick="document.getElementById('importInput').click()">
                        <span>📥</span> Import
                    </button>
                    <input type="file" id="importInput" accept=".json" style="display:none" onchange="importData(event)">
                    <button class="btn btn-primary viewer-hidden" onclick="openAddProjectModal()">
                        <span>➕</span> New Project
                    </button>
                </div>
            </header>

            <!-- Stats Grid -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">📈 Overall Progress</div>
                    <div class="stat-value" id="overallProgress">0%</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill primary" id="overallProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="stat-detail" id="overallDetail">0 of 0 tasks complete</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">✅ Tasks Completed</div>
                    <div class="stat-value" id="tasksCompleted">0</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill success" id="tasksProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="stat-detail" id="tasksDetail">This week: 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">🏢 Departments Active</div>
                    <div class="stat-value" id="deptsActive">0</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill primary" id="deptsProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="stat-detail" id="deptsDetail">0 tasks assigned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">⚠️ Due Soon</div>
                    <div class="stat-value" id="dueSoon">0</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill warning" style="width: 100%"></div>
                    </div>
                    <div class="stat-detail">Next 7 days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">🚨 Overdue</div>
                    <div class="stat-value" id="overdue">0</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill danger" style="width: 100%"></div>
                    </div>
                    <div class="stat-detail">Needs attention</div>
                </div>
            </section>

            <!-- Department Filters -->
            <section class="dept-filters" id="deptFilters">
                <span class="dept-filter-label">🏢 Filter by Department:</span>
                <button class="dept-pill active" data-dept="all" onclick="filterByDepartment('all')">All</button>
            </section>

            <!-- Filter Bar -->
            <section class="filter-bar">
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search tasks and projects...">
                </div>
                <div class="filter-chips">
                    <button class="chip active" data-filter="all">All</button>
                    <button class="chip" data-filter="pending">Pending</button>
                    <button class="chip" data-filter="completed">Completed</button>
                    <button class="chip" data-filter="overdue">Overdue</button>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="grid">Grid</button>
                    <button class="view-btn" data-view="list">List</button>
                </div>
            </section>

            <!-- Phases Container -->
            <div id="phasesContainer"></div>
        </main>
    </div><!-- End mainApp -->

    <!-- Project Detail Modal -->
    <div class="modal-overlay" id="projectModal">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title" id="modalProjectTitle">Project Title</h2>
                    <p class="modal-description" id="modalProjectDescription">Project description goes here</p>
                </div>
                <button class="modal-close" onclick="closeProjectModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Project Department Selector -->
                <div id="projectDeptSelector" style="display: flex; align-items: center; margin-bottom: 20px; padding: 16px 20px; background: var(--bg-subtle); border-radius: var(--radius);"></div>

                <div class="project-progress" style="margin-bottom: 28px;">
                    <div class="progress-header">
                        <span class="progress-label">Progress</span>
                        <span class="progress-value" id="modalProgressValue">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="modalProgressBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="task-list" id="modalTaskList">
                    <!-- Tasks rendered here -->
                </div>

                <!-- Add Task Section -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px dashed var(--border-light);">
                    <div style="display: flex; gap: 12px;">
                        <input type="text" class="input input-flex" id="newTaskInput" placeholder="Add a new task...">
                        <button class="btn btn-primary" onclick="addTaskToCurrentProject()">Add Task</button>
                    </div>
                </div>

                <!-- AI Assistant -->
                <div class="ai-panel">
                    <div class="ai-panel-header">
                        <div class="ai-icon">🤖</div>
                        <div>
                            <div class="ai-title">AI Assistant</div>
                            <div class="ai-subtitle">Ask questions about this task</div>
                        </div>
                    </div>
                    <div class="ai-input-row">
                        <input type="text" class="ai-input" id="aiQuestionInput" placeholder="How do I implement this?">
                        <button class="btn btn-primary" onclick="askAI()">Ask</button>
                    </div>
                    <div class="ai-response" id="aiResponse" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="project-stats-btn" onclick="showProjectStats()">📈 Analytics</button>
                <div style="flex: 1;"></div>
                <button class="btn" onclick="closeProjectModal()">Close</button>
                <button class="btn btn-danger" onclick="reportIssue()">🐛 Report Issue</button>
            </div>
        </div>
    </div>

    <!-- Project Stats Modal -->
    <div class="modal-overlay" id="projectStatsModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title" id="statsModalTitle">Project Analytics</h2>
                    <p class="modal-description" id="statsModalSubtitle">Performance metrics and predictions</p>
                </div>
                <button class="modal-close" onclick="closeProjectStatsModal()">×</button>
            </div>
            <div class="modal-body" id="projectStatsContent">
                <!-- Stats rendered here -->
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="openAddProjectModal()" title="Add New Project">+</button>

    <!-- Keyboard Shortcuts Panel -->
    <div class="shortcuts-panel" id="shortcutsPanel">
        <div class="shortcuts-title">⌨️ Keyboard Shortcuts</div>
        <div class="shortcut-row">
            <span>Search</span>
            <span class="shortcut-key"><kbd>/</kbd></span>
        </div>
        <div class="shortcut-row">
            <span>New Task</span>
            <span class="shortcut-key"><kbd>N</kbd></span>
        </div>
        <div class="shortcut-row">
            <span>Close Modal</span>
            <span class="shortcut-key"><kbd>Esc</kbd></span>
        </div>
        <div class="shortcut-row">
            <span>Show Help</span>
            <span class="shortcut-key"><kbd>?</kbd></span>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ═══════════════════════════════════════════════════════════════
        // FIREBASE CONFIGURATION
        // ═══════════════════════════════════════════════════════════════
        // 
        // TO SET UP FIREBASE:
        // 1. Go to https://console.firebase.google.com
        // 2. Click "Create a project" (or use existing)
        // 3. Once created, click the web icon (</>) to add a web app
        // 4. Copy the config values below
        // 5. Go to Authentication → Sign-in method → Enable Google
        // 6. Go to Firestore Database → Create database (start in test mode)
        //
        // ═══════════════════════════════════════════════════════════════

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Check if Firebase is configured
        const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY";

        // Initialize Firebase
        let db, auth;
        if (isFirebaseConfigured) {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            
            // Enable offline persistence
            db.enablePersistence().catch(err => {
                console.log('Persistence error:', err);
            });
        }

        // ═══════════════════════════════════════════════════════════════
        // USER & AUTH STATE
        // ═══════════════════════════════════════════════════════════════
        let currentUser = null;
        let currentUserData = null;
        let allAuthorizedUsers = [];
        let viewFilter = 'all';
        let deptFilterValue = 'all';

        // Role definitions
        const userRoles = {
            admin: { name: 'Admin', level: 4, icon: '👑' },
            manager: { name: 'Manager', level: 3, icon: '📋' },
            employee: { name: 'Employee', level: 2, icon: '👷' },
            viewer: { name: 'Viewer', level: 1, icon: '👁️' }
        };

        // ═══════════════════════════════════════════════════════════════
        // AUTHENTICATION FUNCTIONS
        // ═══════════════════════════════════════════════════════════════

        async function signInWithGoogle() {
            if (!isFirebaseConfigured) {
                showFirebaseSetupModal();
                return;
            }

            const btn = document.querySelector('.google-btn');
            const loading = document.getElementById('loginLoading');
            const error = document.getElementById('loginError');
            
            btn.classList.add('hidden');
            loading.classList.remove('hidden');
            error.classList.add('hidden');

            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (err) {
                console.error('Sign in error:', err);
                btn.classList.remove('hidden');
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                error.textContent = err.message;
            }
        }

        async function signOut() {
            if (auth) {
                await auth.signOut();
            }
            currentUser = null;
            currentUserData = null;
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('accessDenied').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.querySelector('.google-btn')?.classList.remove('hidden');
            document.getElementById('loginLoading')?.classList.add('hidden');
        }

        function showAccessDenied(email) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('accessDenied').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('deniedEmail').textContent = email;
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('accessDenied').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            applyRolePermissions();
            updateUserUI();
            initializeApp();
            setupRealtimeListeners();
        }

        function updateUserUI() {
            if (!currentUserData || !currentUser) return;

            // Update avatar
            const avatar = document.getElementById('userAvatar');
            if (currentUser.photoURL) {
                avatar.innerHTML = `<img src="${currentUser.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            } else {
                const initials = (currentUserData.displayName || currentUser.email)
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase()
                    .slice(0, 2);
                avatar.textContent = initials;
            }

            // Update name and role
            document.getElementById('userName').textContent = currentUserData.displayName || currentUser.email.split('@')[0];
            const roleInfo = userRoles[currentUserData.role] || userRoles.employee;
            document.getElementById('userRoleDisplay').innerHTML = `<span class="role-badge ${currentUserData.role}">${roleInfo.icon} ${roleInfo.name}</span>`;
        }

        function applyRolePermissions() {
            if (!currentUserData) return;

            const role = currentUserData.role;
            const level = userRoles[role]?.level || 0;

            // Admin-only elements
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = level >= 4 ? '' : 'none';
            });

            // Viewer restrictions (can't edit)
            document.querySelectorAll('.viewer-hidden').forEach(el => {
                el.style.display = level >= 2 ? '' : 'none';
            });
        }

        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('show');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.sidebar-footer')) {
                document.getElementById('userMenu')?.classList.remove('show');
            }
        });

        function updateSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            const text = document.getElementById('syncText');
            if (!el || !text) return;
            
            el.className = 'sync-status ' + status;
            
            switch(status) {
                case 'syncing': text.textContent = 'Syncing...'; break;
                case 'synced': text.textContent = 'Connected'; break;
                case 'offline': text.textContent = 'Offline'; break;
                default: text.textContent = 'Connecting...';
            }
        }

        // Auth state listener
        if (isFirebaseConfigured) {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    updateSyncStatus('syncing');
                    
                    // Check if user is authorized
                    const userDoc = await db.collection('users').doc(user.email.toLowerCase()).get();
                    
                    if (userDoc.exists) {
                        currentUserData = userDoc.data();
                        currentUserData.email = user.email.toLowerCase();
                        
                        // Update last login
                        await db.collection('users').doc(user.email.toLowerCase()).update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                            displayName: user.displayName || currentUserData.displayName,
                            photoURL: user.photoURL
                        });
                        
                        showMainApp();
                        updateSyncStatus('synced');
                    } else {
                        // User not in authorized list
                        showAccessDenied(user.email);
                    }
                } else {
                    showLoginScreen();
                }
            });
        } else {
            // Demo mode without Firebase - show setup instructions
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // ═══════════════════════════════════════════════════════════════
        // FIREBASE REALTIME SYNC
        // ═══════════════════════════════════════════════════════════════

        function setupRealtimeListeners() {
            if (!db) return;

            // Listen to task completions
            db.collection('taskCompletions').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    const taskKey = change.doc.id;
                    if (change.type === 'added' || change.type === 'modified') {
                        taskCompletions[taskKey] = change.doc.data().completed;
                    } else if (change.type === 'removed') {
                        delete taskCompletions[taskKey];
                    }
                });
                renderPhases();
                updateStats();
                updateMyTasksBadge();
            });

            // Load authorized users
            db.collection('users').onSnapshot(snapshot => {
                allAuthorizedUsers = [];
                snapshot.forEach(doc => {
                    allAuthorizedUsers.push({ email: doc.id, ...doc.data() });
                });
            });
        }

        async function syncTaskCompletion(taskKey, isCompleted) {
            if (!db) return;
            
            try {
                await db.collection('taskCompletions').doc(taskKey).set({
                    completed: isCompleted,
                    completedBy: currentUser?.email || 'unknown',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (err) {
                console.error('Sync error:', err);
                showToast('Failed to sync - changes saved locally', true);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // VIEW FILTERS
        // ═══════════════════════════════════════════════════════════════

        function setViewFilter(filter) {
            viewFilter = filter;
            
            document.querySelectorAll('.filter-toggle[data-filter]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            renderPhases();
        }

        function applyDeptFilter() {
            deptFilterValue = document.getElementById('deptFilterSelect')?.value || 'all';
            renderPhases();
        }

        function populateDeptFilter() {
            const select = document.getElementById('deptFilterSelect');
            if (!select) return;

            select.innerHTML = `<option value="all">All Departments</option>` +
                departments.map(d => `<option value="${d.id}">${d.icon} ${d.name}</option>`).join('');
        }

        function updateMyTasksBadge() {
            if (!currentUserData) return;
            
            let myPendingTasks = 0;
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const allTasks = getAllTasks(project);
                    allTasks.forEach(task => {
                        const taskKey = `${project.id}_${task.name}`;
                        const isCompleted = taskCompletions[taskKey];
                        const isMyTask = task.owner === currentUserData.email || 
                                         task.owner === currentUserData.displayName ||
                                         task.owner === currentUser?.email;
                        if (isMyTask && !isCompleted) {
                            myPendingTasks++;
                        }
                    });
                });
            });
            
            const badge = document.getElementById('myTasksBadge');
            if (badge) badge.textContent = myPendingTasks;
        }

        function showMyProfile() {
            document.getElementById('userMenu').classList.remove('show');
            showToast('Profile settings coming soon!');
        }

        function showFirebaseSetupModal() {
            const modal = document.createElement('div');
            modal.id = 'setupModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">🔧 Firebase Setup Required</h2>
                            <p class="modal-description">Follow these steps to connect your Firebase project</p>
                        </div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: var(--accent-light); border: 1px solid var(--accent-border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px;">
                            <strong>Quick Setup Guide:</strong>
                            <ol style="margin: 12px 0 0 20px; line-height: 2;">
                                <li>Go to <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                                <li>Create a new project (free tier)</li>
                                <li>Click the web icon <code>&lt;/&gt;</code> to add a web app</li>
                                <li>Copy the config values</li>
                                <li>Enable <strong>Authentication → Google Sign-in</strong></li>
                                <li>Create a <strong>Firestore Database</strong> (test mode)</li>
                                <li>Paste config into the firebaseConfig object in this HTML file</li>
                            </ol>
                        </div>
                        <div style="background: var(--warning-light); border: 1px solid var(--warning-border); border-radius: var(--radius); padding: 16px;">
                            <strong>⚠️ First Admin Setup:</strong>
                            <p style="margin-top: 8px; font-size: 0.9rem;">After setting up Firebase, run this in browser console to add yourself as admin:</p>
                            <pre style="background: var(--bg-muted); padding: 12px; border-radius: 8px; margin-top: 8px; font-size: 0.8rem; overflow-x: auto;">firebase.firestore().collection('users').doc('YOUR_EMAIL').set({
    displayName: 'Your Name',
    role: 'admin',
    department: 'admin',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
});</pre>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Got it!</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ═══════════════════════════════════════
        // DATA & STATE
        // ═══════════════════════════════════════
        const masterplan = {
            phases: [
                {
                    id: 1,
                    name: "Production & PrintFlow",
                    icon: "🖨️",
                    projects: [
                        {
                            id: "printflow-core",
                            title: "PrintFlow Core System",
                            description: "Production management dashboard with job tracking and department workflows",
                            owner: "Craig",
                            priority: "critical",
                            department: "printing",
                            tasks: [
                                { name: "Job queue management interface", owner: "Dev Team" },
                                { name: "Department tablet interfaces", owner: "Dev Team" },
                                { name: "QR code scanning for jobs", owner: "Dev Team" },
                                { name: "Real-time job status updates", owner: "Dev Team" },
                                { name: "Machine assignment system", owner: "Dev Team" }
                            ]
                        },
                        {
                            id: "printflow-graphics",
                            title: "Graphics Department Workflow",
                            description: "Artwork review, proofing, and approval system",
                            owner: "Graphics Lead",
                            priority: "high",
                            department: "graphics",
                            tasks: [
                                { name: "Artwork upload and preview", owner: "Dev Team" },
                                { name: "Proof generation system", owner: "Dev Team" },
                                { name: "Customer approval workflow", owner: "Dev Team" },
                                { name: "File preparation checklist", owner: "Graphics" },
                                { name: "Print-ready file export", owner: "Dev Team" }
                            ]
                        },
                        {
                            id: "printflow-finishing",
                            title: "Finishing & Shipping",
                            description: "Post-production workflows for cutting, finishing, and shipping",
                            owner: "Production Manager",
                            priority: "high",
                            department: "finishing",
                            tasks: [
                                { name: "Cutting queue interface", owner: "Dev Team" },
                                { name: "Finishing task checklist", owner: "Finishing" },
                                { name: "Packing slip generation", owner: "Dev Team" },
                                { name: "Shipping label integration", owner: "Dev Team" },
                                { name: "Shipment tracking updates", owner: "Dev Team" }
                            ]
                        }
                    ]
                },
                {
                    id: 2,
                    name: "Sales & E-commerce",
                    icon: "🛒",
                    projects: [
                        {
                            id: "shopify-integration",
                            title: "Shopify Store Integration",
                            description: "Connect Shopify orders to production and NetSuite",
                            owner: "Craig",
                            priority: "critical",
                            department: "web",
                            tasks: [
                                { name: "Shopify order sync to PrintFlow", owner: "Dev Team" },
                                { name: "Product configurator updates", owner: "Web Team" },
                                { name: "Inventory sync with NetSuite", owner: "Dev Team" },
                                { name: "Order status webhooks", owner: "Dev Team" },
                                { name: "Customer portal for order tracking", owner: "Web Team" }
                            ]
                        },
                        {
                            id: "banner-designer",
                            title: "Custom Banner Design Tool",
                            description: "AI-powered banner design tool for customer self-service",
                            owner: "Craig",
                            priority: "high",
                            department: "web",
                            tasks: [
                                { name: "Template selection interface", owner: "Web Team" },
                                { name: "AI image generation integration", owner: "Dev Team" },
                                { name: "Text and layout editor", owner: "Web Team" },
                                { name: "Preview and proof system", owner: "Dev Team" },
                                { name: "Add to cart integration", owner: "Web Team" }
                            ]
                        },
                        {
                            id: "sales-dashboard",
                            title: "Sales Analytics Dashboard",
                            description: "Real-time sales tracking and reporting",
                            owner: "Sales Manager",
                            priority: "medium",
                            department: "sales",
                            tasks: [
                                { name: "Daily sales summary", owner: "Dev Team" },
                                { name: "Product performance reports", owner: "Dev Team" },
                                { name: "Customer segmentation", owner: "Dev Team" },
                                { name: "Sales rep performance", owner: "Dev Team" },
                                { name: "Revenue forecasting", owner: "Dev Team" }
                            ]
                        }
                    ]
                },
                {
                    id: 3,
                    name: "Data & Integration",
                    icon: "🔗",
                    projects: [
                        {
                            id: "netsuite-integration",
                            title: "NetSuite Integration",
                            description: "Sync orders, inventory, and financials with NetSuite ERP",
                            owner: "IT Team",
                            priority: "critical",
                            department: "it",
                            tasks: [
                                { name: "Order sync automation", owner: "Dev Team" },
                                { name: "Inventory level sync", owner: "Dev Team" },
                                { name: "Customer record sync", owner: "Dev Team" },
                                { name: "Invoice generation", owner: "Dev Team" },
                                { name: "Financial reporting integration", owner: "Dev Team" }
                            ]
                        },
                        {
                            id: "data-warehouse",
                            title: "Data Warehouse Setup",
                            description: "Centralized data storage for analytics and reporting",
                            owner: "Craig",
                            priority: "high",
                            department: "it",
                            tasks: [
                                { name: "Design database schema", owner: "Dev Team" },
                                { name: "ETL pipeline setup", owner: "Dev Team" },
                                { name: "Data quality monitoring", owner: "Dev Team" },
                                { name: "Backup and recovery system", owner: "IT Team" },
                                { name: "API access layer", owner: "Dev Team" }
                            ]
                        }
                    ]
                },
                {
                    id: 4,
                    name: "AI & Automation",
                    icon: "🤖",
                    projects: [
                        {
                            id: "ai-customer-service",
                            title: "AI Customer Service",
                            description: "AI-powered chatbot and email response system",
                            owner: "CS Manager",
                            priority: "high",
                            department: "cs",
                            tasks: [
                                { name: "Document common questions/answers", owner: "CS Team" },
                                { name: "Train AI on product catalog", owner: "Dev Team" },
                                { name: "Build chat widget", owner: "Web Team" },
                                { name: "Email auto-response system", owner: "Dev Team" },
                                { name: "Escalation workflow", owner: "CS Manager" }
                            ]
                        },
                        {
                            id: "ai-production",
                            title: "AI Production Optimization",
                            description: "Machine learning for production scheduling and optimization",
                            owner: "Craig",
                            priority: "medium",
                            department: "printing",
                            tasks: [
                                { name: "Collect production data", owner: "Dev Team" },
                                { name: "Build scheduling algorithm", owner: "Dev Team" },
                                { name: "Demand forecasting model", owner: "Dev Team" },
                                { name: "Bottleneck prediction", owner: "Dev Team" },
                                { name: "Capacity planning dashboard", owner: "Dev Team" }
                            ]
                        },
                        {
                            id: "ai-pricing",
                            title: "Dynamic Pricing Engine",
                            description: "AI-driven pricing recommendations based on demand",
                            owner: "Sales Manager",
                            priority: "low",
                            department: "sales",
                            tasks: [
                                { name: "Historical pricing analysis", owner: "Dev Team" },
                                { name: "Competitor price monitoring", owner: "Sales" },
                                { name: "Pricing model development", owner: "Dev Team" },
                                { name: "A/B testing framework", owner: "Dev Team" },
                                { name: "Pricing dashboard", owner: "Dev Team" }
                            ]
                        }
                    ]
                }
            ]
        };

        // Departments (editable)
        const defaultDepartments = [
            { id: 'graphics', name: 'Graphics', color: '#8b5cf6', icon: '🎨' },
            { id: 'printing', name: 'Printing', color: '#3b82f6', icon: '🖨️' },
            { id: 'web', name: 'Web', color: '#ec4899', icon: '🌐' },
            { id: 'cutting', name: 'Cutting', color: '#f59e0b', icon: '✂️' },
            { id: 'finishing', name: 'Finishing', color: '#10b981', icon: '✨' },
            { id: 'shipping', name: 'Shipping', color: '#6366f1', icon: '📦' },
            { id: 'it', name: 'IT', color: '#64748b', icon: '💻' },
            { id: 'sales', name: 'Sales', color: '#ef4444', icon: '💰' },
            { id: 'cs', name: 'Customer Service', color: '#14b8a6', icon: '🎧' },
            { id: 'admin', name: 'Admin', color: '#78716c', icon: '📋' }
        ];
        
        let departments = JSON.parse(localStorage.getItem('departments') || 'null') || [...defaultDepartments];
        let departmentLeads = JSON.parse(localStorage.getItem('departmentLeads') || '{}');

        // State
        let completedTasks = JSON.parse(localStorage.getItem('completedTasks') || '{}');
        let taskCompletions = {}; // Firebase synced completions
        let taskOwners = JSON.parse(localStorage.getItem('taskOwners') || '{}');
        let taskDueDates = JSON.parse(localStorage.getItem('taskDueDates') || '{}');
        let taskDepartments = JSON.parse(localStorage.getItem('taskDepartments') || '{}');
        let projectDepartments = JSON.parse(localStorage.getItem('projectDepartments') || '{}');
        let projectOwners = JSON.parse(localStorage.getItem('projectOwners') || '{}');
        let projectDueDates = JSON.parse(localStorage.getItem('projectDueDates') || '{}');
        let customTasks = JSON.parse(localStorage.getItem('customTasks') || '{}');
        let teamMembers = JSON.parse(localStorage.getItem('teamMembers') || '["Craig", "Mike", "Sarah", "John", "Lisa", "David", "Emma", "Chris"]');
        let currentProject = null;
        let activeDepartmentFilter = 'all';

        // ═══════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════
        
        function initializeApp() {
            renderDepartmentFilters();
            populateDeptFilter();
            renderPhases();
            updateStats();
            setupEventListeners();
            updateMyTasksBadge();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // If Firebase is not configured, initialize in demo mode
            if (!isFirebaseConfigured) {
                // Show login screen but also show demo option
                document.getElementById('loginScreen').classList.remove('hidden');
            }
            // Otherwise, auth state listener will call initializeApp
        });

        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', filterContent);
            
            // Filter chips
            document.querySelectorAll('.chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    filterContent();
                });
            });

            // View toggle
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    // Could toggle grid/list view here
                });
            });

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const view = item.dataset.view;
                    const phase = item.dataset.phase;
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    if (view === 'dashboard') {
                        // Show all phases
                        renderPhases();
                        updateStats(); // Restore main stats
                        document.querySelectorAll('.phase-section').forEach(p => p.style.display = '');
                        document.querySelector('.stats-grid').style.display = '';
                        document.getElementById('deptFilters').style.display = '';
                        document.getElementById('filterBar').style.display = '';
                        document.querySelector('.page-title').textContent = 'Analytics Dashboard';
                        document.querySelector('.page-subtitle').textContent = 'Track your implementation progress across all phases';
                    } else if (view === 'my-tasks') {
                        showMyTasksView();
                    } else if (view === 'users') {
                        showUsersView();
                    } else if (view === 'projects') {
                        showAllProjectsView();
                    } else if (view === 'analytics') {
                        showAnalyticsView();
                    } else if (view === 'calendar') {
                        showCalendarView();
                    } else if (view === 'issues') {
                        showIssuesView();
                    } else if (view === 'settings') {
                        showSettingsView();
                    } else if (phase) {
                        // Filter to specific phase
                        const phaseNum = parseInt(phase);
                        const phaseData = masterplan.phases[phaseNum - 1];
                        
                        if (phaseData) {
                            const phaseStats = getPhaseStats(phaseData);
                            document.querySelector('.page-title').textContent = `${phaseData.icon} ${phaseData.name}`;
                            document.querySelector('.page-subtitle').textContent = `Phase ${phaseNum} • ${phaseData.projects.length} projects • ${phaseStats.completed}/${phaseStats.total} tasks (${phaseStats.percentage}%)`;
                            
                            // Show phase-specific stats
                            document.querySelector('.stats-grid').style.display = '';
                            document.querySelector('.stats-grid').innerHTML = `
                                <div class="stat-card">
                                    <div class="stat-label">📈 Phase Progress</div>
                                    <div class="stat-value">${phaseStats.percentage}%</div>
                                    <div class="stat-progress">
                                        <div class="stat-progress-fill primary" style="width: ${phaseStats.percentage}%"></div>
                                    </div>
                                    <div class="stat-detail">${phaseStats.completed} of ${phaseStats.total} tasks</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">📁 Projects</div>
                                    <div class="stat-value">${phaseData.projects.length}</div>
                                    <div class="stat-progress">
                                        <div class="stat-progress-fill success" style="width: 100%"></div>
                                    </div>
                                    <div class="stat-detail">In this phase</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">✅ Completed</div>
                                    <div class="stat-value">${phaseStats.completed}</div>
                                    <div class="stat-progress">
                                        <div class="stat-progress-fill success" style="width: ${phaseStats.percentage}%"></div>
                                    </div>
                                    <div class="stat-detail">Tasks done</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">📋 Remaining</div>
                                    <div class="stat-value">${phaseStats.total - phaseStats.completed}</div>
                                    <div class="stat-progress">
                                        <div class="stat-progress-fill warning" style="width: ${100 - phaseStats.percentage}%"></div>
                                    </div>
                                    <div class="stat-detail">Tasks left</div>
                                </div>
                            `;
                        }
                        
                        renderPhases();
                        document.querySelectorAll('.phase-section').forEach((p, idx) => {
                            p.style.display = (idx + 1) === phaseNum ? '' : 'none';
                        });
                        document.getElementById('deptFilters').style.display = '';
                        document.querySelector('.filter-bar').style.display = '';
                    }
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === '/' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                if (e.key === 'Escape') {
                    closeProjectModal();
                }
                if (e.key === '?' && !e.target.matches('input, textarea')) {
                    document.getElementById('shortcutsPanel').classList.toggle('active');
                }
            });

            // Modal close on backdrop click
            document.getElementById('projectModal').addEventListener('click', (e) => {
                if (e.target.id === 'projectModal') closeProjectModal();
            });

            // Close stats modal on backdrop click
            document.getElementById('projectStatsModal').addEventListener('click', (e) => {
                if (e.target.id === 'projectStatsModal') closeProjectStatsModal();
            });
        }

        // ═══════════════════════════════════════
        // ANALYTICS FUNCTIONS
        // ═══════════════════════════════════════
        let analyticsTimeFilter = 'all'; // all, week, month, quarter

        function showAnalyticsView() {
            document.querySelector('.stats-grid').style.display = 'none';
            document.getElementById('deptFilters').style.display = 'none';
            document.querySelector('.filter-bar').style.display = 'none';
            document.querySelector('.page-title').textContent = 'Analytics Dashboard';
            document.querySelector('.page-subtitle').textContent = 'Performance metrics, trends, and predictions';
            
            const container = document.getElementById('phasesContainer');
            const overallStats = getOverallAnalytics();
            const alerts = getAlerts();
            
            container.innerHTML = `
                <!-- Filters Row -->
                <div class="analytics-header">
                    <div class="time-filter">
                        <span class="time-filter-label">View By:</span>
                        <select class="select" onchange="setAnalyticsViewBy(this.value)" style="min-width: 150px;">
                            <option value="overview" ${analyticsViewBy === 'overview' ? 'selected' : ''}>📊 Overview</option>
                            <option value="department" ${analyticsViewBy === 'department' ? 'selected' : ''}>🏢 Department</option>
                            <option value="person" ${analyticsViewBy === 'person' ? 'selected' : ''}>👤 Person</option>
                            <option value="task" ${analyticsViewBy === 'task' ? 'selected' : ''}>📋 Task</option>
                        </select>
                    </div>
                    <div class="time-filter">
                        <span class="time-filter-label">Time Period:</span>
                        <select class="select" onchange="setAnalyticsTimeFilter(this.value)" style="min-width: 150px;">
                            <option value="all" ${analyticsTimeFilter === 'all' ? 'selected' : ''}>All Time</option>
                            <option value="week" ${analyticsTimeFilter === 'week' ? 'selected' : ''}>This Week</option>
                            <option value="month" ${analyticsTimeFilter === 'month' ? 'selected' : ''}>This Month</option>
                            <option value="quarter" ${analyticsTimeFilter === 'quarter' ? 'selected' : ''}>This Quarter</option>
                        </select>
                    </div>
                </div>

                <!-- Key Metrics (Always visible) -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">📊 Overall Progress</div>
                        </div>
                        <div class="analytics-big-number">${overallStats.percentage}%</div>
                        <div class="analytics-trend ${overallStats.velocity > 0 ? 'up' : overallStats.velocity < 0 ? 'down' : 'neutral'}">
                            ${overallStats.velocity > 0 ? '↑' : overallStats.velocity < 0 ? '↓' : '→'} 
                            ${Math.abs(overallStats.velocity)} tasks/week velocity
                        </div>
                        <div class="mini-stats">
                            <div class="mini-stat">
                                <div class="mini-stat-value">${overallStats.completed}</div>
                                <div class="mini-stat-label">Completed</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-value">${overallStats.remaining}</div>
                                <div class="mini-stat-label">Remaining</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-value">${overallStats.totalProjects}</div>
                                <div class="mini-stat-label">Projects</div>
                            </div>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">⚠️ Alerts</div>
                            <span class="analytics-card-subtitle">${alerts.length} items</span>
                        </div>
                        <div class="alerts-list">
                            ${alerts.length === 0 ? `
                                <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                    ✅ No alerts - everything on track!
                                </div>
                            ` : alerts.slice(0, 4).map(alert => `
                                <div class="alert-item ${alert.type}">
                                    <span class="alert-icon">${alert.icon}</span>
                                    <div class="alert-content">
                                        <div class="alert-title">${alert.title}</div>
                                        <div class="alert-description">${alert.description}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Dynamic Content Based on View -->
                <div id="analyticsViewContent">
                    ${renderAnalyticsViewContent()}
                </div>
            `;
        }

        function renderAnalyticsViewContent() {
            switch(analyticsViewBy) {
                case 'department':
                    return renderDepartmentView();
                case 'person':
                    return renderPersonView();
                case 'task':
                    return renderTaskView();
                default:
                    return renderOverviewContent();
            }
        }

        function renderOverviewContent() {
            const projectRankings = getProjectRankings();
            const teamLeaderboard = getTeamLeaderboard();
            const deptBreakdown = getDepartmentBreakdown();
            const overallStats = getOverallAnalytics();
            
            return `
                <!-- Charts Row -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">🏢 Department Breakdown</div>
                        </div>
                        <div class="pie-chart-container">
                            <div class="pie-chart" style="background: conic-gradient(${deptBreakdown.conicGradient})"></div>
                            <div class="pie-legend">
                                ${deptBreakdown.items.slice(0, 5).map(item => `
                                    <div class="pie-legend-item">
                                        <div class="pie-legend-color" style="background: ${item.color}"></div>
                                        <span class="pie-legend-label">${item.name}</span>
                                        <span class="pie-legend-value">${item.count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">📈 Progress by Phase</div>
                        </div>
                        <div class="chart-container">
                            <div class="bar-chart">
                                ${masterplan.phases.map(phase => {
                                    const stats = getPhaseStats(phase);
                                    const height = Math.max(stats.percentage, 5);
                                    return `
                                        <div class="bar-item">
                                            <div class="bar" style="height: ${height}%; background: var(--accent);">
                                                <span class="bar-value">${stats.percentage}%</span>
                                            </div>
                                            <div class="bar-label">${phase.icon}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rankings and Leaderboard -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">🏆 Project Rankings</div>
                            <span class="analytics-card-subtitle">By completion %</span>
                        </div>
                        <div class="project-ranking">
                            ${projectRankings.slice(0, 5).map((project, idx) => `
                                <div class="ranking-item" onclick="openProjectModal('${project.id}')">
                                    <div class="ranking-position">#${idx + 1}</div>
                                    <div class="ranking-info">
                                        <div class="ranking-title">${project.title}</div>
                                        <div class="ranking-meta">${project.owner} • ${project.deptName || 'No dept'}</div>
                                    </div>
                                    <div class="ranking-score">
                                        <div class="ranking-percentage" style="color: ${project.percentage === 100 ? 'var(--success)' : 'var(--text)'}">
                                            ${project.percentage}%
                                        </div>
                                        <div class="ranking-tasks">${project.completed}/${project.total} tasks</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="analytics-card">
                        <div class="analytics-card-header">
                            <div class="analytics-card-title">👥 Team Leaderboard</div>
                            <span class="analytics-card-subtitle">By tasks completed</span>
                        </div>
                        <div class="leaderboard">
                            ${teamLeaderboard.slice(0, 5).map((member, idx) => `
                                <div class="leaderboard-item">
                                    <div class="leaderboard-rank ${idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : 'other'}">
                                        ${idx + 1}
                                    </div>
                                    <div class="leaderboard-info">
                                        <div class="leaderboard-name">${member.name}</div>
                                        <div class="leaderboard-meta">${member.projects} projects assigned</div>
                                    </div>
                                    <div class="leaderboard-score">${member.completed}</div>
                                </div>
                            `).join('')}
                            ${teamLeaderboard.length === 0 ? `
                                <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                                    No team data yet
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Predictions -->
                <div class="analytics-card" style="margin-top: 20px;">
                    <div class="analytics-card-header">
                        <div class="analytics-card-title">🔮 Predictions & Insights</div>
                    </div>
                    <div class="analytics-grid" style="margin-bottom: 0;">
                        <div class="prediction-card">
                            <div class="prediction-header">
                                <span class="prediction-icon">📅</span>
                                <span class="prediction-title">Estimated Completion</span>
                            </div>
                            <div class="prediction-content">
                                <div>
                                    <div class="prediction-date">${overallStats.estimatedCompletion}</div>
                                    <div class="prediction-confidence">Based on current velocity</div>
                                </div>
                            </div>
                        </div>
                        <div class="prediction-card">
                            <div class="prediction-header">
                                <span class="prediction-icon">⚡</span>
                                <span class="prediction-title">Risk Assessment</span>
                            </div>
                            <div class="prediction-content">
                                <div>
                                    <div class="risk-indicator ${overallStats.risk}">
                                        ${overallStats.risk === 'low' ? '✓ Low Risk' : overallStats.risk === 'medium' ? '⚠ Medium Risk' : '🚨 High Risk'}
                                    </div>
                                    <div class="prediction-confidence" style="margin-top: 8px;">${overallStats.riskReason}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDepartmentView() {
            const deptData = getDetailedDepartmentData();
            
            return `
                <div class="analytics-card" style="margin-bottom: 20px;">
                    <div class="analytics-card-header">
                        <div class="analytics-card-title">🏢 All Departments</div>
                        <span class="analytics-card-subtitle">${departments.length} departments</span>
                    </div>
                    <div class="dept-analytics-grid">
                        ${deptData.map(dept => `
                            <div class="dept-analytics-card" onclick="showDepartmentDetail('${dept.id}')">
                                <div class="dept-analytics-header">
                                    <span class="dept-analytics-icon" style="background: ${dept.color}20; color: ${dept.color};">${dept.icon}</span>
                                    <div class="dept-analytics-info">
                                        <div class="dept-analytics-name">${dept.name}</div>
                                        <div class="dept-analytics-meta">${dept.projects} projects • ${dept.tasks} tasks</div>
                                    </div>
                                </div>
                                <div class="dept-analytics-stats">
                                    <div class="dept-analytics-progress">
                                        <div class="progress-bar" style="height: 8px;">
                                            <div class="progress-fill" style="width: ${dept.percentage}%; background: ${dept.color};"></div>
                                        </div>
                                    </div>
                                    <div class="dept-analytics-numbers">
                                        <span class="dept-analytics-percentage">${dept.percentage}%</span>
                                        <span class="dept-analytics-count">${dept.completed}/${dept.tasks}</span>
                                    </div>
                                </div>
                                ${dept.overdue > 0 ? `<div class="dept-analytics-alert">⚠️ ${dept.overdue} overdue</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div id="departmentDetailPanel"></div>
            `;
        }

        function renderPersonView() {
            const personData = getDetailedPersonData();
            
            return `
                <div class="analytics-card" style="margin-bottom: 20px;">
                    <div class="analytics-card-header">
                        <div class="analytics-card-title">👥 Team Members</div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <select class="select" onchange="setPersonFilter(this.value)" style="min-width: 140px;">
                                <option value="all" ${personFilterBy === 'all' ? 'selected' : ''}>All Members</option>
                                <option value="active" ${personFilterBy === 'active' ? 'selected' : ''}>With Tasks</option>
                                <option value="overdue" ${personFilterBy === 'overdue' ? 'selected' : ''}>Has Overdue</option>
                            </select>
                            <select class="select" onchange="setPersonSort(this.value)" style="min-width: 140px;">
                                <option value="completed" ${personSortBy === 'completed' ? 'selected' : ''}>Most Completed</option>
                                <option value="assigned" ${personSortBy === 'assigned' ? 'selected' : ''}>Most Assigned</option>
                                <option value="overdue" ${personSortBy === 'overdue' ? 'selected' : ''}>Most Overdue</option>
                                <option value="name" ${personSortBy === 'name' ? 'selected' : ''}>Name A-Z</option>
                            </select>
                        </div>
                    </div>
                    <div class="person-analytics-list">
                        ${personData.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                No team members match your filter.
                            </div>
                        ` : personData.map((person, idx) => `
                            <div class="person-analytics-card" onclick="showPersonDetail('${person.name}')">
                                <div class="person-rank ${idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : 'other'}">${idx + 1}</div>
                                <div class="person-avatar" style="background: ${getAvatarColor(person.name)};">${person.name.charAt(0).toUpperCase()}</div>
                                <div class="person-analytics-info">
                                    <div class="person-analytics-name">${person.name}</div>
                                    <div class="person-analytics-meta">
                                        ${person.projectsOwned} projects owned • ${person.tasksAssigned} tasks assigned
                                    </div>
                                </div>
                                <div class="person-analytics-stats">
                                    <div class="person-stat">
                                        <div class="person-stat-value" style="color: var(--success);">${person.tasksCompleted}</div>
                                        <div class="person-stat-label">Done</div>
                                    </div>
                                    <div class="person-stat">
                                        <div class="person-stat-value">${person.tasksRemaining}</div>
                                        <div class="person-stat-label">To Do</div>
                                    </div>
                                    <div class="person-stat">
                                        <div class="person-stat-value" style="color: ${person.overdue > 0 ? 'var(--danger)' : 'var(--text-muted)'};">${person.overdue}</div>
                                        <div class="person-stat-label">Overdue</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div id="personDetailPanel"></div>
            `;
        }

        let personFilterBy = 'all';
        let personSortBy = 'completed';

        function setPersonFilter(filter) {
            personFilterBy = filter;
            document.getElementById('analyticsViewContent').innerHTML = renderAnalyticsViewContent();
        }

        function setPersonSort(sort) {
            personSortBy = sort;
            document.getElementById('analyticsViewContent').innerHTML = renderAnalyticsViewContent();
        }

        function renderTaskView() {
            const allProjects = [];
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    allProjects.push({ id: project.id, title: project.title });
                });
            });
            
            const taskData = getDetailedTaskData();
            
            return `
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <div class="analytics-card-title">📋 All Tasks</div>
                        <span class="analytics-card-subtitle">${taskData.length} tasks</span>
                    </div>
                    
                    <!-- Filter Row -->
                    <div class="task-filters-row">
                        <div class="task-filter-group">
                            <label>Status:</label>
                            <select class="select" onchange="setTaskFilter('status', this.value)">
                                <option value="all" ${taskFilterStatus === 'all' ? 'selected' : ''}>All</option>
                                <option value="pending" ${taskFilterStatus === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="completed" ${taskFilterStatus === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="overdue" ${taskFilterStatus === 'overdue' ? 'selected' : ''}>Overdue</option>
                            </select>
                        </div>
                        <div class="task-filter-group">
                            <label>Department:</label>
                            <select class="select" onchange="setTaskFilter('dept', this.value)">
                                <option value="all" ${taskFilterDept === 'all' ? 'selected' : ''}>All Depts</option>
                                ${departments.map(d => `<option value="${d.id}" ${taskFilterDept === d.id ? 'selected' : ''}>${d.icon} ${d.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="task-filter-group">
                            <label>Project:</label>
                            <select class="select" onchange="setTaskFilter('project', this.value)">
                                <option value="all" ${taskFilterProject === 'all' ? 'selected' : ''}>All Projects</option>
                                ${allProjects.map(p => `<option value="${p.id}" ${taskFilterProject === p.id ? 'selected' : ''}>${p.title}</option>`).join('')}
                            </select>
                        </div>
                        <div class="task-filter-group">
                            <label>Sort:</label>
                            <select class="select" onchange="setTaskSort(this.value)">
                                <option value="dueDate" ${taskSortBy === 'dueDate' ? 'selected' : ''}>Due Date</option>
                                <option value="project" ${taskSortBy === 'project' ? 'selected' : ''}>Project</option>
                                <option value="department" ${taskSortBy === 'department' ? 'selected' : ''}>Department</option>
                                <option value="owner" ${taskSortBy === 'owner' ? 'selected' : ''}>Owner</option>
                                <option value="status" ${taskSortBy === 'status' ? 'selected' : ''}>Status</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="task-analytics-list">
                        ${taskData.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                No tasks match your filters.
                            </div>
                        ` : taskData.slice(0, 100).map(task => `
                            <div class="task-analytics-item ${task.isCompleted ? 'completed' : ''} ${task.isOverdue ? 'overdue' : ''}" onclick="openProjectModal('${task.projectId}')">
                                <div class="task-analytics-checkbox ${task.isCompleted ? 'checked' : ''}">
                                    ${task.isCompleted ? '✓' : ''}
                                </div>
                                <div class="task-analytics-content">
                                    <div class="task-analytics-name">${task.name}</div>
                                    <div class="task-analytics-meta">
                                        <span>📁 ${task.projectTitle}</span>
                                        ${task.deptName ? `<span class="task-analytics-dept" style="color: ${task.deptColor};">• ${task.deptIcon} ${task.deptName}</span>` : ''}
                                        ${task.owner ? `<span>• 👤 ${task.owner}</span>` : ''}
                                    </div>
                                </div>
                                <div class="task-analytics-due">
                                    ${task.dueDate ? `
                                        <span class="task-badge ${task.isOverdue ? 'overdue' : task.isDueSoon ? 'due-soon' : ''}">${formatDate(task.dueDate)}</span>
                                    ` : '<span style="color: var(--text-muted); font-size: 0.8rem;">No due date</span>'}
                                </div>
                            </div>
                        `).join('')}
                        ${taskData.length > 100 ? `
                            <div style="text-align: center; padding: 16px; color: var(--text-muted);">
                                Showing 100 of ${taskData.length} tasks
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        let taskFilterDept = 'all';
        let taskFilterProject = 'all';

        function setTaskFilter(type, value) {
            if (type === 'status') taskFilterStatus = value;
            else if (type === 'dept') taskFilterDept = value;
            else if (type === 'project') taskFilterProject = value;
            document.getElementById('analyticsViewContent').innerHTML = renderAnalyticsViewContent();
        }

        function getDetailedDepartmentData() {
            const deptData = {};
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            departments.forEach(d => {
                deptData[d.id] = {
                    id: d.id,
                    name: d.name,
                    icon: d.icon,
                    color: d.color,
                    projects: 0,
                    tasks: 0,
                    completed: 0,
                    overdue: 0,
                    percentage: 0
                };
            });
            
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const projDept = projectDepartments[project.id] || '';
                    if (projDept && deptData[projDept]) {
                        deptData[projDept].projects++;
                    }
                    
                    const tasks = getAllTasks(project);
                    tasks.forEach(task => {
                        const taskId = `${project.id}_${task.name}`;
                        const taskDept = taskDepartments[taskId] || projDept || '';
                        
                        if (taskDept && deptData[taskDept]) {
                            deptData[taskDept].tasks++;
                            if (completedTasks[taskId]) {
                                deptData[taskDept].completed++;
                            }
                            const dueDate = taskDueDates[taskId];
                            if (dueDate && !completedTasks[taskId] && new Date(dueDate) < today) {
                                deptData[taskDept].overdue++;
                            }
                        }
                    });
                });
            });
            
            return Object.values(deptData)
                .map(d => ({
                    ...d,
                    percentage: d.tasks > 0 ? Math.round((d.completed / d.tasks) * 100) : 0
                }))
                .sort((a, b) => b.tasks - a.tasks);
        }

        function getDetailedPersonData() {
            const personData = {};
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Initialize all team members
            teamMembers.forEach(name => {
                personData[name] = {
                    name,
                    projectsOwned: 0,
                    tasksAssigned: 0,
                    tasksCompleted: 0,
                    tasksRemaining: 0,
                    overdue: 0
                };
            });
            
            // Also track task owners that might not be in teamMembers
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const owner = projectOwners[project.id] || project.owner || '';
                    if (owner && !personData[owner]) {
                        personData[owner] = {
                            name: owner,
                            projectsOwned: 0,
                            tasksAssigned: 0,
                            tasksCompleted: 0,
                            tasksRemaining: 0,
                            overdue: 0
                        };
                    }
                    if (owner && personData[owner]) {
                        personData[owner].projectsOwned++;
                    }
                    
                    const tasks = getAllTasks(project);
                    tasks.forEach(task => {
                        const taskId = `${project.id}_${task.name}`;
                        const taskOwner = taskOwners[taskId] || task.owner || '';
                        
                        if (taskOwner && !personData[taskOwner]) {
                            personData[taskOwner] = {
                                name: taskOwner,
                                projectsOwned: 0,
                                tasksAssigned: 0,
                                tasksCompleted: 0,
                                tasksRemaining: 0,
                                overdue: 0
                            };
                        }
                        
                        if (taskOwner && personData[taskOwner]) {
                            personData[taskOwner].tasksAssigned++;
                            if (completedTasks[taskId]) {
                                personData[taskOwner].tasksCompleted++;
                            } else {
                                personData[taskOwner].tasksRemaining++;
                                const dueDate = taskDueDates[taskId];
                                if (dueDate && new Date(dueDate) < today) {
                                    personData[taskOwner].overdue++;
                                }
                            }
                        }
                    });
                });
            });
            
            let result = Object.values(personData);
            
            // Apply filter
            if (personFilterBy === 'active') {
                result = result.filter(p => p.tasksAssigned > 0 || p.projectsOwned > 0);
            } else if (personFilterBy === 'overdue') {
                result = result.filter(p => p.overdue > 0);
            }
            
            // Apply sort
            if (personSortBy === 'completed') {
                result.sort((a, b) => b.tasksCompleted - a.tasksCompleted);
            } else if (personSortBy === 'assigned') {
                result.sort((a, b) => b.tasksAssigned - a.tasksAssigned);
            } else if (personSortBy === 'overdue') {
                result.sort((a, b) => b.overdue - a.overdue);
            } else if (personSortBy === 'name') {
                result.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            return result;
        }

        let taskFilterStatus = 'all';
        let taskSortBy = 'dueDate';

        function setTaskFilter(status) {
            taskFilterStatus = status;
            document.getElementById('analyticsViewContent').innerHTML = renderAnalyticsViewContent();
        }

        function setTaskSort(sortBy) {
            taskSortBy = sortBy;
            document.getElementById('analyticsViewContent').innerHTML = renderAnalyticsViewContent();
        }

        function getDetailedTaskData() {
            const tasks = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const projDept = projectDepartments[project.id] || '';
                    
                    getAllTasks(project).forEach(task => {
                        const taskId = `${project.id}_${task.name}`;
                        const dueDate = taskDueDates[taskId];
                        const isCompleted = completedTasks[taskId];
                        const isOverdue = dueDate && !isCompleted && new Date(dueDate) < today;
                        const isDueSoon = dueDate && !isCompleted && !isOverdue && new Date(dueDate) <= weekFromNow;
                        const taskDept = taskDepartments[taskId] || projDept || '';
                        const dept = departments.find(d => d.id === taskDept);
                        
                        tasks.push({
                            taskId,
                            name: task.name,
                            projectId: project.id,
                            projectTitle: project.title,
                            owner: taskOwners[taskId] || task.owner || '',
                            dueDate,
                            isCompleted,
                            isOverdue,
                            isDueSoon,
                            deptId: taskDept,
                            deptName: dept?.name || '',
                            deptIcon: dept?.icon || '',
                            deptColor: dept?.color || ''
                        });
                    });
                });
            });
            
            // Apply filters
            let filtered = tasks;
            
            // Status filter
            if (taskFilterStatus === 'pending') {
                filtered = filtered.filter(t => !t.isCompleted);
            } else if (taskFilterStatus === 'completed') {
                filtered = filtered.filter(t => t.isCompleted);
            } else if (taskFilterStatus === 'overdue') {
                filtered = filtered.filter(t => t.isOverdue);
            }
            
            // Department filter
            if (taskFilterDept !== 'all') {
                filtered = filtered.filter(t => t.deptId === taskFilterDept);
            }
            
            // Project filter
            if (taskFilterProject !== 'all') {
                filtered = filtered.filter(t => t.projectId === taskFilterProject);
            }
            
            // Sort
            if (taskSortBy === 'dueDate') {
                filtered.sort((a, b) => {
                    if (!a.dueDate && !b.dueDate) return 0;
                    if (!a.dueDate) return 1;
                    if (!b.dueDate) return -1;
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });
            } else if (taskSortBy === 'project') {
                filtered.sort((a, b) => a.projectTitle.localeCompare(b.projectTitle));
            } else if (taskSortBy === 'department') {
                filtered.sort((a, b) => (a.deptName || 'zzz').localeCompare(b.deptName || 'zzz'));
            } else if (taskSortBy === 'owner') {
                filtered.sort((a, b) => (a.owner || 'zzz').localeCompare(b.owner || 'zzz'));
            } else if (taskSortBy === 'status') {
                filtered.sort((a, b) => {
                    if (a.isOverdue && !b.isOverdue) return -1;
                    if (!a.isOverdue && b.isOverdue) return 1;
                    if (!a.isCompleted && b.isCompleted) return -1;
                    if (a.isCompleted && !b.isCompleted) return 1;
                    return 0;
                });
            }
            
            return filtered;
        }

        function showDepartmentDetail(deptId) {
            const dept = departments.find(d => d.id === deptId);
            if (!dept) return;
            
            const tasks = [];
            const projects = [];
            const today = new Date();
            
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const projDept = projectDepartments[project.id] || '';
                    let hasTasksInDept = false;
                    
                    getAllTasks(project).forEach(task => {
                        const taskId = `${project.id}_${task.name}`;
                        const taskDept = taskDepartments[taskId] || projDept || '';
                        
                        if (taskDept === deptId) {
                            hasTasksInDept = true;
                            tasks.push({
                                name: task.name,
                                projectTitle: project.title,
                                projectId: project.id,
                                isCompleted: completedTasks[taskId],
                                dueDate: taskDueDates[taskId],
                                owner: taskOwners[taskId] || task.owner
                            });
                        }
                    });
                    
                    if (projDept === deptId || hasTasksInDept) {
                        const stats = getProjectStats(project);
                        projects.push({
                            id: project.id,
                            title: project.title,
                            stats
                        });
                    }
                });
            });
            
            const panel = document.getElementById('departmentDetailPanel');
            panel.innerHTML = `
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <div class="analytics-card-title">
                            <span style="background: ${dept.color}20; color: ${dept.color}; padding: 6px 10px; border-radius: 8px;">${dept.icon} ${dept.name}</span>
                            Details
                        </div>
                        <button class="btn btn-sm" onclick="document.getElementById('departmentDetailPanel').innerHTML = ''">✕ Close</button>
                    </div>
                    
                    <h4 style="font-size: 1rem; font-weight: 600; margin: 20px 0 12px;">Projects (${projects.length})</h4>
                    <div class="project-ranking">
                        ${projects.map(p => `
                            <div class="ranking-item" onclick="openProjectModal('${p.id}')">
                                <div class="ranking-info">
                                    <div class="ranking-title">${p.title}</div>
                                </div>
                                <div class="ranking-score">
                                    <div class="ranking-percentage">${p.stats.percentage}%</div>
                                    <div class="ranking-tasks">${p.stats.completed}/${p.stats.total}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h4 style="font-size: 1rem; font-weight: 600; margin: 20px 0 12px;">Tasks (${tasks.length})</h4>
                    <div class="task-analytics-list" style="max-height: 300px; overflow-y: auto;">
                        ${tasks.slice(0, 20).map(task => `
                            <div class="task-analytics-item ${task.isCompleted ? 'completed' : ''}" onclick="openProjectModal('${task.projectId}')">
                                <div class="task-analytics-checkbox ${task.isCompleted ? 'checked' : ''}">${task.isCompleted ? '✓' : ''}</div>
                                <div class="task-analytics-content">
                                    <div class="task-analytics-name">${task.name}</div>
                                    <div class="task-analytics-meta">${task.projectTitle} • ${task.owner || 'Unassigned'}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            panel.scrollIntoView({ behavior: 'smooth' });
        }

        function showPersonDetail(personName) {
            const tasks = [];
            const projects = [];
            
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const owner = projectOwners[project.id] || project.owner || '';
                    if (owner === personName) {
                        const stats = getProjectStats(project);
                        projects.push({ id: project.id, title: project.title, stats });
                    }
                    
                    getAllTasks(project).forEach(task => {
                        const taskId = `${project.id}_${task.name}`;
                        const taskOwner = taskOwners[taskId] || task.owner || '';
                        
                        if (taskOwner === personName) {
                            tasks.push({
                                name: task.name,
                                projectTitle: project.title,
                                projectId: project.id,
                                isCompleted: completedTasks[taskId],
                                dueDate: taskDueDates[taskId]
                            });
                        }
                    });
                });
            });
            
            const panel = document.getElementById('personDetailPanel');
            panel.innerHTML = `
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <div class="analytics-card-title">
                            <span class="person-avatar" style="background: ${getAvatarColor(personName)}; width: 32px; height: 32px; font-size: 0.9rem;">${personName.charAt(0).toUpperCase()}</span>
                            ${personName}
                        </div>
                        <button class="btn btn-sm" onclick="document.getElementById('personDetailPanel').innerHTML = ''">✕ Close</button>
                    </div>
                    
                    ${projects.length > 0 ? `
                        <h4 style="font-size: 1rem; font-weight: 600; margin: 20px 0 12px;">Projects Owned (${projects.length})</h4>
                        <div class="project-ranking">
                            ${projects.map(p => `
                                <div class="ranking-item" onclick="openProjectModal('${p.id}')">
                                    <div class="ranking-info">
                                        <div class="ranking-title">${p.title}</div>
                                    </div>
                                    <div class="ranking-score">
                                        <div class="ranking-percentage">${p.stats.percentage}%</div>
                                        <div class="ranking-tasks">${p.stats.completed}/${p.stats.total}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <h4 style="font-size: 1rem; font-weight: 600; margin: 20px 0 12px;">Tasks Assigned (${tasks.length})</h4>
                    <div class="task-analytics-list" style="max-height: 300px; overflow-y: auto;">
                        ${tasks.slice(0, 20).map(task => `
                            <div class="task-analytics-item ${task.isCompleted ? 'completed' : ''}" onclick="openProjectModal('${task.projectId}')">
                                <div class="task-analytics-checkbox ${task.isCompleted ? 'checked' : ''}">${task.isCompleted ? '✓' : ''}</div>
                                <div class="task-analytics-content">
                                    <div class="task-analytics-name">${task.name}</div>
                                    <div class="task-analytics-meta">${task.projectTitle}</div>
                                </div>
                                ${task.dueDate ? `<div class="task-analytics-due"><span class="task-badge">${formatDate(task.dueDate)}</span></div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            panel.scrollIntoView({ behavior: 'smooth' });
        }

        function getAvatarColor(name) {
            const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6366f1', '#ef4444', '#14b8a6'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        let analyticsViewBy = 'overview';

        // All Projects View State
        let projectsFilterDept = 'all';
        let projectsFilterPerson = 'all';
        let projectsFilterStatus = 'all';
        let projectsSortBy = 'name';

        function showAllProjectsView() {
            document.querySelector('.stats-grid').style.display = 'none';
            document.getElementById('deptFilters').style.display = 'none';
            document.querySelector('.filter-bar').style.display = 'none';
            document.querySelector('.page-title').textContent = 'All Projects';
            document.querySelector('.page-subtitle').textContent = 'Browse and manage all projects';
            
            const allProjects = getAllProjectsFiltered();
            const container = document.getElementById('phasesContainer');
            
            container.innerHTML = `
                <!-- Filters -->
                <div class="projects-filters">
                    <div class="filter-group">
                        <label>Department:</label>
                        <select class="select" onchange="setProjectsFilter('dept', this.value)">
                            <option value="all" ${projectsFilterDept === 'all' ? 'selected' : ''}>All Departments</option>
                            ${departments.map(d => `<option value="${d.id}" ${projectsFilterDept === d.id ? 'selected' : ''}>${d.icon} ${d.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Owner:</label>
                        <select class="select" onchange="setProjectsFilter('person', this.value)">
                            <option value="all" ${projectsFilterPerson === 'all' ? 'selected' : ''}>All People</option>
                            ${teamMembers.map(m => `<option value="${m}" ${projectsFilterPerson === m ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Status:</label>
                        <select class="select" onchange="setProjectsFilter('status', this.value)">
                            <option value="all" ${projectsFilterStatus === 'all' ? 'selected' : ''}>All Status</option>
                            <option value="inprogress" ${projectsFilterStatus === 'inprogress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${projectsFilterStatus === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="notstarted" ${projectsFilterStatus === 'notstarted' ? 'selected' : ''}>Not Started</option>
                            <option value="overdue" ${projectsFilterStatus === 'overdue' ? 'selected' : ''}>Overdue</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Sort:</label>
                        <select class="select" onchange="setProjectsFilter('sort', this.value)">
                            <option value="name" ${projectsSortBy === 'name' ? 'selected' : ''}>Name A-Z</option>
                            <option value="progress" ${projectsSortBy === 'progress' ? 'selected' : ''}>Progress %</option>
                            <option value="dueDate" ${projectsSortBy === 'dueDate' ? 'selected' : ''}>Due Date</option>
                            <option value="owner" ${projectsSortBy === 'owner' ? 'selected' : ''}>Owner</option>
                            <option value="department" ${projectsSortBy === 'department' ? 'selected' : ''}>Department</option>
                        </select>
                    </div>
                </div>
                
                <div class="projects-count">${allProjects.length} projects</div>
                
                <!-- Projects Grid -->
                <div class="projects-grid">
                    ${allProjects.length === 0 ? `
                        <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: var(--text-muted);">
                            No projects match your filters.
                        </div>
                    ` : allProjects.map(project => renderProjectCard(project)).join('')}
                </div>
            `;
        }

        function getAllProjectsFiltered() {
            let projects = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const stats = getProjectStats(project);
                    const owner = projectOwners[project.id] || project.owner || '';
                    const deptId = projectDepartments[project.id] || '';
                    const dueDate = projectDueDates[project.id];
                    const isOverdue = dueDate && new Date(dueDate) < today && stats.percentage < 100;
                    
                    projects.push({
                        ...project,
                        stats,
                        owner,
                        deptId,
                        dueDate,
                        isOverdue
                    });
                });
            });
            
            // Apply filters
            if (projectsFilterDept !== 'all') {
                projects = projects.filter(p => p.deptId === projectsFilterDept);
            }
            
            if (projectsFilterPerson !== 'all') {
                projects = projects.filter(p => p.owner === projectsFilterPerson);
            }
            
            if (projectsFilterStatus !== 'all') {
                if (projectsFilterStatus === 'completed') {
                    projects = projects.filter(p => p.stats.percentage === 100);
                } else if (projectsFilterStatus === 'inprogress') {
                    projects = projects.filter(p => p.stats.percentage > 0 && p.stats.percentage < 100);
                } else if (projectsFilterStatus === 'notstarted') {
                    projects = projects.filter(p => p.stats.percentage === 0);
                } else if (projectsFilterStatus === 'overdue') {
                    projects = projects.filter(p => p.isOverdue);
                }
            }
            
            // Apply sort
            if (projectsSortBy === 'name') {
                projects.sort((a, b) => a.title.localeCompare(b.title));
            } else if (projectsSortBy === 'progress') {
                projects.sort((a, b) => b.stats.percentage - a.stats.percentage);
            } else if (projectsSortBy === 'dueDate') {
                projects.sort((a, b) => {
                    if (!a.dueDate && !b.dueDate) return 0;
                    if (!a.dueDate) return 1;
                    if (!b.dueDate) return -1;
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });
            } else if (projectsSortBy === 'owner') {
                projects.sort((a, b) => (a.owner || 'zzz').localeCompare(b.owner || 'zzz'));
            } else if (projectsSortBy === 'department') {
                projects.sort((a, b) => {
                    const deptA = departments.find(d => d.id === a.deptId)?.name || 'zzz';
                    const deptB = departments.find(d => d.id === b.deptId)?.name || 'zzz';
                    return deptA.localeCompare(deptB);
                });
            }
            
            return projects;
        }

        function setProjectsFilter(type, value) {
            if (type === 'dept') projectsFilterDept = value;
            else if (type === 'person') projectsFilterPerson = value;
            else if (type === 'status') projectsFilterStatus = value;
            else if (type === 'sort') projectsSortBy = value;
            showAllProjectsView();
        }

        function setAnalyticsTimeFilter(filter) {
            analyticsTimeFilter = filter;
            showAnalyticsView();
        }

        function setAnalyticsViewBy(view) {
            analyticsViewBy = view;
            showAnalyticsView();
        }

        function getOverallAnalytics() {
            let completed = 0, total = 0, recentCompleted = 0;
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const tasks = getAllTasks(project);
                    tasks.forEach(task => {
                        const taskId = `${project.id}_${task.name}`;
                        total++;
                        if (completedTasks[taskId]) {
                            completed++;
                            // Simplified velocity calculation
                            recentCompleted++;
                        }
                    });
                });
            });
            
            const remaining = total - completed;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            const velocity = Math.round(recentCompleted / 4); // Approximate weekly velocity
            
            // Estimate completion date
            let estimatedCompletion = 'N/A';
            if (velocity > 0 && remaining > 0) {
                const weeksToComplete = Math.ceil(remaining / velocity);
                const completionDate = new Date(now.getTime() + weeksToComplete * 7 * 24 * 60 * 60 * 1000);
                estimatedCompletion = completionDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } else if (remaining === 0) {
                estimatedCompletion = 'Complete! 🎉';
            }
            
            // Risk assessment
            let risk = 'low';
            let riskReason = 'Good progress, on track';
            const overdueCount = getAlerts().filter(a => a.type === 'danger').length;
            
            if (overdueCount > 3 || percentage < 20) {
                risk = 'high';
                riskReason = `${overdueCount} overdue items, needs attention`;
            } else if (overdueCount > 0 || velocity < 2) {
                risk = 'medium';
                riskReason = 'Some items need attention';
            }
            
            return {
                completed,
                remaining,
                total,
                percentage,
                velocity,
                totalProjects: masterplan.phases.reduce((acc, p) => acc + p.projects.length, 0),
                estimatedCompletion,
                risk,
                riskReason
            };
        }

        function getProjectRankings() {
            const rankings = [];
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const stats = getProjectStats(project);
                    const owner = projectOwners[project.id] || project.owner || 'Unassigned';
                    const deptId = projectDepartments[project.id] || '';
                    const dept = departments.find(d => d.id === deptId);
                    
                    rankings.push({
                        id: project.id,
                        title: project.title,
                        owner,
                        deptName: dept?.name || '',
                        percentage: stats.percentage,
                        completed: stats.completed,
                        total: stats.total
                    });
                });
            });
            
            return rankings.sort((a, b) => b.percentage - a.percentage);
        }

        function getTeamLeaderboard() {
            const leaderboard = {};
            
            // Count tasks completed by each team member
            teamMembers.forEach(member => {
                leaderboard[member] = { name: member, completed: 0, projects: 0 };
            });
            
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const owner = projectOwners[project.id] || project.owner || '';
                    if (leaderboard[owner]) {
                        leaderboard[owner].projects++;
                    }
                    
                    const tasks = getAllTasks(project);
                    tasks.forEach(task => {
                        const taskId = `${project.id}_${task.name}`;
                        const taskOwner = taskOwners[taskId] || task.owner || '';
                        if (completedTasks[taskId] && leaderboard[taskOwner]) {
                            leaderboard[taskOwner].completed++;
                        }
                    });
                });
            });
            
            return Object.values(leaderboard)
                .filter(m => m.completed > 0 || m.projects > 0)
                .sort((a, b) => b.completed - a.completed);
        }

        function getDepartmentBreakdown() {
            const breakdown = {};
            let total = 0;
            
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const tasks = getAllTasks(project);
                    const projDept = projectDepartments[project.id] || '';
                    
                    tasks.forEach(task => {
                        const taskId = `${project.id}_${task.name}`;
                        const deptId = taskDepartments[taskId] || projDept || task.department || 'unassigned';
                        
                        if (!breakdown[deptId]) {
                            const dept = departments.find(d => d.id === deptId);
                            breakdown[deptId] = {
                                id: deptId,
                                name: dept?.name || 'Unassigned',
                                color: dept?.color || '#94a3b8',
                                count: 0
                            };
                        }
                        breakdown[deptId].count++;
                        total++;
                    });
                });
            });
            
            const items = Object.values(breakdown).sort((a, b) => b.count - a.count);
            
            // Build conic gradient
            let gradientParts = [];
            let currentAngle = 0;
            items.forEach(item => {
                const percentage = (item.count / total) * 100;
                const endAngle = currentAngle + (percentage * 3.6);
                gradientParts.push(`${item.color} ${currentAngle}deg ${endAngle}deg`);
                currentAngle = endAngle;
            });
            
            return {
                items,
                total,
                conicGradient: gradientParts.join(', ') || 'var(--bg-muted) 0deg 360deg'
            };
        }

        function getAlerts() {
            const alerts = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    // Check project due date
                    const projDueDate = projectDueDates[project.id];
                    if (projDueDate) {
                        const due = new Date(projDueDate);
                        const stats = getProjectStats(project);
                        
                        if (due < today && stats.percentage < 100) {
                            alerts.push({
                                type: 'danger',
                                icon: '🚨',
                                title: `${project.title} is overdue`,
                                description: `Due ${formatDate(projDueDate)} • ${stats.percentage}% complete`
                            });
                        } else if (due <= weekFromNow && stats.percentage < 100) {
                            alerts.push({
                                type: 'warning',
                                icon: '⚠️',
                                title: `${project.title} due soon`,
                                description: `Due ${formatDate(projDueDate)} • ${stats.percentage}% complete`
                            });
                        }
                    }
                    
                    // Check task due dates
                    const tasks = getAllTasks(project);
                    tasks.forEach(task => {
                        const taskId = `${project.id}_${task.name}`;
                        const dueDate = taskDueDates[taskId];
                        
                        if (dueDate && !completedTasks[taskId]) {
                            const due = new Date(dueDate);
                            if (due < today) {
                                alerts.push({
                                    type: 'danger',
                                    icon: '📋',
                                    title: `Task overdue: ${task.name}`,
                                    description: `${project.title} • Due ${formatDate(dueDate)}`
                                });
                            }
                        }
                    });
                });
            });
            
            // Sort by severity
            return alerts.sort((a, b) => {
                const order = { danger: 0, warning: 1, info: 2 };
                return order[a.type] - order[b.type];
            });
        }

        function showProjectStats() {
            if (!currentProject) return;
            
            const project = currentProject;
            const stats = getProjectStats(project);
            const tasks = getAllTasks(project);
            const owner = projectOwners[project.id] || project.owner || 'Unassigned';
            const deptId = projectDepartments[project.id] || '';
            const dept = departments.find(d => d.id === deptId);
            const dueDate = projectDueDates[project.id];
            
            // Calculate additional metrics
            const tasksWithDueDates = tasks.filter(t => taskDueDates[`${project.id}_${t.name}`]).length;
            const overdueTasks = tasks.filter(t => {
                const taskId = `${project.id}_${t.name}`;
                const due = taskDueDates[taskId];
                return due && !completedTasks[taskId] && new Date(due) < new Date();
            }).length;
            
            // Department breakdown for this project
            const deptCounts = {};
            tasks.forEach(task => {
                const taskId = `${project.id}_${task.name}`;
                const taskDept = taskDepartments[taskId] || deptId || 'unassigned';
                const d = departments.find(dep => dep.id === taskDept);
                const name = d?.name || 'Unassigned';
                deptCounts[name] = (deptCounts[name] || 0) + 1;
            });
            
            // Team workload for this project
            const teamCounts = {};
            tasks.forEach(task => {
                const taskId = `${project.id}_${task.name}`;
                const taskOwner = taskOwners[taskId] || task.owner || 'Unassigned';
                if (!teamCounts[taskOwner]) {
                    teamCounts[taskOwner] = { total: 0, completed: 0 };
                }
                teamCounts[taskOwner].total++;
                if (completedTasks[taskId]) {
                    teamCounts[taskOwner].completed++;
                }
            });
            
            // Velocity & prediction
            const completedCount = stats.completed;
            const velocity = Math.max(1, Math.round(completedCount / 4)); // tasks per week estimate
            const remainingWeeks = stats.remaining > 0 ? Math.ceil(stats.remaining / velocity) : 0;
            const estimatedDate = new Date();
            estimatedDate.setDate(estimatedDate.getDate() + remainingWeeks * 7);
            
            // Risk calculation
            let risk = 'low';
            let riskReason = 'On track';
            if (overdueTasks > 2 || (dueDate && new Date(dueDate) < new Date())) {
                risk = 'high';
                riskReason = `${overdueTasks} overdue tasks`;
            } else if (overdueTasks > 0 || stats.percentage < 25) {
                risk = 'medium';
                riskReason = 'Needs attention';
            }
            
            document.getElementById('statsModalTitle').textContent = project.title;
            document.getElementById('statsModalSubtitle').textContent = `${owner} • ${dept?.name || 'No department'}`;
            
            document.getElementById('projectStatsContent').innerHTML = `
                <!-- Key Stats -->
                <div class="stats-grid">
                    <div class="stat-box accent">
                        <div class="stat-box-value">${stats.percentage}%</div>
                        <div class="stat-box-label">Complete</div>
                    </div>
                    <div class="stat-box success">
                        <div class="stat-box-value">${stats.completed}</div>
                        <div class="stat-box-label">Tasks Done</div>
                    </div>
                    <div class="stat-box ${overdueTasks > 0 ? 'danger' : ''}">
                        <div class="stat-box-value">${overdueTasks}</div>
                        <div class="stat-box-label">Overdue</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value">${velocity}</div>
                        <div class="stat-box-label">Tasks/Week</div>
                    </div>
                </div>
                
                <!-- Department Breakdown -->
                <div class="analytics-card" style="margin-bottom: 16px;">
                    <div class="analytics-card-title" style="margin-bottom: 12px;">🏢 Tasks by Department</div>
                    ${Object.entries(deptCounts).map(([name, count]) => {
                        const d = departments.find(dep => dep.name === name);
                        const pct = Math.round((count / tasks.length) * 100);
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <div style="width: 100px; font-size: 0.85rem; color: var(--text-secondary);">${name}</div>
                                <div style="flex: 1; height: 8px; background: var(--bg-muted); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${pct}%; background: ${d?.color || 'var(--text-muted)'}; border-radius: 4px;"></div>
                                </div>
                                <div style="font-size: 0.85rem; font-weight: 600; width: 40px; text-align: right;">${count}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Team Workload -->
                <div class="analytics-card" style="margin-bottom: 16px;">
                    <div class="analytics-card-title" style="margin-bottom: 12px;">👥 Team Workload</div>
                    ${Object.entries(teamCounts).slice(0, 5).map(([name, data]) => {
                        const pct = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <div style="width: 100px; font-size: 0.85rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${name}</div>
                                <div style="flex: 1; height: 8px; background: var(--bg-muted); border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${pct}%; background: var(--success); border-radius: 4px;"></div>
                                </div>
                                <div style="font-size: 0.85rem; font-weight: 600; width: 60px; text-align: right;">${data.completed}/${data.total}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Prediction -->
                <div class="prediction-card">
                    <div class="prediction-header">
                        <span class="prediction-icon">🔮</span>
                        <span class="prediction-title">Prediction</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                        <div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">Estimated Completion</div>
                            <div class="prediction-date">
                                ${stats.percentage === 100 ? 'Complete! 🎉' : estimatedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                            </div>
                        </div>
                        <div class="risk-indicator ${risk}">
                            ${risk === 'low' ? '✓ Low Risk' : risk === 'medium' ? '⚠ Medium' : '🚨 High Risk'}
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 12px;">
                        ${riskReason} • ${stats.remaining} tasks remaining at ~${velocity} tasks/week
                    </div>
                </div>
            `;
            
            document.getElementById('projectStatsModal').classList.add('active');
        }

        function closeProjectStatsModal() {
            document.getElementById('projectStatsModal').classList.remove('active');
        }

        // ═══════════════════════════════════════
        // VIEW FUNCTIONS
        // ═══════════════════════════════════════
        function showCalendarView() {
                document.querySelector('.stats-grid').style.display = 'none';
                document.getElementById('deptFilters').style.display = 'none';
                document.querySelector('.filter-bar').style.display = 'none';
                document.querySelector('.page-title').textContent = 'Calendar View';
                document.querySelector('.page-subtitle').textContent = 'Tasks organized by due date';
                
                const container = document.getElementById('phasesContainer');
                
                container.innerHTML = `
                    <div class="calendar-controls">
                        <div class="calendar-nav">
                            <button class="btn btn-icon" onclick="navigateCalendar(-1)">←</button>
                            <span class="calendar-current-label" id="calendarLabel">This Week</span>
                            <button class="btn btn-icon" onclick="navigateCalendar(1)">→</button>
                            <button class="btn btn-sm" onclick="goToToday()">Today</button>
                        </div>
                        <div class="view-toggle">
                            <button class="view-btn active" data-cal-view="day" onclick="setCalendarView('day')">Day</button>
                            <button class="view-btn" data-cal-view="week" onclick="setCalendarView('week')">Week</button>
                            <button class="view-btn" data-cal-view="month" onclick="setCalendarView('month')">Month</button>
                        </div>
                    </div>
                    <div class="calendar-content" id="calendarContent"></div>
                `;
                
                // Initialize calendar
                window.calendarState = {
                    view: 'week',
                    currentDate: new Date()
                };
                setCalendarView('week');
            }

        function setCalendarView(view) {
                window.calendarState.view = view;
                
                // Update toggle buttons
                document.querySelectorAll('[data-cal-view]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.calView === view);
                });
                
                renderCalendarContent();
            }

        function navigateCalendar(direction) {
                const state = window.calendarState;
                const date = state.currentDate;
                
                if (state.view === 'day') {
                    date.setDate(date.getDate() + direction);
                } else if (state.view === 'week') {
                    date.setDate(date.getDate() + (direction * 7));
                } else if (state.view === 'month') {
                    date.setMonth(date.getMonth() + direction);
                }
                
                renderCalendarContent();
            }

        function goToToday() {
                window.calendarState.currentDate = new Date();
                renderCalendarContent();
            }

        function renderCalendarContent() {
                const state = window.calendarState;
                const container = document.getElementById('calendarContent');
                const label = document.getElementById('calendarLabel');
                
                if (state.view === 'day') {
                    renderDayView(container, label);
                } else if (state.view === 'week') {
                    renderWeekView(container, label);
                } else if (state.view === 'month') {
                    renderMonthView(container, label);
                }
            }

        function renderDayView(container, label) {
                const date = window.calendarState.currentDate;
                const dateStr = formatDateISO(date);
                const tasks = getTasksForDate(dateStr);
                
                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();
                
                label.textContent = isToday ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                
                container.innerHTML = `
                    <div class="day-view">
                        <div class="day-header ${isToday ? 'is-today' : ''}">
                            <div class="day-date">
                                <span class="day-number">${date.getDate()}</span>
                                <span class="day-name">${date.toLocaleDateString('en-US', { weekday: 'long' })}</span>
                            </div>
                            <div class="day-task-count">${tasks.length} task${tasks.length !== 1 ? 's' : ''}</div>
                        </div>
                        <div class="day-tasks">
                            ${tasks.length === 0 ? `
                                <div class="calendar-empty">
                                    <span>📅</span>
                                    <p>No tasks due this day</p>
                                </div>
                            ` : `
                                <div class="task-list">
                                    ${tasks.map(t => renderCalendarTask(t)).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

        function renderWeekView(container, label) {
                const date = window.calendarState.currentDate;
                const startOfWeek = getStartOfWeek(date);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);
                
                const today = new Date();
                
                label.textContent = `${startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                
                let daysHtml = '';
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek);
                    dayDate.setDate(dayDate.getDate() + i);
                    const dateStr = formatDateISO(dayDate);
                    const tasks = getTasksForDate(dateStr);
                    const isToday = dayDate.toDateString() === today.toDateString();
                    const isPast = dayDate < today && !isToday;
                    
                    daysHtml += `
                        <div class="week-day ${isToday ? 'is-today' : ''} ${isPast ? 'is-past' : ''}">
                            <div class="week-day-header">
                                <span class="week-day-name">${dayDate.toLocaleDateString('en-US', { weekday: 'short' })}</span>
                                <span class="week-day-number">${dayDate.getDate()}</span>
                            </div>
                            <div class="week-day-tasks">
                                ${tasks.length === 0 ? `
                                    <div class="week-day-empty">No tasks</div>
                                ` : tasks.slice(0, 5).map(t => `
                                    <div class="week-task ${t.isCompleted ? 'completed' : ''}" onclick="openProjectModal('${t.projectId}')">
                                        <span class="week-task-dot" style="background: ${getDeptColor(t.department)}"></span>
                                        <span class="week-task-name">${truncate(t.name, 25)}</span>
                                    </div>
                                `).join('')}
                                ${tasks.length > 5 ? `<div class="week-task-more">+${tasks.length - 5} more</div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = `<div class="week-view">${daysHtml}</div>`;
            }

        function renderMonthView(container, label) {
                const date = window.calendarState.currentDate;
                const year = date.getFullYear();
                const month = date.getMonth();
                const today = new Date();
                
                label.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDay = firstDay.getDay(); // 0 = Sunday
                const totalDays = lastDay.getDate();
                
                // Get all tasks for the month
                const monthTasks = {};
                for (let d = 1; d <= totalDays; d++) {
                    const dateStr = formatDateISO(new Date(year, month, d));
                    monthTasks[d] = getTasksForDate(dateStr);
                }
                
                let weeksHtml = '';
                let dayCount = 1;
                
                // Header row
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                let headerHtml = dayNames.map(d => `<div class="month-header-day">${d}</div>`).join('');
                
                // Calendar grid
                for (let week = 0; week < 6; week++) {
                    if (dayCount > totalDays) break;
                    
                    let daysHtml = '';
                    for (let day = 0; day < 7; day++) {
                        if ((week === 0 && day < startDay) || dayCount > totalDays) {
                            daysHtml += `<div class="month-day empty"></div>`;
                        } else {
                            const currentDayNum = dayCount;
                            const dayDate = new Date(year, month, currentDayNum);
                            const isToday = dayDate.toDateString() === today.toDateString();
                            const isPast = dayDate < today && !isToday;
                            const tasks = monthTasks[currentDayNum] || [];
                            const hasOverdue = tasks.some(t => !t.isCompleted && isPast);
                            
                            daysHtml += `
                                <div class="month-day ${isToday ? 'is-today' : ''} ${isPast ? 'is-past' : ''} ${hasOverdue ? 'has-overdue' : ''}" 
                                     onclick="jumpToDay(${year}, ${month}, ${currentDayNum})">
                                    <div class="month-day-number">${currentDayNum}</div>
                                    <div class="month-day-tasks">
                                        ${tasks.slice(0, 3).map(t => `
                                            <div class="month-task ${t.isCompleted ? 'completed' : ''}" style="border-left-color: ${getDeptColor(t.department)}">
                                                ${truncate(t.name, 15)}
                                            </div>
                                        `).join('')}
                                        ${tasks.length > 3 ? `<div class="month-task-more">+${tasks.length - 3}</div>` : ''}
                                    </div>
                                </div>
                            `;
                            dayCount++;
                        }
                    }
                    weeksHtml += `<div class="month-week">${daysHtml}</div>`;
                }
                
                container.innerHTML = `
                    <div class="month-view">
                        <div class="month-header">${headerHtml}</div>
                        <div class="month-grid">${weeksHtml}</div>
                    </div>
                `;
            }

        function jumpToDay(year, month, day) {
                window.calendarState.currentDate = new Date(year, month, day);
                setCalendarView('day');
            }

        function getStartOfWeek(date) {
                const d = new Date(date);
                const day = d.getDay();
                d.setDate(d.getDate() - day);
                d.setHours(0, 0, 0, 0);
                return d;
            }

        function formatDateISO(date) {
                return date.toISOString().split('T')[0];
            }

        function getTasksForDate(dateStr) {
                const tasks = [];
                masterplan.phases.forEach(phase => {
                    phase.projects.forEach(project => {
                        getAllTasks(project).forEach(task => {
                            const taskId = `${project.id}_${task.name}`;
                            if (taskDueDates[taskId] === dateStr) {
                                tasks.push({
                                    ...task,
                                    taskId,
                                    projectId: project.id,
                                    projectTitle: project.title,
                                    isCompleted: completedTasks[taskId],
                                    department: taskDepartments[taskId] || task.department
                                });
                            }
                        });
                    });
                });
                return tasks;
            }

        function getDeptColor(deptId) {
                const dept = departments.find(d => d.id === deptId);
                return dept ? dept.color : '#94a3b8';
            }

        function truncate(str, len) {
                return str.length > len ? str.substring(0, len) + '...' : str;
            }

        function showIssuesView() {
                document.querySelector('.stats-grid').style.display = 'none';
                document.getElementById('deptFilters').style.display = 'none';
                document.querySelector('.filter-bar').style.display = 'none';
                document.querySelector('.page-title').textContent = 'Issue Log';
                document.querySelector('.page-subtitle').textContent = 'Track and resolve project issues';
                
                const container = document.getElementById('phasesContainer');
                
                // Get all issues
                const allIssues = [];
                Object.values(projectIssues).forEach(issues => {
                    allIssues.push(...issues);
                });
                allIssues.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                const openIssues = allIssues.filter(i => i.status === 'open');
                const closedIssues = allIssues.filter(i => i.status === 'closed');
                
                if (allIssues.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 16px;">🐛</div>
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">No issues logged</div>
                            <div style="margin-bottom: 24px;">Report issues from project detail modals</div>
                            <button class="btn btn-primary" onclick="document.querySelector('[data-view=dashboard]').click()">Back to Dashboard</button>
                        </div>
                    `;
                    return;
                }
                
                const priorityIcons = { low: '🟢', medium: '🟡', high: '🟠', critical: '🔴' };
                const typeIcons = { bug: '🐛', feature: '✨', improvement: '💡', question: '❓' };
                
                container.innerHTML = `
                    <div class="issues-summary">
                        <div class="issue-stat open">
                            <div class="issue-stat-value">${openIssues.length}</div>
                            <div class="issue-stat-label">Open</div>
                        </div>
                        <div class="issue-stat closed">
                            <div class="issue-stat-value">${closedIssues.length}</div>
                            <div class="issue-stat-label">Closed</div>
                        </div>
                    </div>
                    
                    <div class="issues-list">
                        ${allIssues.map(issue => `
                            <div class="issue-card ${issue.status}">
                                <div class="issue-card-header">
                                    <span class="issue-type">${typeIcons[issue.type] || '🐛'}</span>
                                    <span class="issue-title">${issue.title}</span>
                                    <span class="issue-priority ${issue.priority}">${priorityIcons[issue.priority]}</span>
                                </div>
                                <div class="issue-card-meta">
                                    <span>📁 ${issue.projectTitle}</span>
                                    <span>📅 ${new Date(issue.createdAt).toLocaleDateString()}</span>
                                    <span class="issue-status-badge ${issue.status}">${issue.status}</span>
                                </div>
                                ${issue.description ? `<div class="issue-description">${issue.description}</div>` : ''}
                                <div class="issue-actions">
                                    ${issue.status === 'open' ? `
                                        <button class="btn btn-sm btn-primary" onclick="closeIssue('${issue.id}', '${issue.projectId}')">✓ Close Issue</button>
                                    ` : `
                                        <button class="btn btn-sm" onclick="reopenIssue('${issue.id}', '${issue.projectId}')">↩ Reopen</button>
                                    `}
                                    <button class="btn btn-sm" onclick="deleteIssue('${issue.id}', '${issue.projectId}')">🗑 Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

        function closeIssue(issueId, projectId) {
            if (!projectIssues[projectId]) return;
            const issue = projectIssues[projectId].find(i => i.id === issueId);
            if (issue) {
                issue.status = 'closed';
                issue.closedAt = new Date().toISOString();
                localStorage.setItem('projectIssues', JSON.stringify(projectIssues));
                updateIssueCount();
                showIssuesView();
                showToast('✅ Issue closed');
            }
        }

        function reopenIssue(issueId, projectId) {
            if (!projectIssues[projectId]) return;
            const issue = projectIssues[projectId].find(i => i.id === issueId);
            if (issue) {
                issue.status = 'open';
                delete issue.closedAt;
                localStorage.setItem('projectIssues', JSON.stringify(projectIssues));
                updateIssueCount();
                showIssuesView();
                showToast('↩ Issue reopened');
            }
        }

        function deleteIssue(issueId, projectId) {
            if (!confirm('Delete this issue?')) return;
            if (!projectIssues[projectId]) return;
            projectIssues[projectId] = projectIssues[projectId].filter(i => i.id !== issueId);
            localStorage.setItem('projectIssues', JSON.stringify(projectIssues));
            updateIssueCount();
            showIssuesView();
            showToast('🗑 Issue deleted');
        }

        function showTeamView() {
                document.querySelector('.stats-grid').style.display = 'none';
                document.getElementById('deptFilters').style.display = 'none';
                document.querySelector('.filter-bar').style.display = 'none';
                document.querySelector('.page-title').textContent = 'Team Overview';
                document.querySelector('.page-subtitle').textContent = 'Department workload and team members';
                
                const container = document.getElementById('phasesContainer');
                const deptStats = getDepartmentStats();
                const ownerStats = getOwnerStats();
                
                container.innerHTML = `
                    <!-- Team Members Section -->
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                            👥 Team Members
                            <span style="font-size: 0.85rem; font-weight: 500; color: var(--text-muted);">(${teamMembers.length})</span>
                        </h3>
                        <div class="team-members-grid">
                            ${teamMembers.map(member => {
                                const stats = ownerStats[member] || { projects: 0, tasks: 0, completed: 0 };
                                return `
                                    <div class="team-member-card">
                                        <div class="team-member-avatar">${member.charAt(0).toUpperCase()}</div>
                                        <div class="team-member-info">
                                            <div class="team-member-name">${member}</div>
                                            <div class="team-member-stats">
                                                ${stats.projects} projects · ${stats.tasks} tasks · ${stats.completed} done
                                            </div>
                                        </div>
                                        <button class="btn btn-icon btn-sm" onclick="event.stopPropagation(); removeTeamMember('${member}')" title="Remove">×</button>
                                    </div>
                                `;
                            }).join('')}
                            <div class="team-member-add">
                                <input type="text" id="newMemberInput" class="input" placeholder="Add team member..." style="flex: 1;" onkeydown="if(event.key==='Enter')addTeamMember()">
                                <button class="btn btn-primary" onclick="addTeamMember()">Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Department Stats Section -->
                    <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 16px;">🏢 Departments</h3>
                    <div class="team-grid">
                        ${departments.map(dept => {
                            const stats = deptStats[dept.id] || { total: 0, completed: 0 };
                            const percentage = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
                            return `
                                <div class="stat-card" style="cursor: pointer;" onclick="filterByDepartment('${dept.id}'); document.querySelector('[data-view=dashboard]').click();">
                                    <div class="stat-label" style="color: ${dept.color};">${dept.icon} ${dept.name}</div>
                                    <div class="stat-value">${stats.total}</div>
                                    <div class="stat-progress">
                                        <div class="stat-progress-fill" style="width: ${percentage}%; background: ${dept.color};"></div>
                                    </div>
                                    <div class="stat-detail">${stats.completed} completed (${percentage}%)</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

        function addTeamMember() {
                const input = document.getElementById('newMemberInput');
                const name = input.value.trim();
                if (!name) return;
                if (teamMembers.includes(name)) {
                    showToast('Team member already exists', true);
                    return;
                }
                teamMembers.push(name);
                localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
                input.value = '';
                showTeamView();
                showToast(`👤 Added ${name} to team`);
            }

        function removeTeamMember(name) {
                if (!confirm(`Remove ${name} from the team?`)) return;
                teamMembers = teamMembers.filter(m => m !== name);
                localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
                showTeamView();
                showToast(`👤 Removed ${name} from team`);
            }

        function getOwnerStats() {
                const stats = {};
                masterplan.phases.forEach(phase => {
                    phase.projects.forEach(project => {
                        const owner = projectOwners[project.id] || project.owner || '';
                        if (owner) {
                            if (!stats[owner]) stats[owner] = { projects: 0, tasks: 0, completed: 0 };
                            stats[owner].projects++;
                        }
                        
                        const tasks = getAllTasks(project);
                        tasks.forEach(task => {
                            const taskId = `${project.id}_${task.name}`;
                            const taskOwner = taskOwners[taskId] || task.owner || '';
                            if (taskOwner && stats[taskOwner]) {
                                stats[taskOwner].tasks++;
                                if (completedTasks[taskId]) stats[taskOwner].completed++;
                            }
                        });
                    });
                });
                return stats;
            }

        // ═══════════════════════════════════════
        // MY TASKS VIEW
        // ═══════════════════════════════════════
        function showMyTasksView() {
            document.querySelector('.stats-grid').style.display = 'none';
            document.getElementById('deptFilters').style.display = 'none';
            document.getElementById('filterBar').style.display = 'none';
            document.querySelector('.page-title').textContent = 'My Tasks';
            document.querySelector('.page-subtitle').textContent = 'Tasks assigned to you';
            
            const container = document.getElementById('phasesContainer');
            
            if (!currentUserData) {
                container.innerHTML = '<div style="text-align:center;padding:60px;color:var(--text-muted);">Please sign in to see your tasks.</div>';
                return;
            }
            
            // Find all tasks assigned to current user
            let myTasks = [];
            const userEmail = currentUserData.email?.toLowerCase();
            const userName = currentUserData.displayName;
            
            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const allTasks = getAllTasks(project);
                    allTasks.forEach(task => {
                        const taskOwner = (task.owner || '').toLowerCase();
                        const isMyTask = taskOwner === userEmail || 
                                        taskOwner === userName?.toLowerCase() ||
                                        task.owner === userName;
                        
                        if (isMyTask) {
                            const taskKey = `${project.id}_${task.name}`;
                            myTasks.push({
                                ...task,
                                projectId: project.id,
                                projectTitle: project.title,
                                phaseName: phase.name,
                                completed: completedTasks[taskKey] || taskCompletions[taskKey]
                            });
                        }
                    });
                });
            });
            
            // Sort: incomplete first, then by project
            myTasks.sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                return a.projectTitle.localeCompare(b.projectTitle);
            });
            
            const pending = myTasks.filter(t => !t.completed).length;
            const completed = myTasks.filter(t => t.completed).length;
            
            container.innerHTML = `
                <div class="stats-grid" style="display: grid; margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-label">📋 Total Assigned</div>
                        <div class="stat-value">${myTasks.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">⏳ Pending</div>
                        <div class="stat-value" style="color: var(--warning);">${pending}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">✅ Completed</div>
                        <div class="stat-value" style="color: var(--success);">${completed}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">📊 Progress</div>
                        <div class="stat-value">${myTasks.length > 0 ? Math.round((completed / myTasks.length) * 100) : 0}%</div>
                    </div>
                </div>
                
                <div class="phase-section">
                    <div class="phase-header">
                        <h2 class="phase-title">📝 My Task List</h2>
                    </div>
                    <div class="projects-list" style="padding: 16px;">
                        ${myTasks.length === 0 ? `
                            <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                                <div style="font-size: 3rem; margin-bottom: 16px;">🎉</div>
                                <h3>No tasks assigned to you</h3>
                                <p>Tasks will appear here when they're assigned to you.</p>
                            </div>
                        ` : myTasks.map(task => `
                            <div class="task-item" style="display: flex; align-items: center; gap: 14px; padding: 14px 16px; border: 1px solid var(--border-light); border-radius: var(--radius); margin-bottom: 10px; ${task.completed ? 'opacity: 0.7;' : ''}">
                                <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                                     onclick="toggleTask('${task.projectId}', '${escapeHtml(task.name)}'); setTimeout(showMyTasksView, 100);"
                                     style="width: 24px; height: 24px; border: 2px solid ${task.completed ? 'var(--success)' : 'var(--border)'}; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; ${task.completed ? 'background: var(--success); color: white;' : ''}">
                                    ${task.completed ? '✓' : ''}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; ${task.completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${task.name}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">${task.projectTitle}</div>
                                </div>
                                <button class="btn btn-sm" onclick="openProjectModal('${task.projectId}')">View Project</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ═══════════════════════════════════════
        // USERS MANAGEMENT VIEW (Admin Only)
        // ═══════════════════════════════════════
        function showUsersView() {
            if (currentUserData?.role !== 'admin') {
                showToast('Admin access required', true);
                return;
            }
            
            document.querySelector('.stats-grid').style.display = 'none';
            document.getElementById('deptFilters').style.display = 'none';
            document.getElementById('filterBar').style.display = 'none';
            document.querySelector('.page-title').textContent = 'Manage Users';
            document.querySelector('.page-subtitle').textContent = 'Add and manage authorized users';
            
            const container = document.getElementById('phasesContainer');
            
            container.innerHTML = `
                <div class="admin-section">
                    <div class="admin-section-header">
                        <h3 class="admin-section-title">👥 Authorized Users (${allAuthorizedUsers.length})</h3>
                        <button class="btn btn-primary" onclick="openAddUserModal()">+ Add User</button>
                    </div>
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allAuthorizedUsers.map(user => {
                                const roleInfo = userRoles[user.role] || userRoles.employee;
                                const dept = departments.find(d => d.id === user.department);
                                return `
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                ${user.photoURL 
                                                    ? `<img src="${user.photoURL}" class="user-table-avatar">`
                                                    : `<div class="user-table-avatar-placeholder">${(user.displayName || user.email).slice(0,2).toUpperCase()}</div>`
                                                }
                                                <span>${user.displayName || '-'}</span>
                                            </div>
                                        </td>
                                        <td>${user.email}</td>
                                        <td><span class="role-badge ${user.role}">${roleInfo.icon} ${roleInfo.name}</span></td>
                                        <td>${dept ? `${dept.icon} ${dept.name}` : '-'}</td>
                                        <td>
                                            <span class="status-dot ${user.lastLogin ? 'online' : 'offline'}"></span>
                                            ${user.lastLogin ? 'Active' : 'Pending'}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm" onclick="editUserModal('${user.email}')">Edit</button>
                                            ${user.email !== currentUser?.email ? `
                                                <button class="btn btn-sm" onclick="removeUserConfirm('${user.email}')" style="color: var(--danger);">Remove</button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function openAddUserModal() {
            const modal = document.createElement('div');
            modal.id = 'addUserModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">Add New User</h2>
                            <p class="modal-description">Add a user to the authorized list</p>
                        </div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" id="newUserEmail" class="input" placeholder="user@company.com">
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 6px;">
                                User must sign in with this Google account
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Display Name</label>
                            <input type="text" id="newUserName" class="input" placeholder="John Smith">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Role *</label>
                                <select id="newUserRole" class="select">
                                    <option value="employee">Employee</option>
                                    <option value="manager">Manager</option>
                                    <option value="admin">Admin</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Department</label>
                                <select id="newUserDept" class="select">
                                    <option value="">Select...</option>
                                    ${departments.map(d => `<option value="${d.id}">${d.icon} ${d.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="addUserToFirebase()">Add User</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addUserToFirebase() {
            if (!db) {
                showToast('Firebase not configured', true);
                return;
            }
            
            const email = document.getElementById('newUserEmail').value.trim().toLowerCase();
            const name = document.getElementById('newUserName').value.trim();
            const role = document.getElementById('newUserRole').value;
            const dept = document.getElementById('newUserDept').value;

            if (!email || !email.includes('@')) {
                showToast('Please enter a valid email', true);
                return;
            }

            try {
                await db.collection('users').doc(email).set({
                    displayName: name || null,
                    role: role,
                    department: dept || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.email
                });

                showToast('User added successfully! ✅');
                document.getElementById('addUserModal')?.remove();
                
                // Refresh users list
                const snapshot = await db.collection('users').get();
                allAuthorizedUsers = [];
                snapshot.forEach(doc => {
                    allAuthorizedUsers.push({ email: doc.id, ...doc.data() });
                });
                showUsersView();
            } catch (err) {
                showToast('Failed to add user: ' + err.message, true);
            }
        }

        function editUserModal(email) {
            const user = allAuthorizedUsers.find(u => u.email === email);
            if (!user) return;

            const modal = document.createElement('div');
            modal.id = 'editUserModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">Edit User</h2>
                            <p class="modal-description">${email}</p>
                        </div>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Display Name</label>
                            <input type="text" id="editUserName" class="input" value="${user.displayName || ''}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select id="editUserRole" class="select">
                                    ${Object.entries(userRoles).map(([key, val]) => 
                                        `<option value="${key}" ${user.role === key ? 'selected' : ''}>${val.icon} ${val.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Department</label>
                                <select id="editUserDept" class="select">
                                    <option value="">Select...</option>
                                    ${departments.map(d => 
                                        `<option value="${d.id}" ${user.department === d.id ? 'selected' : ''}>${d.icon} ${d.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveUserEdit('${email}')">Save Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveUserEdit(email) {
            if (!db) return;
            
            const name = document.getElementById('editUserName').value.trim();
            const role = document.getElementById('editUserRole').value;
            const dept = document.getElementById('editUserDept').value;

            try {
                await db.collection('users').doc(email).update({
                    displayName: name || null,
                    role: role,
                    department: dept || null
                });

                showToast('User updated! ✅');
                document.getElementById('editUserModal')?.remove();
                
                // Refresh
                const snapshot = await db.collection('users').get();
                allAuthorizedUsers = [];
                snapshot.forEach(doc => {
                    allAuthorizedUsers.push({ email: doc.id, ...doc.data() });
                });
                showUsersView();
                
                // If editing self, update UI
                if (email === currentUser?.email) {
                    currentUserData.role = role;
                    currentUserData.department = dept;
                    currentUserData.displayName = name;
                    updateUserUI();
                    applyRolePermissions();
                }
            } catch (err) {
                showToast('Failed to update: ' + err.message, true);
            }
        }

        async function removeUserConfirm(email) {
            if (!confirm(`Remove ${email} from the system? They will no longer be able to access the app.`)) {
                return;
            }

            try {
                await db.collection('users').doc(email).delete();
                showToast('User removed');
                
                // Refresh
                const snapshot = await db.collection('users').get();
                allAuthorizedUsers = [];
                snapshot.forEach(doc => {
                    allAuthorizedUsers.push({ email: doc.id, ...doc.data() });
                });
                showUsersView();
            } catch (err) {
                showToast('Failed to remove: ' + err.message, true);
            }
        }

        function showSettingsView() {
                document.querySelector('.stats-grid').style.display = 'none';
                document.getElementById('deptFilters').style.display = 'none';
                document.querySelector('.filter-bar').style.display = 'none';
                document.querySelector('.page-title').textContent = 'Settings';
                document.querySelector('.page-subtitle').textContent = 'Manage your tracker preferences';
                
                const container = document.getElementById('phasesContainer');
                container.innerHTML = `
                    <div class="settings-panel" style="max-width: 800px;">
                        
                        <!-- Department Management -->
                        <div class="stat-card" style="margin-bottom: 20px;">
                            <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 16px;">🏢 Department Management</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">Manage departments and assign department leads.</p>
                            
                            <div class="dept-settings-list">
                                ${departments.map((dept, idx) => `
                                    <div class="dept-settings-item" data-dept-id="${dept.id}">
                                        <div class="dept-settings-preview" style="background: ${dept.color}20; color: ${dept.color}; border: 1px solid ${dept.color}40;">
                                            <span class="dept-settings-icon">${dept.icon}</span>
                                        </div>
                                        <div class="dept-settings-info">
                                            <input type="text" class="dept-name-input" value="${dept.name}" 
                                                   onchange="updateDepartment('${dept.id}', 'name', this.value)" 
                                                   placeholder="Department name">
                                            <div class="dept-settings-lead">
                                                <span style="font-size: 0.8rem; color: var(--text-muted);">Lead:</span>
                                                <select class="select dept-lead-select" onchange="setDepartmentLead('${dept.id}', this.value)">
                                                    <option value="">No Lead Assigned</option>
                                                    ${teamMembers.map(m => `<option value="${m}" ${departmentLeads[dept.id] === m ? 'selected' : ''}>${m}</option>`).join('')}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="dept-settings-actions">
                                            <input type="text" class="dept-icon-input" value="${dept.icon}" 
                                                   onchange="updateDepartment('${dept.id}', 'icon', this.value)"
                                                   title="Emoji icon" maxlength="2">
                                            <input type="color" class="dept-color-input" value="${dept.color}" 
                                                   onchange="updateDepartment('${dept.id}', 'color', this.value)"
                                                   title="Department color">
                                            <button class="btn btn-icon btn-sm" onclick="deleteDepartment('${dept.id}')" title="Delete department">🗑</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="dept-add-form">
                                <input type="text" id="newDeptIcon" class="dept-icon-input" placeholder="📁" maxlength="2" value="📁">
                                <input type="text" id="newDeptName" class="input" placeholder="New department name..." style="flex: 1;">
                                <input type="color" id="newDeptColor" class="dept-color-input" value="#6366f1">
                                <button class="btn btn-primary" onclick="addDepartment()">+ Add</button>
                            </div>
                            
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light);">
                                <button class="btn btn-sm" onclick="resetDepartments()">Reset to Defaults</button>
                            </div>
                        </div>
                        
                        <!-- Export/Import -->
                        <div class="stat-card" style="margin-bottom: 20px;">
                            <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 16px;">📤 Export & Backup</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">Download your progress data as a JSON file for backup or transfer.</p>
                            <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                        </div>
                        
                        <div class="stat-card" style="margin-bottom: 20px;">
                            <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 16px;">📥 Import Data</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">Restore from a previously exported backup file.</p>
                            <button class="btn" onclick="document.getElementById('importInput').click()">Import Backup</button>
                        </div>
                        
                        <div class="stat-card" style="margin-bottom: 20px;">
                            <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 16px;">🗑️ Reset Data</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">Clear all progress and start fresh. This cannot be undone!</p>
                            <button class="btn btn-danger" onclick="resetAllData()">Reset Everything</button>
                        </div>
                        
                        <div class="stat-card">
                            <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 16px;">📊 Statistics</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; color: var(--text-secondary);">
                                <div>Total Projects: <strong style="color: var(--text);">${getTotalProjects()}</strong></div>
                                <div>Total Tasks: <strong style="color: var(--text);">${getTotalTasks()}</strong></div>
                                <div>Completed: <strong style="color: var(--success);">${Object.values(completedTasks).filter(v => v).length}</strong></div>
                                <div>With Due Dates: <strong style="color: var(--text);">${Object.keys(taskDueDates).length}</strong></div>
                            </div>
                        </div>
                    </div>
                `;
            }

        function updateDepartment(deptId, field, value) {
            const dept = departments.find(d => d.id === deptId);
            if (dept) {
                dept[field] = value;
                localStorage.setItem('departments', JSON.stringify(departments));
                showSettingsView(); // Refresh to update preview
                renderDepartmentFilters();
                showToast(`🏢 Department updated`);
            }
        }

        function setDepartmentLead(deptId, leadName) {
            if (leadName) {
                departmentLeads[deptId] = leadName;
            } else {
                delete departmentLeads[deptId];
            }
            localStorage.setItem('departmentLeads', JSON.stringify(departmentLeads));
            showToast(leadName ? `👤 ${leadName} set as lead` : '👤 Lead removed');
        }

        function addDepartment() {
            const icon = document.getElementById('newDeptIcon').value.trim() || '📁';
            const name = document.getElementById('newDeptName').value.trim();
            const color = document.getElementById('newDeptColor').value;
            
            if (!name) {
                showToast('Please enter a department name', true);
                return;
            }
            
            // Generate unique ID
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
            
            departments.push({ id, name, icon, color });
            localStorage.setItem('departments', JSON.stringify(departments));
            
            document.getElementById('newDeptName').value = '';
            showSettingsView();
            renderDepartmentFilters();
            showToast(`🏢 Added ${name} department`);
        }

        function deleteDepartment(deptId) {
            const dept = departments.find(d => d.id === deptId);
            if (!dept) return;
            
            if (!confirm(`Delete "${dept.name}" department? Tasks assigned to this department will become unassigned.`)) return;
            
            departments = departments.filter(d => d.id !== deptId);
            delete departmentLeads[deptId];
            
            localStorage.setItem('departments', JSON.stringify(departments));
            localStorage.setItem('departmentLeads', JSON.stringify(departmentLeads));
            
            showSettingsView();
            renderDepartmentFilters();
            showToast(`🗑️ Deleted ${dept.name} department`);
        }

        function resetDepartments() {
            if (!confirm('Reset all departments to defaults? This will remove any custom departments.')) return;
            
            departments = [...defaultDepartments];
            departmentLeads = {};
            
            localStorage.setItem('departments', JSON.stringify(departments));
            localStorage.setItem('departmentLeads', JSON.stringify(departmentLeads));
            
            showSettingsView();
            renderDepartmentFilters();
            showToast('🏢 Departments reset to defaults');
        }

        function renderCalendarTask(task) {
                const dept = departments.find(d => d.id === task.department);
                const dueDateClass = getDueDateClass(task.taskId);
                return `
                    <div class="task-item ${task.isCompleted ? 'completed' : ''}" onclick="openProjectModal('${task.projectId}')">
                        <div class="task-checkbox ${task.isCompleted ? 'checked' : ''}">
                            ${task.isCompleted ? '✓' : ''}
                        </div>
                        <div class="task-content">
                            <div class="task-name">${task.name}</div>
                            <div class="task-meta">
                                <span class="task-badge">${task.projectTitle}</span>
                                ${dept ? `<span class="dept-badge" style="background: ${dept.color}15; color: ${dept.color}; border: 1px solid ${dept.color}40;">${dept.icon} ${dept.name}</span>` : ''}
                                ${dueDateClass ? `<span class="task-badge ${dueDateClass}">${dueDateClass === 'overdue' ? 'Overdue' : 'Due Soon'}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

        function getDepartmentStats() {
                const stats = {};
                masterplan.phases.forEach(phase => {
                    phase.projects.forEach(project => {
                        const tasks = getAllTasks(project);
                        tasks.forEach(task => {
                            const taskId = `${project.id}_${task.name}`;
                            const dept = taskDepartments[taskId] || task.department;
                            if (dept) {
                                if (!stats[dept]) stats[dept] = { total: 0, completed: 0 };
                                stats[dept].total++;
                                if (completedTasks[taskId]) stats[dept].completed++;
                            }
                        });
                    });
                });
                return stats;
            }

        function getTotalProjects() {
                return masterplan.phases.reduce((acc, p) => acc + p.projects.length, 0);
            }

        function getTotalTasks() {
                let count = 0;
                masterplan.phases.forEach(phase => {
                    phase.projects.forEach(project => {
                        count += getAllTasks(project).length;
                    });
                });
                return count;
            }

        function formatDateLong(dateStr) {
                const date = new Date(dateStr);
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                if (date.toDateString() === today.toDateString()) return '📅 Today';
                if (date.toDateString() === tomorrow.toDateString()) return '📅 Tomorrow';
                
                return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            }

        function resetAllData() {
                if (!confirm('⚠️ This will delete ALL your progress. Are you sure?')) return;
                if (!confirm('⚠️ This CANNOT be undone. Export a backup first if needed. Continue?')) return;
                
                localStorage.removeItem('completedTasks');
                localStorage.removeItem('taskOwners');
                localStorage.removeItem('taskDueDates');
                localStorage.removeItem('taskDepartments');
                localStorage.removeItem('projectDepartments');
                localStorage.removeItem('projectOwners');
                localStorage.removeItem('projectDueDates');
                localStorage.removeItem('teamMembers');
                localStorage.removeItem('departments');
                localStorage.removeItem('departmentLeads');
                localStorage.removeItem('customTasks');
                
                completedTasks = {};
                taskOwners = {};
                taskDueDates = {};
                taskDepartments = {};
                projectDepartments = {};
                projectOwners = {};
                projectDueDates = {};
                teamMembers = ['Craig', 'Mike', 'Sarah', 'John', 'Lisa', 'David', 'Emma', 'Chris'];
                departments = [...defaultDepartments];
                departmentLeads = {};
                customTasks = {};
                
                document.querySelector('[data-view="dashboard"]').click();
                renderDepartmentFilters();
                renderPhases();
                updateStats();
                showToast('🗑️ All data has been reset');
        }

        // ═══════════════════════════════════════
        // RENDERING
        // ═══════════════════════════════════════
        function renderPhases() {
            const container = document.getElementById('phasesContainer');
            container.innerHTML = masterplan.phases.map(phase => {
                const phaseStats = getPhaseStats(phase);
                return `
                    <section class="phase-section">
                        <div class="phase-header">
                            <div class="phase-icon">${phase.icon}</div>
                            <div class="phase-info">
                                <h2>${phase.name}</h2>
                                <div class="phase-meta">
                                    <span>📁 ${phase.projects.length} projects</span>
                                    <span>✅ ${phaseStats.completed}/${phaseStats.total} tasks</span>
                                    <span>📈 ${phaseStats.percentage}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="projects-grid">
                            ${phase.projects.map(project => renderProjectCard(project)).join('')}
                        </div>
                    </section>
                `;
            }).join('');
        }

        function renderProjectCard(project) {
            const stats = getProjectStats(project);
            const projDept = projectDepartments[project.id] || project.department || '';
            const dept = departments.find(d => d.id === projDept);
            const owner = projectOwners[project.id] || project.owner || 'Unassigned';
            const dueDate = projectDueDates[project.id] || '';
            const dueDateClass = getProjectDueDateClass(project.id);
            
            return `
                <div class="project-card" onclick="openProjectModal('${project.id}')" data-project-dept="${projDept}">
                    <div class="project-header">
                        <h3 class="project-title">${project.title}</h3>
                        <span class="priority-badge priority-${project.priority}">${project.priority}</span>
                    </div>
                    <div class="project-meta-row">
                        <div class="project-owner">
                            <span>👤</span> ${owner}
                        </div>
                        ${dept ? `<span class="dept-badge" style="background: ${dept.color}15; color: ${dept.color}; border: 1px solid ${dept.color}40;">${dept.icon} ${dept.name}</span>` : ''}
                        ${dueDate ? `<span class="task-badge ${dueDateClass}" style="margin-left: auto;">📅 ${formatDate(dueDate)}</span>` : ''}
                    </div>
                    <div class="project-progress">
                        <div class="progress-header">
                            <span class="progress-label">Progress</span>
                            <span class="progress-value">${stats.percentage}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stats.percentage}%"></div>
                        </div>
                    </div>
                    <div class="project-footer">
                        <div class="project-stats">
                            <span class="project-stat">✅ ${stats.completed} done</span>
                            <span class="project-stat">📋 ${stats.remaining} left</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModalTasks(project) {
            const tasks = getAllTasks(project);
            const projDept = projectDepartments[project.id] || '';
            
            return tasks.map(task => {
                const taskId = `${project.id}_${task.name}`;
                const isCompleted = completedTasks[taskId];
                const dueDate = taskDueDates[taskId];
                const dueDateClass = getDueDateClass(taskId);
                // Use task department if set, otherwise inherit from project
                const taskDept = taskDepartments[taskId] || projDept || task.department || '';
                const dept = departments.find(d => d.id === taskDept);
                const isInherited = !taskDepartments[taskId] && projDept;
                
                return `
                    <div class="task-item ${isCompleted ? 'completed' : ''}" data-department="${taskDept}">
                        <div class="task-checkbox ${isCompleted ? 'checked' : ''}" 
                             onclick="toggleTask('${project.id}', '${escapeHtml(task.name)}')">
                            ${isCompleted ? '✓' : ''}
                        </div>
                        <div class="task-content">
                            <div class="task-name">${task.name}</div>
                            <div class="task-meta">
                                <span class="task-badge">${task.owner}</span>
                                ${dept ? `<span class="dept-badge ${isInherited ? 'inherited' : ''}" style="background: ${dept.color}15; color: ${dept.color}; border: 1px solid ${dept.color}40;" title="${isInherited ? 'Inherited from project' : 'Task-specific'}">${dept.icon} ${dept.name}${isInherited ? ' ↩' : ''}</span>` : ''}
                                ${dueDate ? `<span class="task-badge ${dueDateClass}">${formatDate(dueDate)}</span>` : ''}
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="how-to-btn" onclick="event.stopPropagation(); showHowTo('${escapeHtml(task.name)}', '${project.id}')" title="Get step-by-step instructions">
                                💡 How To
                            </button>
                            <select class="dept-select" onchange="setTaskDepartment('${taskId}', this.value)" title="Assign Department (overrides project default)">
                                <option value="" ${!taskDepartments[taskId] ? 'selected' : ''}>${projDept ? '↩ Use Project Dept' : 'No Dept'}</option>
                                ${departments.map(d => `<option value="${d.id}" ${taskDepartments[taskId] === d.id ? 'selected' : ''}>${d.icon} ${d.name}</option>`).join('')}
                            </select>
                            <input type="date" class="task-badge" value="${dueDate || ''}" 
                                   onchange="setDueDate('${taskId}', this.value)" 
                                   style="cursor: pointer; min-width: 130px;" title="Set Due Date">
                            ${task.isCustom ? `
                                <button class="task-action-btn danger" onclick="deleteCustomTask('${project.id}', '${escapeHtml(task.name)}')" title="Delete Task">🗑</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ═══════════════════════════════════════
        // TASK OPERATIONS
        // ═══════════════════════════════════════
        function toggleTask(projectId, taskName) {
            // Check viewer permissions
            if (currentUserData?.role === 'viewer') {
                showToast('Viewers cannot modify tasks', true);
                return;
            }

            const taskId = `${projectId}_${taskName}`;
            const newState = !completedTasks[taskId];
            completedTasks[taskId] = newState;
            localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
            
            // Sync with Firebase if available
            if (db && isFirebaseConfigured) {
                syncTaskCompletion(taskId, newState);
            }
            
            // Also update the shared taskCompletions object
            taskCompletions[taskId] = newState;
            
            if (currentProject) {
                updateModalProgress();
                document.getElementById('modalTaskList').innerHTML = renderModalTasks(currentProject);
            }
            renderPhases();
            updateStats();
            updateMyTasksBadge();
            showToast(newState ? '✅ Task completed!' : '↩️ Task reopened');
        }

        function setDueDate(taskId, date) {
            taskDueDates[taskId] = date;
            localStorage.setItem('taskDueDates', JSON.stringify(taskDueDates));
            updateStats();
        }

        function setTaskDepartment(taskId, deptId) {
            if (deptId) {
                taskDepartments[taskId] = deptId;
            } else {
                // If clearing department, check if project has a department to inherit
                const projectId = taskId.split('_')[0];
                const projDept = projectDepartments[projectId];
                if (projDept) {
                    taskDepartments[taskId] = projDept;
                } else {
                    delete taskDepartments[taskId];
                }
            }
            localStorage.setItem('taskDepartments', JSON.stringify(taskDepartments));
            
            if (currentProject) {
                document.getElementById('modalTaskList').innerHTML = renderModalTasks(currentProject);
            }
            renderPhases();
            updateStats();
            
            const dept = departments.find(d => d.id === deptId);
            showToast(deptId ? `🏢 Task assigned to ${dept?.name || deptId}` : '🏢 Task using project department');
        }

        function filterByDepartment(deptId) {
            activeDepartmentFilter = deptId;
            
            // Update active state on pills
            document.querySelectorAll('.dept-pill').forEach(pill => {
                pill.classList.toggle('active', pill.dataset.dept === deptId);
            });
            
            // Filter project cards
            document.querySelectorAll('.project-card').forEach(card => {
                if (deptId === 'all') {
                    card.style.display = '';
                    return;
                }
                
                const projectId = card.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                if (!projectId) return;
                
                const project = findProject(projectId);
                if (!project) return;
                
                // Check if project itself has this department
                const projDept = projectDepartments[projectId] || project.department || '';
                if (projDept === deptId) {
                    card.style.display = '';
                    return;
                }
                
                // Check if any tasks have this department
                const tasks = getAllTasks(project);
                const hasMatchingDept = tasks.some(task => {
                    const taskId = `${project.id}_${task.name}`;
                    const taskDept = taskDepartments[taskId] || task.department || '';
                    return taskDept === deptId;
                });
                
                card.style.display = hasMatchingDept ? '' : 'none';
            });
        }

        function renderDepartmentFilters() {
            const container = document.getElementById('deptFilters');
            const currentDept = departments.find(d => d.id === activeDepartmentFilter);
            container.innerHTML = `
                <span class="dept-filter-label">🏢 Department:</span>
                <select class="dept-dropdown" onchange="filterByDepartment(this.value)">
                    <option value="all" ${activeDepartmentFilter === 'all' ? 'selected' : ''}>All Departments</option>
                    ${departments.map(d => `
                        <option value="${d.id}" ${activeDepartmentFilter === d.id ? 'selected' : ''}>${d.icon} ${d.name}</option>
                    `).join('')}
                </select>
            `;
        }

        function addTaskToCurrentProject() {
            if (!currentProject) return;
            const taskInput = document.getElementById('newTaskInput');
            const taskName = taskInput.value.trim();

            if (!taskName) {
                showToast('Please enter a task name', true);
                return;
            }

            if (!customTasks[currentProject.id]) customTasks[currentProject.id] = [];
            customTasks[currentProject.id].push({ name: taskName, owner: 'Unassigned', isCustom: true });
            localStorage.setItem('customTasks', JSON.stringify(customTasks));

            taskInput.value = '';
            document.getElementById('modalTaskList').innerHTML = renderModalTasks(currentProject);
            updateModalProgress();
            renderPhases();
            updateStats();
            showToast('✅ Task added!');
            
            // Auto-generate How To for the new task
            const taskId = `${currentProject.id}_${taskName}`;
            generateHowToContent(taskName, currentProject.id, currentProject.title, taskId);
            showToast('🤖 Generating How To instructions...');
        }

        function deleteCustomTask(projectId, taskName) {
            if (!customTasks[projectId]) return;
            customTasks[projectId] = customTasks[projectId].filter(t => t.name !== taskName);
            localStorage.setItem('customTasks', JSON.stringify(customTasks));
            
            // Also remove completion status
            const taskId = `${projectId}_${taskName}`;
            delete completedTasks[taskId];
            delete taskDueDates[taskId];
            localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
            localStorage.setItem('taskDueDates', JSON.stringify(taskDueDates));

            if (currentProject && currentProject.id === projectId) {
                document.getElementById('modalTaskList').innerHTML = renderModalTasks(currentProject);
                updateModalProgress();
            }
            renderPhases();
            updateStats();
            showToast('🗑️ Task deleted');
        }

        // ═══════════════════════════════════════
        // MODAL OPERATIONS
        // ═══════════════════════════════════════
        function openProjectModal(projectId) {
            const project = findProject(projectId);
            if (!project) return;

            currentProject = project;
            const stats = getProjectStats(project);
            const projDept = projectDepartments[project.id] || project.department || '';
            const owner = projectOwners[project.id] || project.owner || '';
            const dueDate = projectDueDates[project.id] || '';

            document.getElementById('modalProjectTitle').textContent = project.title;
            document.getElementById('modalProjectDescription').textContent = project.description;
            document.getElementById('modalProgressValue').textContent = `${stats.percentage}%`;
            document.getElementById('modalProgressBar').style.width = `${stats.percentage}%`;
            document.getElementById('modalTaskList').innerHTML = renderModalTasks(project);
            document.getElementById('aiResponse').style.display = 'none';
            
            // Render project department, owner, and due date selectors
            document.getElementById('projectDeptSelector').innerHTML = `
                <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center;">
                        <label style="font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-right: 12px;">👤 Owner:</label>
                        <select class="owner-select" onchange="setProjectOwner('${project.id}', this.value)">
                            <option value="">Select Owner...</option>
                            ${teamMembers.map(m => `<option value="${m}" ${owner === m ? 'selected' : ''}>${m}</option>`).join('')}
                        </select>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <label style="font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-right: 12px;">🏢 Department:</label>
                        <select class="dept-select" onchange="setProjectDepartment('${project.id}', this.value)" style="min-width: 180px;">
                            <option value="">No Department</option>
                            ${departments.map(d => `<option value="${d.id}" ${projDept === d.id ? 'selected' : ''}>${d.icon} ${d.name}</option>`).join('')}
                        </select>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <label style="font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-right: 12px;">📅 Due Date:</label>
                        <input type="date" class="date-input" value="${dueDate}" onchange="setProjectDueDate('${project.id}', this.value)">
                    </div>
                </div>
            `;

            document.getElementById('projectModal').classList.add('active');
        }

        function setProjectOwner(projectId, ownerName) {
            projectOwners[projectId] = ownerName;
            localStorage.setItem('projectOwners', JSON.stringify(projectOwners));
            renderPhases();
            showToast(ownerName ? `👤 Owner set to ${ownerName}` : '👤 Owner removed');
        }

        function setProjectDueDate(projectId, date) {
            projectDueDates[projectId] = date;
            localStorage.setItem('projectDueDates', JSON.stringify(projectDueDates));
            renderPhases();
            updateStats();
            showToast(date ? `📅 Due date set to ${formatDate(date)}` : '📅 Due date removed');
        }

        function getProjectDueDateClass(projectId) {
            const dueDate = projectDueDates[projectId];
            if (!dueDate) return '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const due = new Date(dueDate);
            const daysUntil = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
            
            // Check if project is complete
            const project = findProject(projectId);
            if (project) {
                const stats = getProjectStats(project);
                if (stats.percentage === 100) return '';
            }
            
            if (daysUntil < 0) return 'overdue';
            if (daysUntil <= 7) return 'due-soon';
            return '';
        }

        function setProjectDepartment(projectId, deptId) {
            projectDepartments[projectId] = deptId;
            localStorage.setItem('projectDepartments', JSON.stringify(projectDepartments));
            
            // Auto-assign department to all tasks that don't have an override
            if (deptId) {
                const project = findProject(projectId);
                if (project) {
                    const tasks = getAllTasks(project);
                    tasks.forEach(task => {
                        const taskId = `${projectId}_${task.name}`;
                        // Only set if task doesn't already have a department assigned
                        if (!taskDepartments[taskId]) {
                            taskDepartments[taskId] = deptId;
                        }
                    });
                    localStorage.setItem('taskDepartments', JSON.stringify(taskDepartments));
                }
            }
            
            // Refresh modal if open
            if (currentProject && currentProject.id === projectId) {
                document.getElementById('modalTaskList').innerHTML = renderModalTasks(currentProject);
            }
            
            renderPhases();
            
            const dept = departments.find(d => d.id === deptId);
            showToast(deptId ? `🏢 Project assigned to ${dept?.name || deptId}` : '🏢 Project department removed');
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('active');
            currentProject = null;
        }

        function updateModalProgress() {
            if (!currentProject) return;
            const stats = getProjectStats(currentProject);
            document.getElementById('modalProgressValue').textContent = `${stats.percentage}%`;
            document.getElementById('modalProgressBar').style.width = `${stats.percentage}%`;
        }

        // ═══════════════════════════════════════
        // AI ASSISTANT
        // ═══════════════════════════════════════
        async function askAI() {
            const question = document.getElementById('aiQuestionInput').value.trim();
            if (!question) return;

            const responseDiv = document.getElementById('aiResponse');
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '<div style="display: flex; align-items: center; gap: 10px;"><span class="loading-spinner"></span> Thinking...</div>';

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 800,
                        messages: [{
                            role: "user",
                            content: `You are a technical expert helping implement AI/Data Analytics for a large format printing company (WSDisplay).

Project: "${currentProject?.title || 'General'}"
Question: "${question}"

Provide a clear, practical answer (2-3 paragraphs max). Include specific steps or commands if technical.`
                        }]
                    })
                });

                const data = await response.json();
                if (data.error) {
                    responseDiv.innerHTML = `<span style="color: var(--danger);">Error: ${data.error.message}</span>`;
                } else {
                    responseDiv.innerHTML = data.content[0].text.split('\n').map(p => p.trim() ? `<p style="margin-bottom: 12px;">${escapeHtml(p)}</p>` : '').join('');
                }
            } catch (err) {
                responseDiv.innerHTML = `<span style="color: var(--danger);">Unable to connect to AI. ${err.message}</span>`;
            }
        }

        // Store generated How To instructions
        let taskHowTos = JSON.parse(localStorage.getItem('taskHowTos') || '{}');
        
        // Web search function for finding resources
        async function searchForResources(taskName, projectTitle) {
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 2000,
                        tools: [{
                            type: "web_search_20250305",
                            name: "web_search"
                        }],
                        messages: [{
                            role: "user",
                            content: `Find helpful resources for completing this task: "${taskName}" (part of project: "${projectTitle}").

Search for:
1. YouTube tutorial videos
2. Documentation or how-to articles  
3. Relevant tools or software
4. Industry forums or community discussions

Return ONLY a JSON object with this exact format (no other text):
{
    "youtube": [
        {"title": "Video Title", "url": "https://youtube.com/...", "description": "Brief description"}
    ],
    "articles": [
        {"title": "Article Title", "url": "https://...", "description": "Brief description"}
    ],
    "tools": [
        {"title": "Tool Name", "url": "https://...", "description": "What it does"}
    ],
    "forums": [
        {"title": "Discussion Title", "url": "https://...", "description": "Brief description"}
    ]
}

Include 1-4 resources per category based on task complexity. Only include categories with relevant results. Ensure all URLs are real and working.`
                        }]
                    })
                });

                if (!response.ok) return null;
                
                const data = await response.json();
                if (data.error || !data.content) return null;
                
                // Extract text content from response
                const textContent = data.content
                    .filter(item => item.type === 'text')
                    .map(item => item.text)
                    .join('');
                
                // Parse JSON from response
                const match = textContent.match(/\{[\s\S]*\}/);
                if (match) {
                    return JSON.parse(match[0]);
                }
                return null;
            } catch (err) {
                console.error('Resource search error:', err);
                return null;
            }
        }
        
        function formatResources(resources) {
            if (!resources) return '';
            
            let html = '<div class="resources-section"><div class="resources-header">📚 Helpful Resources</div>';
            
            if (resources.youtube && resources.youtube.length > 0) {
                html += '<div class="resource-category"><span class="resource-category-icon">▶️</span> <strong>Video Tutorials</strong>';
                resources.youtube.forEach(r => {
                    html += `<div class="resource-item"><a href="${r.url}" target="_blank" rel="noopener">${r.title}</a><span class="resource-desc">${r.description || ''}</span></div>`;
                });
                html += '</div>';
            }
            
            if (resources.articles && resources.articles.length > 0) {
                html += '<div class="resource-category"><span class="resource-category-icon">📄</span> <strong>Articles & Docs</strong>';
                resources.articles.forEach(r => {
                    html += `<div class="resource-item"><a href="${r.url}" target="_blank" rel="noopener">${r.title}</a><span class="resource-desc">${r.description || ''}</span></div>`;
                });
                html += '</div>';
            }
            
            if (resources.tools && resources.tools.length > 0) {
                html += '<div class="resource-category"><span class="resource-category-icon">🔧</span> <strong>Tools & Software</strong>';
                resources.tools.forEach(r => {
                    html += `<div class="resource-item"><a href="${r.url}" target="_blank" rel="noopener">${r.title}</a><span class="resource-desc">${r.description || ''}</span></div>`;
                });
                html += '</div>';
            }
            
            if (resources.forums && resources.forums.length > 0) {
                html += '<div class="resource-category"><span class="resource-category-icon">💬</span> <strong>Community Discussions</strong>';
                resources.forums.forEach(r => {
                    html += `<div class="resource-item"><a href="${r.url}" target="_blank" rel="noopener">${r.title}</a><span class="resource-desc">${r.description || ''}</span></div>`;
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        async function showHowTo(taskName, projectId) {
            const project = findProject(projectId);
            const projectTitle = project?.title || 'Unknown Project';
            const taskId = `${projectId}_${taskName}`;
            
            // Check if we have saved How To content
            const savedHowTo = taskHowTos[taskId];
            const hasResearch = savedHowTo?.research;
            
            // Remove old modal if exists
            document.getElementById('howToModal')?.remove();
            
            // Create full-screen modal
            const modal = document.createElement('div');
            modal.id = 'howToModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal fullscreen-modal">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">💡 ${taskName}</h2>
                            <p class="modal-description">Project: ${projectTitle}</p>
                        </div>
                        <button class="modal-close" onclick="closeHowToModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <!-- Left side: Instructions -->
                        <div class="task-detail-left">
                            <div class="how-to-tabs">
                                <button class="how-to-tab active" onclick="switchHowToTab('view')" data-tab="view">📖 Instructions</button>
                                <button class="how-to-tab" onclick="switchHowToTab('edit')" data-tab="edit">✏️ Edit</button>
                            </div>
                            <div id="howToViewTab" class="how-to-tab-content active">
                                <div id="howToContent">
                                    ${savedHowTo ? `
                                        <div class="how-to-instructions">
                                            ${formatHowToContent(savedHowTo.content)}
                                        </div>
                                        <div class="how-to-meta">
                                            ${savedHowTo.edited ? 'Last edited' : 'Generated'}: ${new Date(savedHowTo.generatedAt).toLocaleDateString()}
                                        </div>
                                    ` : `
                                        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 40px; justify-content: center;">
                                            <span class="loading-spinner"></span> 
                                            <div>Generating step-by-step instructions...</div>
                                        </div>
                                    `}
                                </div>
                            </div>
                            <div id="howToEditTab" class="how-to-tab-content" style="display: none;">
                                <textarea id="howToEditArea" class="input how-to-edit-area" rows="15" placeholder="Enter or edit How To instructions...">${savedHowTo?.content || ''}</textarea>
                                <div style="margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-primary" onclick="saveHowTo('${taskId}')">💾 Save Changes</button>
                                    <button class="btn" onclick="regenerateHowTo('${escapeHtml(taskName)}', '${projectId}')">🔄 Regenerate with AI</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right side: Research Panel -->
                        <div class="task-detail-right">
                            <div class="research-panel">
                                <div class="research-header">
                                    <h3>🔬 Research & Resources</h3>
                                    <button id="researchBtn" class="research-btn ${hasResearch ? '' : ''}" onclick="runDeepResearch('${escapeHtml(taskName)}', '${projectId}')">
                                        🔍 Research This
                                    </button>
                                </div>
                                <div id="researchContent">
                                    ${hasResearch ? formatDeepResearch(savedHowTo.research) : `
                                        <div class="research-empty">
                                            <div class="research-empty-icon">🔬</div>
                                            <h4>No research yet</h4>
                                            <p>Click "Research This" to find products, pricing, implementation guides, and more.</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="closeHowToModal()">Close</button>
                        <button class="btn" onclick="copyHowTo()">📋 Copy Instructions</button>
                    </div>
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target.id === 'howToModal') closeHowToModal();
            };
            document.body.appendChild(modal);
            
            // If no saved content, generate it
            if (!savedHowTo) {
                await generateHowToContentOnly(taskName, projectId, projectTitle, taskId);
            }
        }

        // Generate only How To content without resources (faster initial load)
        async function generateHowToContentOnly(taskName, projectId, projectTitle, taskId) {
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-haiku-4-5-20250514",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `You are a technical expert helping implement projects for WSDisplay, a large format printing and sublimation company.

Task: "${taskName}"
Project: "${projectTitle}"

Provide concise step-by-step instructions:

1. **Step**: Description
2. **Step**: Description
(3-6 steps total)

**Tips:** 2 brief tips

**Time:** Estimate

Be practical and concise.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'Unknown API error');
                }
                
                if (data.content && data.content[0]) {
                    const content = data.content[0].text;
                    
                    taskHowTos[taskId] = {
                        content: content,
                        generatedAt: new Date().toISOString(),
                        projectTitle: projectTitle
                    };
                    localStorage.setItem('taskHowTos', JSON.stringify(taskHowTos));
                    
                    const howToContent = document.getElementById('howToContent');
                    if (howToContent) {
                        howToContent.innerHTML = `
                            <div class="how-to-instructions">
                                ${formatHowToContent(content)}
                            </div>
                            <div class="how-to-meta">
                                Generated: ${new Date().toLocaleDateString()}
                            </div>
                        `;
                    }
                    
                    const editArea = document.getElementById('howToEditArea');
                    if (editArea) editArea.value = content;
                }
            } catch (err) {
                console.error('generateHowToContentOnly error:', err);
                const howToContent = document.getElementById('howToContent');
                if (howToContent) {
                    howToContent.innerHTML = `
                        <div style="color: var(--danger); padding: 20px;">
                            <strong>Unable to generate instructions</strong><br>
                            ${err.message}<br><br>
                            <em>Note: The AI API is only available when running this file within Claude's artifact environment.</em>
                        </div>
                    `;
                }
            }
        }

        // Run deep research for a task
        async function runDeepResearch(taskName, projectId) {
            const project = findProject(projectId);
            const projectTitle = project?.title || 'Unknown Project';
            const taskId = `${projectId}_${taskName}`;
            
            const btn = document.getElementById('researchBtn');
            const researchContent = document.getElementById('researchContent');
            
            if (btn) {
                btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></span> Researching...';
                btn.disabled = true;
                btn.classList.add('researching');
            }
            
            if (researchContent) {
                researchContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 30px;">
                        <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                        <h4 style="color: var(--text-secondary); margin-bottom: 8px;">Conducting Deep Research...</h4>
                        <p style="color: var(--text-muted); font-size: 0.95rem;">Finding products, comparing prices, and gathering implementation details.</p>
                    </div>
                `;
            }
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 4000,
                        tools: [{
                            type: "web_search_20250305",
                            name: "web_search"
                        }],
                        messages: [{
                            role: "user",
                            content: `You are a procurement and implementation specialist for WSDisplay, a large format printing and sublimation company with 300 employees across 3 US locations.

Task: "${taskName}"
Project: "${projectTitle}"

Please conduct thorough research and return a JSON object with the following structure. Search for real products, real prices, and real vendor information.

{
    "products": [
        {
            "name": "Product Name",
            "vendor": "Vendor/Brand Name",
            "price": "$X,XXX",
            "priceTier": "budget|mid|enterprise",
            "url": "https://...",
            "features": ["feature 1", "feature 2", "feature 3"],
            "pros": ["pro 1", "pro 2"],
            "cons": ["con 1", "con 2"]
        }
    ],
    "implementation": [
        {"step": 1, "title": "Step Title", "description": "Detailed description", "duration": "X days/weeks"},
    ],
    "vendorQuestions": [
        "Question to ask vendors before purchasing",
    ],
    "internalConsiderations": [
        {"department": "IT|HR|Finance|Facilities|Legal", "title": "Consideration Title", "description": "What needs to happen"},
    ],
    "videos": [
        {"title": "Video Title", "url": "https://youtube.com/...", "description": "What you'll learn"}
    ],
    "articles": [
        {"title": "Article Title", "url": "https://...", "description": "Brief description"}
    ]
}

IMPORTANT:
- Include 3-5 real products with actual prices when available
- Products should span different price tiers (budget, mid, enterprise)
- Include actual working URLs to vendor websites
- Vendor questions should be specific and actionable
- Internal considerations should cover relevant departments
- Find real YouTube tutorials or documentation

Return ONLY the JSON object, no other text.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                // Extract text content
                const textContent = data.content
                    ?.filter(item => item.type === 'text')
                    ?.map(item => item.text)
                    ?.join('') || '';
                
                // Parse JSON
                const jsonMatch = textContent.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const research = JSON.parse(jsonMatch[0]);
                    
                    // Save to storage
                    if (taskHowTos[taskId]) {
                        taskHowTos[taskId].research = research;
                    } else {
                        taskHowTos[taskId] = {
                            content: '',
                            research: research,
                            generatedAt: new Date().toISOString()
                        };
                    }
                    localStorage.setItem('taskHowTos', JSON.stringify(taskHowTos));
                    
                    // Update UI
                    if (researchContent) {
                        researchContent.innerHTML = formatDeepResearch(research);
                    }
                    
                    showToast('🔬 Research complete!');
                } else {
                    throw new Error('Could not parse research results');
                }
            } catch (err) {
                console.error('Deep research error:', err);
                if (researchContent) {
                    researchContent.innerHTML = `
                        <div class="research-empty">
                            <div class="research-empty-icon">⚠️</div>
                            <h4>Research failed</h4>
                            <p>${err.message}</p>
                            <button class="research-btn" onclick="runDeepResearch('${escapeHtml(taskName)}', '${projectId}')" style="margin-top: 10px;">
                                🔄 Try Again
                            </button>
                        </div>
                    `;
                }
                showToast('Research failed: ' + err.message, true);
            } finally {
                if (btn) {
                    btn.innerHTML = '🔍 Research This';
                    btn.disabled = false;
                    btn.classList.remove('researching');
                }
            }
        }

        // Format deep research into HTML
        function formatDeepResearch(research) {
            if (!research) return '';
            
            let html = '';
            
            // Products comparison grid
            if (research.products && research.products.length > 0) {
                html += `
                    <div class="research-section products">
                        <h4>🛒 Product Comparison</h4>
                        <div class="comparison-grid">
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Price</th>
                                        <th>Key Features</th>
                                        <th>Pros/Cons</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${research.products.map(p => `
                                        <tr>
                                            <td>
                                                <div class="product-name">${p.name}</div>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary);">${p.vendor}</div>
                                                ${p.url ? `<a href="${p.url}" target="_blank" rel="noopener" class="product-link">Visit Website →</a>` : ''}
                                            </td>
                                            <td>
                                                <div class="price">${p.price || 'Contact for pricing'}</div>
                                                <span class="price-tier">${p.priceTier || ''}</span>
                                            </td>
                                            <td>
                                                ${(p.features || []).map(f => `<div style="margin-bottom: 4px;">✓ ${f}</div>`).join('')}
                                            </td>
                                            <td>
                                                <div class="pros-cons">
                                                    ${(p.pros || []).map(pro => `<div class="pro-item">+ ${pro}</div>`).join('')}
                                                    ${(p.cons || []).map(con => `<div class="con-item">− ${con}</div>`).join('')}
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // Implementation guide
            if (research.implementation && research.implementation.length > 0) {
                html += `
                    <div class="research-section implementation">
                        <h4>📋 Implementation Guide</h4>
                        ${research.implementation.map(step => `
                            <div class="how-to-step">
                                <span class="step-number">${step.step}</span>
                                <div>
                                    <strong>${step.title}</strong>
                                    <div style="color: var(--text-secondary); margin-top: 4px;">${step.description}</div>
                                    ${step.duration ? `<div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 6px;">⏱️ ${step.duration}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Vendor questions
            if (research.vendorQuestions && research.vendorQuestions.length > 0) {
                html += `
                    <div class="research-section vendor-questions">
                        <h4>❓ Questions to Ask Vendors</h4>
                        <ul class="question-list">
                            ${research.vendorQuestions.map(q => `<li>${q}</li>`).join('')}
                        </ul>
                        <button class="copy-btn" onclick="copyVendorQuestions()" style="margin-top: 12px;">📋 Copy Questions</button>
                    </div>
                `;
            }
            
            // Internal considerations
            if (research.internalConsiderations && research.internalConsiderations.length > 0) {
                const deptIcons = {
                    'IT': { icon: '💻', class: 'it' },
                    'HR': { icon: '👥', class: 'hr' },
                    'Finance': { icon: '💰', class: 'finance' },
                    'Facilities': { icon: '🏢', class: 'facilities' },
                    'Legal': { icon: '⚖️', class: 'legal' }
                };
                
                html += `
                    <div class="research-section internal">
                        <h4>🏢 Internal Considerations</h4>
                        <div class="internal-list">
                            ${research.internalConsiderations.map(item => {
                                const dept = deptIcons[item.department] || { icon: '📋', class: '' };
                                return `
                                    <div class="internal-item">
                                        <div class="internal-item-icon ${dept.class}">${dept.icon}</div>
                                        <div class="internal-item-content">
                                            <h5>${item.department}: ${item.title}</h5>
                                            <p>${item.description}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Videos & Documentation
            if ((research.videos && research.videos.length > 0) || (research.articles && research.articles.length > 0)) {
                html += `
                    <div class="research-section videos">
                        <h4>🎬 Videos & Documentation</h4>
                        <div class="video-grid">
                            ${(research.videos || []).map(v => `
                                <div class="video-card">
                                    <a href="${v.url}" target="_blank" rel="noopener">▶️ ${v.title}</a>
                                    <p>${v.description || ''}</p>
                                </div>
                            `).join('')}
                            ${(research.articles || []).map(a => `
                                <div class="video-card">
                                    <a href="${a.url}" target="_blank" rel="noopener">📄 ${a.title}</a>
                                    <p>${a.description || ''}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            return html || '<div class="research-empty"><p>No research data available.</p></div>';
        }

        function copyVendorQuestions() {
            const questions = document.querySelectorAll('.question-list li');
            const text = Array.from(questions).map((q, i) => `${i + 1}. ${q.textContent.replace('❓', '').trim()}`).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                showToast('📋 Questions copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy', true);
            });
        }
        
        async function refreshResources(taskName, projectId) {
            // Now calls runDeepResearch instead
            await runDeepResearch(taskName, projectId);
        }

        function switchHowToTab(tab) {
            document.querySelectorAll('.how-to-tab').forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.how-to-tab[data-tab="${tab}"]`);
            if (activeTab) activeTab.classList.add('active');
            
            const viewTab = document.getElementById('howToViewTab');
            const editTab = document.getElementById('howToEditTab');
            
            if (viewTab) viewTab.style.display = tab === 'view' ? '' : 'none';
            if (editTab) editTab.style.display = tab === 'edit' ? '' : 'none';
        }

        function saveHowTo(taskId) {
            const content = document.getElementById('howToEditArea')?.value.trim();
            
            if (!content) {
                showToast('Please enter some content', true);
                return;
            }
            
            // Preserve existing research when saving
            const existingResearch = taskHowTos[taskId]?.research || null;
            
            taskHowTos[taskId] = {
                content: content,
                research: existingResearch,
                generatedAt: new Date().toISOString(),
                edited: true
            };
            localStorage.setItem('taskHowTos', JSON.stringify(taskHowTos));
            
            // Update view tab
            const howToContent = document.getElementById('howToContent');
            if (howToContent) {
                howToContent.innerHTML = `
                    <div class="how-to-instructions">
                        ${formatHowToContent(content)}
                    </div>
                    <div class="how-to-meta">
                        Last edited: ${new Date().toLocaleDateString()}
                    </div>
                `;
            }
            
            switchHowToTab('view');
            showToast('💾 How To instructions saved!');
        }

        async function regenerateHowTo(taskName, projectId) {
            const project = findProject(projectId);
            const projectTitle = project?.title || 'Unknown Project';
            const taskId = `${projectId}_${taskName}`;
            
            const editArea = document.getElementById('howToEditArea');
            if (editArea) {
                editArea.value = 'Generating new instructions...';
                editArea.disabled = true;
            }
            
            await generateHowToContentOnly(taskName, projectId, projectTitle, taskId);
            
            // Update edit area with new content
            const newContent = taskHowTos[taskId]?.content || '';
            if (editArea) {
                editArea.value = newContent;
                editArea.disabled = false;
            }
            
            showToast('🔄 Instructions regenerated!');
        }

        function formatHowToContent(content) {
            // Convert markdown-style formatting to HTML
            let html = content
                // Bold text
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                // Numbered steps
                .replace(/^(\d+)\.\s+/gm, '<div class="how-to-step"><span class="step-number">$1</span>')
                // Tips section
                .replace(/Tips & Best Practices:/gi, '</div><div class="how-to-tips"><div class="tips-header">💡 Tips & Best Practices</div>')
                // Estimated time
                .replace(/Estimated Time:/gi, '</div><div class="how-to-time"><div class="time-header">⏱️ Estimated Time</div>')
                // Bullet points
                .replace(/^-\s+(.+)$/gm, '<div class="how-to-bullet">• $1</div>')
                // Line breaks
                .replace(/\n\n/g, '</div><div class="how-to-paragraph">')
                .replace(/\n/g, '<br>');
            
            return `<div class="how-to-paragraph">${html}</div>`;
        }

        function closeHowToModal() {
            const modal = document.getElementById('howToModal');
            if (modal) modal.classList.remove('active');
        }

        function copyHowTo() {
            const content = document.getElementById('howToContent');
            const text = content.innerText;
            navigator.clipboard.writeText(text).then(() => {
                showToast('📋 Instructions copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy', true);
            });
        }

        // ═══════════════════════════════════════
        // UTILITIES
        // ═══════════════════════════════════════
        function findProject(projectId) {
            for (const phase of masterplan.phases) {
                const project = phase.projects.find(p => p.id === projectId);
                if (project) return project;
            }
            return null;
        }

        function getAllTasks(project) {
            const baseTasks = project.tasks || [];
            const custom = customTasks[project.id] || [];
            return [...baseTasks, ...custom];
        }

        function getProjectStats(project) {
            const tasks = getAllTasks(project);
            let completed = 0;
            tasks.forEach(task => {
                const taskId = `${project.id}_${task.name}`;
                if (completedTasks[taskId]) completed++;
            });
            const total = tasks.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            return { completed, total, remaining: total - completed, percentage };
        }

        function getPhaseStats(phase) {
            let completed = 0, total = 0;
            phase.projects.forEach(project => {
                const stats = getProjectStats(project);
                completed += stats.completed;
                total += stats.total;
            });
            return { completed, total, percentage: total > 0 ? Math.round((completed / total) * 100) : 0 };
        }

        function updateStats() {
            let totalCompleted = 0, totalTasks = 0, dueSoon = 0, overdue = 0;
            const today = new Date();
            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            const deptCounts = {};
            let tasksWithDept = 0;

            masterplan.phases.forEach(phase => {
                phase.projects.forEach(project => {
                    const tasks = getAllTasks(project);
                    tasks.forEach(task => {
                        const taskId = `${project.id}_${task.name}`;
                        totalTasks++;
                        if (completedTasks[taskId]) totalCompleted++;
                        
                        // Track departments
                        const projDept = projectDepartments[project.id] || '';
                        const taskDept = taskDepartments[taskId] || projDept || task.department || '';
                        if (taskDept) {
                            tasksWithDept++;
                            deptCounts[taskDept] = (deptCounts[taskDept] || 0) + 1;
                        }
                        
                        const dueDate = taskDueDates[taskId];
                        if (dueDate && !completedTasks[taskId]) {
                            const due = new Date(dueDate);
                            if (due < today) overdue++;
                            else if (due <= weekFromNow) dueSoon++;
                        }
                    });
                });
            });

            const percentage = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;
            const activeDepts = Object.keys(deptCounts).length;

            // Rebuild stats grid HTML
            document.querySelector('.stats-grid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">📈 Overall Progress</div>
                    <div class="stat-value" id="overallProgress">${percentage}%</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill primary" id="overallProgressBar" style="width: ${percentage}%"></div>
                    </div>
                    <div class="stat-detail" id="overallDetail">${totalCompleted} of ${totalTasks} tasks complete</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">✅ Tasks Completed</div>
                    <div class="stat-value" id="tasksCompleted">${totalCompleted}</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill success" id="tasksProgressBar" style="width: ${percentage}%"></div>
                    </div>
                    <div class="stat-detail" id="tasksDetail">This week: ${totalCompleted}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">🏢 Departments Active</div>
                    <div class="stat-value" id="deptsActive">${activeDepts}</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill primary" id="deptsProgressBar" style="width: ${Math.round((activeDepts / departments.length) * 100)}%"></div>
                    </div>
                    <div class="stat-detail" id="deptsDetail">${tasksWithDept} tasks assigned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">⚠️ Due Soon</div>
                    <div class="stat-value" id="dueSoon">${dueSoon}</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill warning" style="width: 100%"></div>
                    </div>
                    <div class="stat-detail">Next 7 days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">🚨 Overdue</div>
                    <div class="stat-value" id="overdue">${overdue}</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill danger" style="width: 100%"></div>
                    </div>
                    <div class="stat-detail">Needs attention</div>
                </div>
            `;
            
            // Update issue count in sidebar
            const issueCountEl = document.getElementById('issueCount');
            if (issueCountEl) issueCountEl.textContent = '0';
        }

        function getDueDateClass(taskId) {
            const dueDate = taskDueDates[taskId];
            if (!dueDate || completedTasks[taskId]) return '';
            
            const today = new Date();
            const due = new Date(dueDate);
            const daysUntil = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntil < 0) return 'overdue';
            if (daysUntil <= 3) return 'due-soon';
            return '';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function filterContent() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.chip.active')?.dataset.filter || 'all';
            
            // For now, just a simple visual filter - could be expanded
            document.querySelectorAll('.project-card').forEach(card => {
                const title = card.querySelector('.project-title').textContent.toLowerCase();
                const matchesSearch = !searchTerm || title.includes(searchTerm);
                card.style.display = matchesSearch ? '' : 'none';
            });
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${isError ? 'error' : ''}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ═══════════════════════════════════════
        // IMPORT / EXPORT
        // ═══════════════════════════════════════
        function exportData() {
            const data = {
                version: 7,
                exportDate: new Date().toISOString(),
                completedTasks,
                taskOwners,
                taskDueDates,
                taskDepartments,
                projectDepartments,
                projectOwners,
                projectDueDates,
                teamMembers,
                departments,
                departmentLeads,
                customTasks,
                taskHowTos,
                projectIssues,
                customProjects: JSON.parse(localStorage.getItem('customProjects') || '{}')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `wsdisplay-tracker-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('📤 Data exported!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!confirm(`Import backup from ${new Date(data.exportDate).toLocaleDateString()}?`)) return;

                    completedTasks = data.completedTasks || {};
                    taskOwners = data.taskOwners || {};
                    taskDueDates = data.taskDueDates || {};
                    taskDepartments = data.taskDepartments || {};
                    projectDepartments = data.projectDepartments || {};
                    projectOwners = data.projectOwners || {};
                    projectDueDates = data.projectDueDates || {};
                    teamMembers = data.teamMembers || teamMembers;
                    departments = data.departments || departments;
                    departmentLeads = data.departmentLeads || {};
                    customTasks = data.customTasks || {};
                    taskHowTos = data.taskHowTos || {};
                    projectIssues = data.projectIssues || {};

                    localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
                    localStorage.setItem('taskOwners', JSON.stringify(taskOwners));
                    localStorage.setItem('taskDueDates', JSON.stringify(taskDueDates));
                    localStorage.setItem('taskDepartments', JSON.stringify(taskDepartments));
                    localStorage.setItem('projectDepartments', JSON.stringify(projectDepartments));
                    localStorage.setItem('projectOwners', JSON.stringify(projectOwners));
                    localStorage.setItem('projectDueDates', JSON.stringify(projectDueDates));
                    localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
                    localStorage.setItem('departments', JSON.stringify(departments));
                    localStorage.setItem('departmentLeads', JSON.stringify(departmentLeads));
                    localStorage.setItem('customTasks', JSON.stringify(customTasks));
                    localStorage.setItem('taskHowTos', JSON.stringify(taskHowTos));
                    localStorage.setItem('projectIssues', JSON.stringify(projectIssues));
                    
                    if (data.customProjects) {
                        localStorage.setItem('customProjects', JSON.stringify(data.customProjects));
                        loadCustomProjects();
                    }

                    renderDepartmentFilters();
                    renderPhases();
                    updateStats();
                    updateIssueCount();
                    showToast('📥 Data imported!');
                } catch (err) {
                    showToast('Error reading file', true);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function reportIssue() {
            if (!currentProject) return;
            
            // Create modal if doesn't exist
            let modal = document.getElementById('reportIssueModal');
            if (modal) modal.remove();
            
            modal = document.createElement('div');
            modal.id = 'reportIssueModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 550px;">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">🐛 Report Issue</h2>
                            <p class="modal-description">Project: ${currentProject.title}</p>
                        </div>
                        <button class="modal-close" onclick="closeReportIssueModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Issue Title *</label>
                            <input type="text" id="issueTitle" class="input" placeholder="Brief description of the issue...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea id="issueDescription" class="input" rows="4" placeholder="Detailed description, steps to reproduce, etc..."></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select id="issuePriority" class="select">
                                    <option value="low">🟢 Low</option>
                                    <option value="medium" selected>🟡 Medium</option>
                                    <option value="high">🟠 High</option>
                                    <option value="critical">🔴 Critical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Type</label>
                                <select id="issueType" class="select">
                                    <option value="bug">🐛 Bug</option>
                                    <option value="feature">✨ Feature Request</option>
                                    <option value="improvement">💡 Improvement</option>
                                    <option value="question">❓ Question</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="closeReportIssueModal()">Cancel</button>
                        <button class="btn btn-danger" onclick="submitIssue()">Submit Issue</button>
                    </div>
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target.id === 'reportIssueModal') closeReportIssueModal();
            };
            document.body.appendChild(modal);
            document.getElementById('issueTitle').focus();
        }

        function closeReportIssueModal() {
            const modal = document.getElementById('reportIssueModal');
            if (modal) modal.remove();
        }

        // Store issues
        let projectIssues = JSON.parse(localStorage.getItem('projectIssues') || '{}');

        function submitIssue() {
            const title = document.getElementById('issueTitle').value.trim();
            const description = document.getElementById('issueDescription').value.trim();
            const priority = document.getElementById('issuePriority').value;
            const type = document.getElementById('issueType').value;
            
            if (!title) {
                showToast('Please enter an issue title', true);
                return;
            }
            
            const issueId = 'issue_' + Date.now();
            const issue = {
                id: issueId,
                projectId: currentProject.id,
                projectTitle: currentProject.title,
                title,
                description,
                priority,
                type,
                status: 'open',
                createdAt: new Date().toISOString()
            };
            
            if (!projectIssues[currentProject.id]) {
                projectIssues[currentProject.id] = [];
            }
            projectIssues[currentProject.id].push(issue);
            localStorage.setItem('projectIssues', JSON.stringify(projectIssues));
            
            // Update issue count in nav
            updateIssueCount();
            
            closeReportIssueModal();
            showToast('🐛 Issue reported successfully!');
        }

        function updateIssueCount() {
            let totalOpen = 0;
            Object.values(projectIssues).forEach(issues => {
                totalOpen += issues.filter(i => i.status === 'open').length;
            });
            document.getElementById('issueCount').textContent = totalOpen;
        }

        // Call on load
        updateIssueCount();

        function openAddProjectModal() {
            // Reset tasks list
            newProjectTasks = [];
            
            // Create modal if it doesn't exist
            let modal = document.getElementById('addProjectModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'addProjectModal';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">➕ Create New Project</h2>
                            <p class="modal-description">Add a new project to track</p>
                        </div>
                        <button class="modal-close" onclick="closeAddProjectModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Project Title *</label>
                            <input type="text" id="newProjectTitle" class="input" placeholder="Enter project title...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea id="newProjectDescription" class="input" rows="2" placeholder="Brief description of the project..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🎯 End Goal <span style="color: var(--text-muted); font-weight: 400;">(What does success look like?)</span></label>
                            <textarea id="newProjectEndGoal" class="input" rows="2" placeholder="e.g., Reduce production errors by 50%, Launch new product line by Q3, Automate daily reports to save 2 hours/day..."></textarea>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 6px;">💡 The AI will use this to generate more targeted tasks and questions</div>
                        </div>
                        
                        <!-- AI Generate Section -->
                        <div class="form-group">
                            <div class="ai-generate-section-top">
                                <div class="ai-wizard-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="useAIWizard" checked>
                                        <span>Ask clarifying questions first</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="generateHowToAuto" checked>
                                        <span>Generate "How To" instructions</span>
                                    </label>
                                </div>
                                <button class="btn ai-generate-btn" onclick="startAITaskGeneration()">
                                    🤖 Generate Tasks with AI
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tasks Section -->
                        <div class="form-group">
                            <label class="form-label">Tasks</label>
                            <div id="newProjectTasksList" class="new-project-tasks-list">
                                <div class="no-tasks-message">No tasks added yet. Use AI above or add manually below.</div>
                            </div>
                            <div class="add-task-row">
                                <input type="text" id="newTaskInput" class="input" placeholder="Enter task name..." onkeydown="if(event.key==='Enter'){event.preventDefault();addNewProjectTask();}">
                                <button class="btn btn-primary" onclick="addNewProjectTask()">+ Add</button>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Owner</label>
                                <select id="newProjectOwner" class="select">
                                    <option value="">Select Owner...</option>
                                    ${teamMembers.map(m => `<option value="${m}">${m}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Department</label>
                                <select id="newProjectDept" class="select">
                                    <option value="">Select Department...</option>
                                    ${departments.map(d => `<option value="${d.id}">${d.icon} ${d.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select id="newProjectPriority" class="select">
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" id="newProjectDueDate" class="input">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="closeAddProjectModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="createProject()">Create Project</button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target.id === 'addProjectModal') closeAddProjectModal();
            };
            
            modal.classList.add('active');
            document.getElementById('newProjectTitle').focus();
        }

        let newProjectTasks = [];

        // AI Chat State
        let chatHistory = [];

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAIChat();
            }
        }

        function resetAIChat() {
            chatHistory = [];
            const container = document.getElementById('aiChatMessages');
            if (container) {
                container.innerHTML = `
                    <div class="chat-message ai">
                        <div class="chat-avatar">🤖</div>
                        <div class="chat-bubble">Hi! Tell me about your project and I'll help you break it down into tasks. What are you trying to accomplish?</div>
                    </div>
                `;
            }
        }

        function addChatMessage(text, sender) {
            const container = document.getElementById('aiChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="chat-avatar">👤</div>
                    <div class="chat-bubble">${escapeHtml(text)}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="chat-avatar">🤖</div>
                    <div class="chat-bubble">${text}</div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator() {
            const container = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message ai';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="chat-avatar">🤖</div>
                <div class="chat-bubble typing">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendAIChat() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.value = '';
            input.style.height = 'auto';
            
            // Add user message to chat
            addChatMessage(message, 'user');
            chatHistory.push({ role: 'user', content: message });
            
            // Show typing indicator
            showTypingIndicator();
            
            // Get project context
            const title = document.getElementById('newProjectTitle').value.trim();
            const description = document.getElementById('newProjectDescription').value.trim();
            
            // Build conversation for API
            const messages = chatHistory.map(m => ({
                role: m.role === 'user' ? 'user' : 'assistant',
                content: m.content
            }));
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 1000,
                        system: `You are a helpful project planning assistant for WSDisplay, a large format printing and sublimation company with 300 employees. You're having a conversation to help the user plan their project and identify tasks.

Project Title: "${title || 'Not yet specified'}"
Project Description: "${description || 'Not yet specified'}"

Instructions:
- Help the user think through their project
- Ask clarifying questions to understand scope, requirements, timeline, and deliverables
- Be conversational, friendly, and helpful
- Keep responses concise (2-4 sentences)
- When you feel you have enough information, offer to generate a task list
- If the user asks to generate or extract tasks, include them in your response wrapped like this: <tasks>["Task 1", "Task 2", "Task 3"]</tasks>`,
                        messages: messages
                    })
                });

                removeTypingIndicator();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error.message);
                }

                let aiResponse = data.content[0].text;
                
                // Check if response contains tasks
                const tasksMatch = aiResponse.match(/<tasks>(\[[\s\S]*?\])<\/tasks>/);
                if (tasksMatch) {
                    try {
                        const tasks = JSON.parse(tasksMatch[1]);
                        let added = 0;
                        tasks.forEach(taskName => {
                            if (taskName && typeof taskName === 'string') {
                                if (!newProjectTasks.find(t => t.name.toLowerCase() === taskName.trim().toLowerCase())) {
                                    newProjectTasks.push({ name: taskName.trim(), owner: 'Unassigned', hasHowTo: false });
                                    added++;
                                }
                            }
                        });
                        renderNewProjectTasks();
                        if (added > 0) {
                            showToast(`✅ Added ${added} tasks!`);
                        }
                    } catch (e) {
                        console.error('Failed to parse tasks:', e);
                    }
                    // Remove tasks tag from displayed message
                    aiResponse = aiResponse.replace(/<tasks>[\s\S]*?<\/tasks>/, '').trim();
                }
                
                addChatMessage(aiResponse, 'ai');
                chatHistory.push({ role: 'assistant', content: aiResponse });
                
            } catch (err) {
                removeTypingIndicator();
                console.error('Chat error:', err);
                addChatMessage('Sorry, I had trouble connecting. Please try again.', 'ai');
            }
        }

        async function extractTasksFromChat() {
            if (chatHistory.length === 0) {
                showToast('Have a conversation first, then extract tasks', true);
                return;
            }
            
            showTypingIndicator();
            
            const title = document.getElementById('newProjectTitle').value.trim();
            const description = document.getElementById('newProjectDescription').value.trim();
            
            const conversationText = chatHistory.map(m => 
                `${m.role === 'user' ? 'User' : 'Assistant'}: ${m.content}`
            ).join('\n\n');
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `Based on this conversation about a project, extract a comprehensive list of actionable tasks.

Project Title: "${title || 'New Project'}"
Project Description: "${description || ''}"

Conversation:
${conversationText}

Extract 5-10 specific, actionable tasks mentioned or implied in this conversation. Return ONLY a JSON array of task names, nothing else.
Example: ["Task 1", "Task 2", "Task 3"]`
                        }]
                    })
                });

                removeTypingIndicator();

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                
                const content = data.content[0].text.trim();
                const match = content.match(/\[[\s\S]*\]/);
                
                if (match) {
                    const tasks = JSON.parse(match[0]);
                    let added = 0;
                    tasks.forEach(taskName => {
                        if (taskName && typeof taskName === 'string') {
                            if (!newProjectTasks.find(t => t.name.toLowerCase() === taskName.trim().toLowerCase())) {
                                newProjectTasks.push({ name: taskName.trim(), owner: 'Unassigned', hasHowTo: false });
                                added++;
                            }
                        }
                    });
                    renderNewProjectTasks();
                    addChatMessage(`I've extracted ${added} tasks from our conversation and added them to your task list!`, 'ai');
                    showToast(`✅ Extracted ${added} tasks!`);
                } else {
                    addChatMessage("I couldn't find specific tasks to extract. Could you tell me more about what needs to be done?", 'ai');
                }
            } catch (err) {
                removeTypingIndicator();
                console.error('Extract tasks error:', err);
                showToast('Failed to extract tasks', true);
            }
        }

        function addNewProjectTask() {
            const input = document.getElementById('newTaskInput');
            const taskName = input.value.trim();
            
            if (!taskName) return;
            
            newProjectTasks.push({ name: taskName, owner: 'Unassigned' });
            input.value = '';
            renderNewProjectTasks();
            input.focus();
        }

        function removeNewProjectTask(index) {
            newProjectTasks.splice(index, 1);
            renderNewProjectTasks();
        }

        function renderNewProjectTasks() {
            const container = document.getElementById('newProjectTasksList');
            
            if (newProjectTasks.length === 0) {
                container.innerHTML = '<div class="no-tasks-message">No tasks added yet. Use AI above or add manually below.</div>';
                return;
            }
            
            container.innerHTML = newProjectTasks.map((task, idx) => `
                <div class="new-task-item">
                    <span class="new-task-number">${idx + 1}</span>
                    <span class="new-task-name">${task.name}</span>
                    <span class="new-task-howto ${task.hasHowTo ? 'ready' : ''}">${task.hasHowTo ? '✓ How To' : ''}</span>
                    <button class="btn btn-icon btn-sm" onclick="removeNewProjectTask(${idx})" title="Remove">×</button>
                </div>
            `).join('');
        }

        // AI Wizard state
        let wizardAnswers = {};
        let currentWizardQuestion = 0;
        let wizardQuestions = [];

        function startAITaskGeneration() {
            const title = document.getElementById('newProjectTitle').value.trim();
            
            if (!title) {
                showToast('Please enter a project title first', true);
                document.getElementById('newProjectTitle').focus();
                return;
            }
            
            const useWizard = document.getElementById('useAIWizard').checked;
            
            if (useWizard) {
                // Start wizard - first generate questions
                wizardAnswers = {};
                currentWizardQuestion = 0;
                wizardQuestions = [];
                generateWizardQuestions();
            } else {
                // Generate directly
                generateAITasks();
            }
        }

        async function generateWizardQuestions() {
            const title = document.getElementById('newProjectTitle').value.trim();
            const description = document.getElementById('newProjectDescription').value.trim();
            const endGoal = document.getElementById('newProjectEndGoal').value.trim();
            
            // Show loading modal
            let modal = document.getElementById('aiWizardModal');
            if (modal) modal.remove();
            
            modal = document.createElement('div');
            modal.id = 'aiWizardModal';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal wizard-modal">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">🤖 AI Task Generator</h2>
                            <p class="modal-description">Analyzing your project...</p>
                        </div>
                        <button class="modal-close" onclick="closeWizardModal()">×</button>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 60px 20px;">
                        <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
                        <p style="color: var(--text-secondary);">Generating clarifying questions based on your project...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 1500,
                        messages: [{
                            role: "user",
                            content: `You are helping plan a project for WSDisplay, a large format printing and sublimation company with 300 employees.

Project Title: "${title}"
${description ? `Description: "${description}"` : ''}
${endGoal ? `End Goal / Success Criteria: "${endGoal}"` : ''}

Generate exactly 5 clarifying questions that would help you create better, more specific tasks for this project. Each question should have 4 multiple choice options.

${endGoal ? `IMPORTANT: The user has defined their end goal as: "${endGoal}". Tailor your questions to help understand HOW to achieve this specific outcome - what resources, timeline, constraints, dependencies, or approaches would help reach this goal.` : ''}

Return ONLY valid JSON in this exact format, nothing else:
[
  {
    "id": "q1",
    "question": "Your question here?",
    "options": ["Option 1", "Option 2", "Option 3", "Option 4"]
  },
  {
    "id": "q2",
    "question": "Your question here?",
    "options": ["Option 1", "Option 2", "Option 3", "Option 4"]
  }
]

Make questions specific to this project and its end goal. Ask about things like timeline, budget, technical requirements, target audience, integration needs, success metrics, or whatever is most relevant to achieving the stated goal.`
                        }]
                    })
                });

                const data = await response.json();
                if (data.error) {
                    showToast('Error: ' + data.error.message, true);
                    closeWizardModal();
                    return;
                }
                
                const content = data.content[0].text.trim();
                const match = content.match(/\[[\s\S]*\]/);
                if (match) {
                    wizardQuestions = JSON.parse(match[0]);
                    showWizardModal();
                } else {
                    showToast('Could not generate questions, generating tasks directly...', true);
                    closeWizardModal();
                    generateAITasks();
                }
            } catch (err) {
                showToast('Failed to connect to AI: ' + err.message, true);
                closeWizardModal();
            }
        }

        function showWizardModal() {
            const modal = document.getElementById('aiWizardModal');
            if (!modal) return;
            
            modal.innerHTML = `
                <div class="modal wizard-modal">
                    <div class="modal-header">
                        <div>
                            <h2 class="modal-title">🤖 AI Task Generator</h2>
                            <p class="modal-description">Answer a few questions to get better task suggestions</p>
                        </div>
                        <button class="modal-close" onclick="closeWizardModal()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="wizard-progress">
                            <div class="wizard-progress-bar" style="width: ${((currentWizardQuestion + 1) / wizardQuestions.length) * 100}%"></div>
                        </div>
                        <div class="wizard-question-number">Question ${currentWizardQuestion + 1} of ${wizardQuestions.length}</div>
                        <div class="wizard-question" id="wizardQuestion"></div>
                        <div class="wizard-options" id="wizardOptions"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="wizardBack()" id="wizardBackBtn" style="visibility: hidden;">← Back</button>
                        <button class="btn" onclick="skipWizard()">Skip & Generate</button>
                    </div>
                </div>
            `;
            renderWizardQuestion();
        }

        function renderWizardQuestion() {
            if (currentWizardQuestion >= wizardQuestions.length) return;
            
            const q = wizardQuestions[currentWizardQuestion];
            document.getElementById('wizardQuestion').textContent = q.question;
            
            const optionsContainer = document.getElementById('wizardOptions');
            optionsContainer.innerHTML = q.options.map((opt, idx) => `
                <button class="wizard-option ${wizardAnswers[q.id] === opt ? 'selected' : ''}" onclick="selectWizardOption('${q.id}', this, '${opt.replace(/'/g, "\\'")}')">
                    ${opt}
                </button>
            `).join('');
            
            // Update progress bar
            const progressBar = document.querySelector('.wizard-progress-bar');
            if (progressBar) {
                progressBar.style.width = `${((currentWizardQuestion + 1) / wizardQuestions.length) * 100}%`;
            }
            
            // Update question number
            const questionNum = document.querySelector('.wizard-question-number');
            if (questionNum) {
                questionNum.textContent = `Question ${currentWizardQuestion + 1} of ${wizardQuestions.length}`;
            }
            
            // Show/hide back button
            const backBtn = document.getElementById('wizardBackBtn');
            if (backBtn) {
                backBtn.style.visibility = currentWizardQuestion > 0 ? 'visible' : 'hidden';
            }
        }

        function selectWizardOption(questionId, element, answer) {
            wizardAnswers[questionId] = answer;
            
            // Highlight selected option
            document.querySelectorAll('.wizard-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            
            // Auto-advance after short delay
            setTimeout(() => {
                if (currentWizardQuestion < wizardQuestions.length - 1) {
                    currentWizardQuestion++;
                    renderWizardQuestion();
                } else {
                    // All questions answered, generate tasks
                    closeWizardModal();
                    generateAITasksWithContext();
                }
            }, 300);
        }

        function wizardBack() {
            if (currentWizardQuestion > 0) {
                currentWizardQuestion--;
                renderWizardQuestion();
            }
        }

        function skipWizard() {
            closeWizardModal();
            generateAITasks();
        }

        function closeWizardModal() {
            const modal = document.getElementById('aiWizardModal');
            if (modal) modal.remove();
        }

        async function generateAITasksWithContext() {
            const title = document.getElementById('newProjectTitle').value.trim();
            const description = document.getElementById('newProjectDescription').value.trim();
            const endGoal = document.getElementById('newProjectEndGoal').value.trim();
            const generateHowTo = document.getElementById('generateHowToAuto')?.checked;
            
            // Build context from wizard answers
            let context = 'Based on the following clarifications:\n';
            wizardQuestions.forEach(q => {
                if (wizardAnswers[q.id]) {
                    context += `- ${q.question} → ${wizardAnswers[q.id]}\n`;
                }
            });
            
            const btn = document.querySelector('.ai-generate-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;"></span> Generating tasks...';
            btn.disabled = true;
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `You are helping plan a project for WSDisplay, a large format printing and sublimation company.

Project Title: "${title}"
${description ? `Description: "${description}"` : ''}
${endGoal ? `End Goal / Success Criteria: "${endGoal}"` : ''}

${context}

Based on this context, generate a list of 5-8 practical, specific tasks needed to complete this project and achieve the end goal.
${endGoal ? `\nIMPORTANT: Every task should directly contribute to achieving this end goal: "${endGoal}". Make sure the tasks, when completed, will lead to this outcome.` : ''}

Use the clarifications provided to make tasks as relevant and specific as possible.

Return ONLY a JSON array of task names, nothing else. Example format:
["Task 1", "Task 2", "Task 3"]

Make tasks specific, actionable, and tailored to achieving the stated goal.`
                        }]
                    })
                });

                const data = await response.json();
                if (data.error) {
                    showToast('Error: ' + data.error.message, true);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                const content = data.content[0].text.trim();
                const match = content.match(/\[[\s\S]*\]/);
                if (match) {
                    const tasks = JSON.parse(match[0]);
                    tasks.forEach(taskName => {
                        if (taskName && typeof taskName === 'string') {
                            newProjectTasks.push({ name: taskName.trim(), owner: 'Unassigned', hasHowTo: false });
                        }
                    });
                    renderNewProjectTasks();
                    showToast(`✅ Generated ${tasks.length} tasks!`);
                    
                    // Auto-generate How To if checkbox is checked
                    if (generateHowTo && newProjectTasks.length > 0) {
                        await generateHowTosForAllTasks(btn, title);
                    } else {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } else {
                    showToast('Could not parse AI response', true);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (err) {
                showToast('Failed to connect to AI: ' + err.message, true);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function generateHowTosForAllTasks(btn, projectTitle) {
            const total = newProjectTasks.length;
            const endGoal = document.getElementById('newProjectEndGoal')?.value.trim() || '';
            btn.innerHTML = `<span class="loading-spinner" style="width:16px;height:16px;"></span> Generating ${total} How To's...`;
            
            // Generate all How To's in parallel for speed
            const promises = newProjectTasks.map(async (task, index) => {
                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "claude-haiku-4-5-20250514",
                            max_tokens: 800,
                            messages: [{
                                role: "user",
                                content: `Task: "${task.name}" for project "${projectTitle}" at WSDisplay (printing company).
${endGoal ? `Project End Goal: "${endGoal}"` : ''}

Give 4-5 brief steps, 2 tips, time estimate. Be concise.${endGoal ? ' Ensure steps help achieve the end goal.' : ''}`
                            }]
                        })
                    });

                    if (!response.ok) return { index, success: false };

                    const data = await response.json();
                    if (data.error || !data.content?.[0]) return { index, success: false };
                    
                    return { index, success: true, content: data.content[0].text };
                } catch (err) {
                    return { index, success: false };
                }
            });

            const results = await Promise.all(promises);
            
            let generated = 0;
            let failed = 0;
            
            results.forEach(result => {
                if (result.success) {
                    newProjectTasks[result.index].hasHowTo = true;
                    newProjectTasks[result.index].howToContent = result.content;
                    generated++;
                } else {
                    failed++;
                }
            });
            
            renderNewProjectTasks();
            btn.innerHTML = '🤖 Generate Tasks with AI';
            btn.disabled = false;
            
            if (failed > 0 && generated === 0) {
                showToast(`❌ Failed to generate How To instructions`, true);
            } else if (failed > 0) {
                showToast(`✅ Generated ${generated} How To's (${failed} failed)`);
            } else {
                showToast(`✅ Generated ${generated} How To's!`);
            }
        }

        async function generateAITasks() {
            const title = document.getElementById('newProjectTitle').value.trim();
            const description = document.getElementById('newProjectDescription').value.trim();
            const endGoal = document.getElementById('newProjectEndGoal').value.trim();
            const generateHowTo = document.getElementById('generateHowToAuto')?.checked;
            
            if (!title) {
                showToast('Please enter a project title first', true);
                document.getElementById('newProjectTitle').focus();
                return;
            }
            
            const btn = document.querySelector('.ai-generate-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;"></span> Generating tasks...';
            btn.disabled = true;
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `You are helping plan a project for WSDisplay, a large format printing and sublimation company.

Project Title: "${title}"
${description ? `Description: "${description}"` : ''}
${endGoal ? `End Goal / Success Criteria: "${endGoal}"` : ''}

Generate a list of 5-8 practical tasks needed to complete this project.
${endGoal ? `\nIMPORTANT: Every task should directly contribute to achieving this end goal: "${endGoal}". Make sure the tasks, when completed, will lead to this outcome.` : ''}

Return ONLY a JSON array of task names, nothing else. Example format:
["Task 1", "Task 2", "Task 3"]

Make tasks specific, actionable, and goal-oriented.`
                        }]
                    })
                });

                const data = await response.json();
                if (data.error) {
                    showToast('Error: ' + data.error.message, true);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                const content = data.content[0].text.trim();
                const match = content.match(/\[[\s\S]*\]/);
                if (match) {
                    const tasks = JSON.parse(match[0]);
                    tasks.forEach(taskName => {
                        if (taskName && typeof taskName === 'string') {
                            newProjectTasks.push({ name: taskName.trim(), owner: 'Unassigned', hasHowTo: false });
                        }
                    });
                    renderNewProjectTasks();
                    showToast(`✅ Generated ${tasks.length} tasks!`);
                    
                    // Auto-generate How To if checkbox is checked
                    if (generateHowTo && newProjectTasks.length > 0) {
                        await generateHowTosForAllTasks(btn, title);
                    } else {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } else {
                    showToast('Could not parse AI response', true);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (err) {
                showToast('Failed to connect to AI: ' + err.message, true);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function generateAllHowTosForNewProject() {
            if (newProjectTasks.length === 0) {
                showToast('Add some tasks first', true);
                return;
            }
            
            const title = document.getElementById('newProjectTitle').value.trim() || 'New Project';
            const endGoal = document.getElementById('newProjectEndGoal')?.value.trim() || '';
            const btn = document.getElementById('generateHowToBtn');
            
            const tasksToGenerate = newProjectTasks.filter(t => !t.hasHowTo);
            
            if (tasksToGenerate.length === 0) {
                showToast('All tasks already have How To instructions', true);
                return;
            }
            
            btn.innerHTML = `<span class="loading-spinner" style="width:16px;height:16px;"></span> Generating ${tasksToGenerate.length} How To's...`;
            btn.disabled = true;
            
            // Generate all in parallel for speed
            const promises = tasksToGenerate.map(async (task) => {
                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "claude-haiku-4-5-20250514",
                            max_tokens: 800,
                            messages: [{
                                role: "user",
                                content: `Task: "${task.name}" for project "${title}" at WSDisplay (printing company).
${endGoal ? `Project End Goal: "${endGoal}"` : ''}

Give 4-5 brief steps, 2 tips, time estimate. Be concise.${endGoal ? ' Ensure steps help achieve the end goal.' : ''}`
                            }]
                        })
                    });

                    if (!response.ok) return { task, success: false };
                    
                    const data = await response.json();
                    if (data.error || !data.content?.[0]) return { task, success: false };
                    
                    return { task, success: true, content: data.content[0].text };
                } catch (err) {
                    return { task, success: false };
                }
            });

            const results = await Promise.all(promises);
            
            let generated = 0;
            let failed = 0;
            
            results.forEach(result => {
                if (result.success) {
                    result.task.hasHowTo = true;
                    result.task.howToContent = result.content;
                    generated++;
                } else {
                    failed++;
                }
            });
            
            renderNewProjectTasks();
            btn.innerHTML = '🤖 Generate How To for All Tasks';
            btn.disabled = false;
            
            if (failed > 0 && generated === 0) {
                showToast(`❌ Failed to generate How To instructions`, true);
            } else if (failed > 0) {
                showToast(`✅ Generated ${generated} How To's (${failed} failed)`);
            } else {
                showToast(`✅ Generated ${generated} How To's!`);
            }
        }

        function closeAddProjectModal() {
            const modal = document.getElementById('addProjectModal');
            if (modal) modal.classList.remove('active');
            newProjectTasks = [];
            chatHistory = [];
        }

        function createProject() {
            const title = document.getElementById('newProjectTitle').value.trim();
            const description = document.getElementById('newProjectDescription').value.trim();
            const endGoal = document.getElementById('newProjectEndGoal').value.trim();
            const owner = document.getElementById('newProjectOwner').value;
            const deptId = document.getElementById('newProjectDept').value;
            const priority = document.getElementById('newProjectPriority').value;
            const dueDate = document.getElementById('newProjectDueDate').value;
            const phaseIdx = 0; // Default to first phase
            
            if (!title) {
                showToast('Please enter a project title', true);
                return;
            }
            
            // Generate unique ID
            const projectId = 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Use the tasks from the list
            const tasks = newProjectTasks.map(t => ({
                name: t.name,
                owner: owner || 'Unassigned'
            }));
            
            // Save any pre-generated How To content
            newProjectTasks.forEach(task => {
                if (task.hasHowTo && task.howToContent) {
                    const taskId = `${projectId}_${task.name}`;
                    taskHowTos[taskId] = {
                        content: task.howToContent,
                        generatedAt: new Date().toISOString(),
                        projectTitle: title
                    };
                }
            });
            localStorage.setItem('taskHowTos', JSON.stringify(taskHowTos));
            
            // Create project object
            const newProject = {
                id: projectId,
                title: title,
                description: description || 'No description',
                endGoal: endGoal || '',
                priority: priority,
                owner: owner || 'Unassigned',
                tasks: tasks
            };
            
            // Add to masterplan
            masterplan.phases[phaseIdx].projects.push(newProject);
            
            // Save owner if set
            if (owner) {
                projectOwners[projectId] = owner;
                localStorage.setItem('projectOwners', JSON.stringify(projectOwners));
            }
            
            // Save end goal separately for quick access
            if (endGoal) {
                let projectEndGoals = JSON.parse(localStorage.getItem('projectEndGoals') || '{}');
                projectEndGoals[projectId] = endGoal;
                localStorage.setItem('projectEndGoals', JSON.stringify(projectEndGoals));
            }
            
            // Save department if set
            if (deptId) {
                projectDepartments[projectId] = deptId;
                localStorage.setItem('projectDepartments', JSON.stringify(projectDepartments));
                
                // Auto-assign department to all tasks
                tasks.forEach(task => {
                    const taskId = `${projectId}_${task.name}`;
                    taskDepartments[taskId] = deptId;
                });
                localStorage.setItem('taskDepartments', JSON.stringify(taskDepartments));
            }
            
            // Save due date if set
            if (dueDate) {
                projectDueDates[projectId] = dueDate;
                localStorage.setItem('projectDueDates', JSON.stringify(projectDueDates));
            }
            
            // Save custom projects to localStorage
            let customProjects = JSON.parse(localStorage.getItem('customProjects') || '{}');
            if (!customProjects[phaseIdx]) customProjects[phaseIdx] = [];
            customProjects[phaseIdx].push(newProject);
            localStorage.setItem('customProjects', JSON.stringify(customProjects));
            
            closeAddProjectModal();
            renderPhases();
            renderDepartmentFilters();
            updateStats();
            showToast(`✅ Created project: ${title}`);
            
            // Open the new project
            setTimeout(() => {
                openProjectModal(projectId);
            }, 300);
        }

        // Load custom projects on init
        function loadCustomProjects() {
            const customProjects = JSON.parse(localStorage.getItem('customProjects') || '{}');
            Object.keys(customProjects).forEach(phaseIdx => {
                const idx = parseInt(phaseIdx);
                if (masterplan.phases[idx]) {
                    customProjects[phaseIdx].forEach(proj => {
                        // Check if project already exists
                        if (!masterplan.phases[idx].projects.find(p => p.id === proj.id)) {
                            masterplan.phases[idx].projects.push(proj);
                        }
                    });
                }
            });
        }
        
        // Call on load
        loadCustomProjects();
    </script>

    <style>
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</body>
</html>
